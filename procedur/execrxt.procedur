$$$$ EXECRXT
* EXECRXT   PROCEDUR  MAGN      18/06/08    21:15:07     9840
'DEBPROC' EXECRXT nbit*'ENTIER ' rxt*'TABLE   ' KENC/'MOT';
*----------------------------------------------------------
*---- Suivi des modifications
*--- 20/09/99 : ES prise en compte des incondensables
*               dans la procédure CONDENS
*--- 18/05/00 : FP prises en comptes de la condensation en masse par
*               l'ajout d'une nouvelle équation sur la masse volumique
*               de liquide en suspension. Les équations sur rhovap et
*               sur T sont également complétées par l'introduction
*               d'une nouveau terme source. La détermination des
*               termes sources est réalisée dans une procedure appelée
*               CONDENSM.
*--- 04/11/05 : Ajout d'un choix de formulation pour le flux condensé
*               (Chilton-Colburn) dans la procédure CONDENS
*----------------------------------------------------------

*==============================================================
Si(Exist KENC)                                              ;
MKENC=KENC                                                  ;
Sinon                                                       ;
MKENC='????'                                                ;
Finsi                                                       ;
WWW=chai'WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW';
WWW=chai WWW 'WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW';

mess                                                     ;
mess WWW                                                    ;
mess '       DEBUT PROCEDURE EXECRXT : CHOIX DES PRINCIPAUX PARAMETRES';
mess WWW                                                    ;
*-----------------------------------------------------------------------
* Liste des entrées nécessaires                             ;
*-----------------------------------------------------------------------
* Géométrie

  listand = MOTS                                            ;
  listchp = MOTS                                            ;
  listentr= table                                           ;
  listentr.'VERSION'  =''                                   ;
  listentr.'vtf'      =''                                   ;
  listentr.'TF0'      =''                                   ;
  listentr.'PT0'      =''                                   ;

  listentr.'XFIMP'    =''                                   ;

  listentr.'THERMP'   =''                                   ;
  listentr.'PAROIS'   =''                                   ;
  listentr.'THERCO'   =''                                   ;
  listentr.'vtp'      =''                                   ;
  listentr.'ROCP'     =''                                   ;
  listentr.'LAMBDA'   =''                                   ;
  listentr.'Tp0'      =''                                   ;
  listentr.'ECHAN'    =''                                   ;

  listentr.'ECHEXT'   =''                                   ;
  listentr.'parext'   =''                                   ;
  listentr.'HEXT'     =''                                   ;
  listentr.'TPEXT'    =''                                   ;

  listentr.'TIMP'     =''                                   ;
  listentr.'TIMP1'    =''                                   ;
  listentr.'TIMP2'    =''                                   ;
  listentr.'TIMP3'    =''                                   ;

  listentr.'ECHANP'   =''                                   ;

  listentr.'Sorties'  =''                                   ;
  listentr.'Breches'  =''                                   ;
  listentr.'breche'   =''                                   ;
  listentr.'breche2'  =''                                   ;
  listentr.'breche3'  =''                                   ;
  listentr.'sortie'   =''                                   ;
  listentr.'axe'      =''                                   ;
  listentr.'epsi'     =''                                   ;
  listentr.'pi'       =''                                   ;

* Table utilisée pour la définition de recombineurs
  listentr.'RECOMB'   =''                                   ;

* Table de travail rajoutées par la procédure
  listentr.'REINIT'   =''                                   ;
  listentr.'TIC'      =''                                   ;
  listentr.'GEO'      =''                                   ;
  listentr.'TBT'      =''                                   ;

* paramètres numériques / algorithmes
  listentr.'DISCR'    =''                                   ;
  listentr.'KPRE'     =''                                   ;
  listentr.'MAXELPRE' =''                                   ;
  listentr.'STAB'     =''                                   ;
  listentr.'ALGO'     =''                                   ;

* paramètres de fonctionnement
  listentr.'CATHARE2' =''                                   ;
  listentr.'DT0'      =''                                   ;
  listentr.'PERSO'    =''                                   ;
  listentr.'TABPERSO' =''                                ;
  listentr.'GRAPH'    =''                                   ;
  listentr.'RENU'     =''                                   ;
  listentr.'TYPINV'   =''                                   ;
  listentr.'IMPR'     =''                                   ;
  listentr.'FRPREC'   =''                                   ;
  listentr.'PPDT'     =''                                   ;
  listentr.'RESIDU'   =''                                   ;
  listentr.'NTIT'     =''                                   ;
  listentr.'TCPT'     =''                                   ;
  listentr.'TKPR'     =''                                   ;
  listentr.'TRESOU'   =''                                   ;
  listentr.'IMPARA'   =''                                   ;
  listentr.'TRTF'     =''                                   ;
  listentr.'TRrvap'   =''                                   ;
  listentr.'TRrhe'    =''                                   ;
  listentr.'TRrh2'    =''                                   ;
  listentr.'TRro2'    =''                                   ;
  listentr.'TRrn2'    =''                                   ;
  listentr.'TRrco2'   =''                                   ;
  listentr.'TRrair'   =''                                   ;
  listentr.'TRrco'    =''                                   ;


** Modèles physiques
* Constituant (air par défaut ) vapeur/incondensables
  listentr.'LOI-ETAT' =''                                   ;
  listentr.'VAPEUR'   =''                                   ;
  listentr.'YBRO'     =''                                   ;
  listentr.'V1alfa'   =''                                   ;
  listentr.'TAUXcm'   =''                                   ;
  listentr.'HE'       =''                                   ;
  listentr.'H2'       =''                                   ;
  listentr.'O2'       =''                                   ;
  listentr.'N2'       =''                                   ;
  listentr.'CO'       =''                                   ;
  listentr.'CO2'      =''                                   ;
  listentr.'AIR'      =''                                   ;

* Modèles de turbulence
  listentr.'MODTURB'  =''                                   ;
  listentr.'FPAROI'   =''                                   ;

* Formulation pour le modèle de condensation
  listentr.'MODCOND'     =''                                ;

  idim = vale 'DIME'                                        ;
  DIM3D=FAUX                                                ;
  Si(EGA idim 3)                                            ;
  DIM3D=VRAI                                                ;
  Finsi                                                     ;

*-----------------------------------------------------------------------


 REINIT= (NON ('EXIST' rxt 'TBT'))                          ;
'SI' ('EXIST' rxt 'REINIT')                                 ;
 vertytab rxt 'REINIT' 'LOGIQUE'                            ;
 REINIT=rxt.'REINIT'                                        ;
'FINSI'                                                     ;

 'SI'(('EXIST' rxt 'TBT') et (NON REINIT))                  ;
  vertytab rxt 'TBT' 'TABLE   '                             ;
  vertytab rxt 'GEO' 'TABLE   '                             ;
  TPREPA=FAUX                                               ;
  TBT=rxt.'TBT'                                             ;
  GEO=rxt.'GEO'                                             ;
 'SINON'                                                    ;
  TPREPA=VRAI                                               ;
  TBT='TABLE'                                               ;
  GEO='TABLE'                                               ;
  rxt.'GEO'=GEO                                             ;
 'FINSI'                                                    ;

*---------------------------------------------------------
* epsi = tolérance pour les maillages (OPERATEUR ELIM)
  GEO.'epsi'= 1.e-4                                      ;
'SI' ('EXIST' rxt 'epsi')                                ;
  vertytab rxt 'epsi' 'FLOTTANT'                         ;
  GEO.'epsi'= rxt.'epsi'                                 ;
'FINSI'                                                  ;
*---------------------------------------------------------

*CREATION GEO MAILLAGE

'SI' ('EXIST' rxt 'TIC')                                   ;
 vertytab rxt 'TIC' 'TABLE   '                             ;
 vertytab (rxt.'TIC') 'LTPS' 'LISTREEL'                    ;
 tic=rxt.'TIC'                                             ;
'SINON'                                                    ;
 tic= 'TABLE' 'INCO'                                       ;
 rxt.'TIC'=tic                                             ;
 tic.'LTPS'  = 'PROG' 0.0                                  ;
'FINSI'                                                    ;

 ndl   = 'DIME' (tic.'LTPS')                               ;
 Tps='EXTR' (tic.'LTPS') ndl                               ;
 MESS ' Le calcul demarre a partir du temps ' Tps          ;

* Initialisation
* Liste des Gaz qui peuvent etre calcule
LINCOND=MOTS 'N2' 'H2' 'HE' 'O2' 'CO' 'CO2' 'VAPE'       ;

Si (non(exist tic 'Lg0D'))                               ;
tic.'Lg0D'= Mots                                         ;
tic.'Li0D'= Prog                                         ;
Finsi                                                    ;

*-------------------------------------------------------------
* On vérifie que l'utilisateur a bien crée un volume FLUIDE
*                        Donnée obligatoire
*-------------------------------------------------------------

     vertytab rxt 'TF0' 'FLOTTANT'                      ;
     vertytab rxt 'PT0' 'FLOTTANT'                      ;

* Vérifie quelques impératifs sur le maillage
     vertytab rxt 'vtf' 'MAILLAGE'                      ;
 vtf         = rxt.'vtf'                                ;
 vertytab 0 GEO vtf                                     ;

     GEO.'Mvtf'=chan 'QUAF' rxt.'vtf'                   ;
*-------------------------------------------------------------
* CATHARE2 couplage avec CATHARE2 : donnée non obligatoire
*-------------------------------------------------------------

TBT.'CATHARE2' = FAUX                                    ;
'SI' (exist rxt 'CATHARE2')                              ;
 vertytab rxt 'CATHARE2' 'LOGIQUE'                       ;
TBT.'CATHARE2'= rxt.'CATHARE2'                           ;
'FINSI'                                                  ;

*-------------------------------------------------------------
* DT0 Le pas de temps  : Donnée obligatoire
*-------------------------------------------------------------

 vertytab rxt 'DT0' 'FLOTTANT'                           ;
 tic.'DT'=rxt.'DT0'                                      ;

*----------------------------------------------------------
* VERSION= 'MOT' indiquant le niveau de la version
* Niveaux disponiblex V0 (standard) et V1
*----------------------------------------------------------

TBT.'VERSION' = 0                                        ;
'SI' (exist rxt 'VERSION')                               ;
 lxt = mots 'V0' 'V1'                                    ;
 tbvs= table; tbvs.'V0'=0; tbvs.'V1'=1;                  ;
 vertytab lxt (rxt.'VERSION') 'MOT'                      ;
TBT.'VERSION'= tbvs.(rxt.'VERSION')                      ;
 'SI' (TBT.'VERSION' > 0)                                ;
  TBT.'CONDMAS' = VRAI                                   ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EGA' TBT.'VERSION' 1)                             ;
  TBT.'YBRO' = 1.e-4                                     ;
  TBT.'V1alfa' = 0.8                                     ;
  TBT.'TAUXcm' = 1.                                      ;
 'SI' (exist rxt 'YBRO')                                 ;
  vertytab rxt 'YBRO' 'FLOTTANT'                         ;
  TBT.'YBRO' = rxt.'YBRO'                                ;
 'FINSI'                                                 ;
 'SI' (exist rxt 'V1alfa')                               ;
  vertytab rxt 'V1alfa' 'FLOTTANT'                       ;
  TBT.'V1alfa' = rxt.'V1alfa'                            ;
 'FINSI'                                                 ;
 'SI' (exist rxt 'TAUXcm')                               ;
  vertytab rxt 'TAUXcm' 'FLOTTANT'                       ;
  TBT.'TAUXcm' = rxt.'TAUXcm'                            ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

*----------------------------------------------------------
* LOIDETAT = MOT Précise le type de la loi d'état
*----------------------------------------------------------

TBT.'LOI-ETAT' = 'GP'                                    ;
'SI' (exist rxt 'LOI-ETAT')                              ;
 lxt = mots 'GP' 'GR'                                    ;
 vertytab lxt (rxt.'LOI-ETAT') 'MOT'                     ;
TBT.'LOI-ETAT'= rxt.'LOI-ETAT'                           ;

   Si ('EGA' TBT.'VERSION' 0)                                     ;
   Si ('EGA' TBT.'LOI-ETAT' 'GR')                                 ;
 Mess                                                             ;
 Mess '*********************************************************' ;
 Mess ' ERREUR   ERREUR   ERREUR   ERREUR   ERREUR   ERREUR     ' ;
 Mess '                                                         ' ;
 Mess '                                                         ' ;
 Mess ' Dans la version V0 la loi d état est obligatoirement une' ;
 Mess ' loi de gaz parfait '                                      ;
 ERREUR 21                                                        ;
 Mess '*********************************************************' ;
 Mess                                                             ;
 QUITTER EXECRXT                                                  ;
   finsi                                                          ;
   finsi                                                          ;
'FINSI'                                                           ;

*----------------------------------------------------------
* GRAPH = Logique permettant les dessins
*----------------------------------------------------------

TBT.'GRAPH' = FAUX                                       ;
'SI' (exist rxt 'GRAPH')                                 ;
 vertytab rxt 'GRAPH' 'LOGIQUE '                         ;
TBT.'GRAPH'= rxt.'GRAPH'                                 ;
'FINSI'                                                  ;

*---------------------------------------------------------
* STAB = coefficient de Stabilisation pour les MACRO
*        pour l'algorithme de Projection
*---------------------------------------------------------

TBT.'STAB' = 1.                                           ;
'SI' ('EXIST' rxt 'STAB')                                 ;
 vertytab rxt 'STAB' 'FLOTTANT'                           ;
TBT.'STAB' = rxt.'STAB'                                   ;
listand=listand et (MOTS 'STAB')                          ;
'FINSI'                                                   ;

*---------------------------------------------------------
* DETMAT Logique indiquant qu'on détruit toutes les
*        matrices à la fin du calcul.
*---------------------------------------------------------

TBT.'DETMAT' = VRAI                                       ;
'SI' ('EXIST' rxt 'DETMAT')                               ;
 vertytab rxt 'DETMAT' 'LOGIQUE'                          ;
 listentr.'DETMAT'   =''                                  ;
TBT.'DETMAT' = rxt.'DETMAT'                               ;
'FINSI'                                                   ;

*---------------------------------------------------------
* CORTEMP Logique indiquant qu'on supprime ou non le controle
*         du bilan d'énergie.
*---------------------------------------------------------

TBT.'CORTEMP' = VRAI                                      ;
'SI' ('EXIST' rxt 'CORTEMP')                              ;
 vertytab rxt 'CORTEMP' 'LOGIQUE'                         ;
 listentr.'CORTEMP'  =''                                  ;
TBT.'CORTEMP' = rxt.'CORTEMP'                             ;
listand=listand et (MOTS 'CORTEMP')                       ;
'FINSI'                                                   ;

*---------------------------------------------------------
* RENU = Type de renumérotation pour les méthodes d'inversion
*        RIEN SLOA
*---------------------------------------------------------

TBT.'RENU' = 'SLOA'                                       ;
'SI' ('EXIST' rxt 'RENU')                                 ;
 vertytab rxt 'RENU' 'MOT'                                ;
 lxt=mots 'RIEN' 'SLOA' 'GIBR' 'GIBA'                     ;
 vertytab lxt (rxt.'RENU') 'MOT'                          ;
TBT.'RENU' = rxt.'RENU'                                   ;
listand=listand et (MOTS 'RENU')                          ;
'FINSI'                                                   ;

*---------------------------------------------------------
* TYPINV Type d'inversion
*        RIEN BICG sinon voir notice KRES
* RESIDU pour les méthodes itératives (défaut 1.e-20)
*---------------------------------------------------------

TBT.'TYPINV'= 3                                           ;
'SI' ('EXIST' rxt 'TYPINV')                               ;
 vertytab rxt 'TYPINV' 'ENTIER'                           ;
TBT.'TYPINV' = rxt.'TYPINV'                               ;
listand=listand et (MOTS 'TYPINV')                        ;
'FINSI'                                                   ;

TBT.'RESIDU'= 1.E-20                                      ;
'SI' ('EXIST' rxt 'RESIDU')                               ;
 vertytab rxt 'RESIDU' 'FLOTTANT'                         ;
TBT.'RESIDU' = rxt.'RESIDU'                               ;
listand=listand et (MOTS 'RESIDU')                        ;
'FINSI'                                                   ;

TBT.'NTIT'= 800                                           ;
'SI' ('EXIST' rxt 'NTIT')                                 ;
 vertytab rxt 'NTIT' 'ENTIER'                             ;
TBT.'NTIT' = rxt.'NTIT'                                   ;
listand=listand et (MOTS 'NTIT')                          ;
'FINSI'                                                   ;

TBT.'TCPT'= FAUX                                          ;
'SI' ('EXIST' rxt 'TCPT')                                 ;
 vertytab rxt 'TCPT' 'LOGIQUE'                            ;
TBT.'TCPT' = rxt.'TCPT'                                   ;
listand=listand et (MOTS 'TCPT')                          ;
'FINSI'                                                   ;

TBT.'TKPR'= FAUX                                          ;
'SI' ('EXIST' rxt 'TKPR')                                 ;
 vertytab rxt 'TKPR' 'LOGIQUE'                            ;
TBT.'TKPR' = rxt.'TKPR'                                   ;
listand=listand et (MOTS 'TKPR')                          ;
'FINSI'                                                   ;

TBT.'TRESOU'= FAUX                                        ;
'SI' ('EXIST' rxt 'TRESOU')                               ;
 vertytab rxt 'TRESOU' 'LOGIQUE'                          ;
TBT.'TRESOU' = rxt.'TRESOU'                               ;
listand=listand et (MOTS 'TRESOU')                        ;
'FINSI'                                                   ;

TBT.'IMPARA'= FAUX                                        ;
'SI' ('EXIST' rxt 'IMPARA')                               ;
 vertytab rxt 'IMPARA' 'LOGIQUE'                          ;
TBT.'IMPARA' = rxt.'IMPARA'                               ;
listand=listand et (MOTS 'IMPARA')                        ;
'FINSI'                                                   ;

TBT.'TRTF'  = TBT.'TKPR'                                  ;
'SI' ('EXIST' rxt 'TRTF')                                 ;
 vertytab rxt 'TRTF' 'LOGIQUE'                            ;
TBT.'TRTF' = rxt.'TRTF'                                   ;
listand=listand et (MOTS 'TRTF')                          ;
'FINSI'                                                   ;

TBT.'TRrvap'=TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrvap')                               ;
 vertytab rxt 'TRrvap' 'LOGIQUE'                          ;
TBT.'TRrvap' = rxt.'TRrvap'                               ;
listand=listand et (MOTS 'TRrvap')                        ;
'FINSI'                                                   ;

TBT.'TRrhe' =TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrhe')                                ;
 vertytab rxt 'TRrhe'  'LOGIQUE'                          ;
TBT.'TRrhe'  = rxt.'TRrhe'                                ;
listand=listand et (MOTS 'TRrhe')                         ;
'FINSI'                                                   ;

TBT.'TRrh2' =TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrh2')                                ;
 vertytab rxt 'TRrh2'  'LOGIQUE'                          ;
TBT.'TRrh2'  = rxt.'TRrh2'                                ;
listand=listand et (MOTS 'TRrh2')                         ;
'FINSI'                                                   ;

TBT.'TRro2' =TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRro2')                                ;
 vertytab rxt 'TRro2'  'LOGIQUE'                          ;
TBT.'TRro2'  = rxt.'TRro2'                                ;
listand=listand et (MOTS 'TRro2')                         ;
'FINSI'                                                   ;

TBT.'TRrn2' =TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrn2')                                ;
 vertytab rxt 'TRrn2'  'LOGIQUE'                          ;
TBT.'TRrn2'  = rxt.'TRrn2'                                ;
listand=listand et (MOTS 'TRrn2')                         ;
'FINSI'                                                   ;

TBT.'TRrco' =TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrco')                                ;
 vertytab rxt 'TRrco'  'LOGIQUE'                          ;
TBT.'TRrco'  = rxt.'TRrco'                                ;
listand=listand et (MOTS 'TRrco')                         ;
'FINSI'                                                   ;

TBT.'TRrco2'=TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrco2')                               ;
 vertytab rxt 'TRrco2'  'LOGIQUE'                         ;
TBT.'TRrco2'  = rxt.'TRrco2'                              ;
listand=listand et (MOTS 'TRrco2')                        ;
'FINSI'                                                   ;

TBT.'TRrair'=TBT.'TKPR'                                   ;
'SI' ('EXIST' rxt 'TRrair')                               ;
 vertytab rxt 'TRrair'  'LOGIQUE'                         ;
TBT.'TRrair'  = rxt.'TRrair'                              ;
listand=listand et (MOTS 'TRrair')                        ;
'FINSI'                                                   ;

TBT.'TRTOUT' = TBT.'TRTF' ou TBT.'TRrvap' ou TBT.'TRrhe' ou
TBT.'TRrh2' ou TBT.'TRro2' ou TBT.'TRrn2' ou TBT.'TRrco' ou
TBT.'TRrco2' ou TBT.'TRrair'                              ;

*---------------------------------------------------------
* PPDT  formulation designé petits/grand  pas de temps
*                   conservative ou non conservative
*---------------------------------------------------------

TBT.'PPDT'= FAUX                                          ;
'SI' ('EXIST' rxt 'PPDT')                                 ;
 vertytab rxt 'PPDT' 'LOGIQUE'                            ;
TBT.'PPDT' = rxt.'PPDT'                                   ;
listand=listand et (MOTS 'PPDT')                          ;
'FINSI'                                                   ;

Si TBT.'PPDT'                                             ;
 TBT.'FCONS'= 'CONS2'                                     ;
Sinon                                                     ;
 TBT.'FCONS'= 'NOCONS'                                    ;
Finsi                                                     ;
*--------------------------------------------------------
* ALGO = choix de l'algorithme implicite / explicite
*   Les choix possibles sont :
*     IMPL  = semi implicite
*     EFM1  = semi explicite
*--------------------------------------------------------

TBT.'ALGO' ='IMPL'                                        ;
TBT.'SPGNU'='CHAI' sommet                                 ;
TBT.'FEF'  ='EF'                                          ;
TBT.'FIMPL'='IMPL'                                        ;
'SI' ('EXIST' rxt 'ALGO')                                 ;
 vertytab rxt 'ALGO' 'MOT'                                ;
 lxt=mots 'IMPL' 'EFM1'                                   ;
 vertytab lxt (rxt.'ALGO') 'MOT'                          ;
TBT.'ALGO' = rxt.'ALGO'                                   ;
 Si (EGA TBT.'ALGO' 'EFM1')                               ;
  TBT.'SPGNU'='CHAI' centre                               ;
  TBT.'FEF'  ='EFM1'                                      ;
  TBT.'FIMPL'='EXPL'                                      ;
 Finsi                                                    ;
listand=listand et (MOTS 'ALGO')                          ;
'FINSI'                                                   ;
'MESS' '==> Algorithme choisi ' TBT.'ALGO'                ;

*--------------------------------------------------------
* DISCR = choix de la discrétisation
*   Les dicrétisations possibles sont :
*     LINE  = éléments linéaires
*     MACRO = éléments MACRO (par DEFAUT)
*     QUAF  = éléments quadratiques fluide
*--------------------------------------------------------

TBT.'discr'='MACRO'                                       ;
'SI' ('EXIST' rxt 'DISCR')                                ;
 vertytab rxt 'DISCR' 'MOT'                               ;
 lxt=mots 'MACRO' 'LINE' 'QUAF'                           ;
 vertytab lxt (rxt.'DISCR') 'MOT'                         ;
TBT.'discr' = rxt.'DISCR'                                 ;
listand=listand et (MOTS 'DISCR')                         ;
'FINSI'                                                   ;
'MESS' '==> Discrétisation choisie pour la vitesse ' TBT.'discr'  ;
TBT.'discrH'=TBT.'discr'                                  ;
Si ((Ega TBT.'discr' 'QUAF') ET (EGA (VALE DIME) 3))      ;
TBT.'discrH'='MACRO'                                      ;
Finsi                                                     ;

*---------------------------------------------------------
* KPRE = position de l'inconnue de pression
*  possibilités : CENTRE avec algorithme de projection
*                 CENTREP1 avec algorithme IMPLICIT
*---------------------------------------------------------

TBT.'KPRE'='CENTRE'                                       ;
'SI' ('EXIST' rxt 'KPRE')                                 ;
 vertytab rxt 'KPRE' 'MOT'                                ;
 lxt=table; lxt.'CENTRE'=' '; lxt.'CENTREP1'=' '          ;
            lxt.'MSOMMET'=' '                             ;
 vertytab lxt (rxt.'KPRE') 'MOT'                          ;
 TBT.'KPRE' = rxt.'KPRE'                                  ;
listand=listand et (MOTS 'KPRE')                          ;
'FINSI'                                                   ;
'MESS' '==> Discrétisation choisie pour la pression ' TBT.'KPRE';

*---------------------------------------------------------
* MAXELPRE = nombre maximum d'éléments pour lequel on utilise
* une méthode directe (Cholesky) pour inverser la matrice.
* Par défaut 150000
*---------------------------------------------------------

TBT.'MAXELPRE'= 150000                                     ;
'SI' ('EXIST' rxt 'MAXELPRE')                             ;
 vertytab rxt 'MAXELPRE' 'ENTIER'                         ;
 TBT.'MAXELPRE' = rxt.'MAXELPRE'                          ;
listand=listand et (MOTS 'MAXELPRE')                      ;
'FINSI'                                                   ;
'MESS' '==> Résolution directe pour la pression jusqu à '
 TBT.'MAXELPRE' ' éléments';

*---------------------------------------------------------
* Definition des grandeurs Physiques :
* Rgi = constante des gaz pour chaque especes J/Kg/K
*
* Modif FP 26/06/00
Rabs = 6.022*1.38066                                  ;
TBT.'Rabs'  = Rabs                                    ;
TBT.'Rgh2'  = Rabs/2.E-3  ; TBT.'Mkh2'  = 2.016E-3    ;
TBT.'Rghe'  = Rabs/4.E-3  ; TBT.'Mkhe'  = 4.003E-3    ;
TBT.'Rgo2'  = Rabs/3.2E-2 ; TBT.'Mko2'  = 32.00E-3    ;
TBT.'Rgn2'  = Rabs/2.8E-2 ; TBT.'Mkn2'  = 28.02E-3    ;
TBT.'Rgco2' = Rabs/4.4E-2 ; TBT.'Mkco2' = 44.01E-3    ;
TBT.'Rgco'  = Rabs/2.8E-2 ; TBT.'Mkco'  = 28.01E-3    ;
TBT.'Rgvap' = Rabs/1.8E-2 ; TBT.'Mkvap' = 18.02E-3    ;
TBT.'Rgair' = 287.1       ; TBT.'Mkair' = 28.97E-3    ;
TBT.'Rgar'  = Rabs/4.E-2  ; TBT.'Mkar'  = 39.94E-3    ;
TBT.'Rgch4' = Rabs/16.E-3 ; TBT.'Mkch4' = 16.04E-3    ;
TBT.'lamair'= 2.580e-2    ;

TBT.'B0'    = -4512.70756 ; TBT.'B1'    = 4245585.9   ;
TBT.'B2'    = -1584624342.;

* Ancienne mouture
**TBT.'Rgh2'  = 4156.5                                     ;
**TBT.'Rghe'  = 2078.25                                    ;
**TBT.'Rgo2'  = 259.8                                      ;
**TBT.'Rgn2'  = 296.9                                      ;
**TBT.'Rgco2' = 188.9                                      ;
**TBT.'Rgco'  = 296.9                                      ;
**TBT.'Rgvap' = 461.513                                    ;
**TBT.'Rgair' = (0.8 '*' TBT.'Rgn2') '+' (0.2 '*' TBT.'Rgo2');
*--------------------------------------------------------
* Cpvap = Chaleur specifique a pression constante(J/Kg/K)
*         Hypothese de gaz parfait pour la vapeur d'eau
*
'SI' ('EXIST' rxt 'Cpvap')                               ;
 vertytab rxt 'Cpvap' 'FLOTTANT'                         ;
 Cpvap = rxt.'Cpvap'                                     ;
'SINON'                                                  ;
 Cpvap = 1700.                                           ;
'MESS' '==> Cpvap mis par defaut a 1700 J/kg/K        '  ;
'FINSI'                                                  ;
 TBT.'Cpvap'=Cpvap                                       ;
 TBT.'Cvvap'=TBT.'Cpvap' - TBT.'Rgvap'                   ;
*--------------------------------------------------------
* Lv = Chaleur Latente supposée constante (J/kg)
*
'SI' ('EXIST' rxt 'Lv')                                       ;
 vertytab rxt 'Lv' 'FLOTTANT'                                 ;
 Lv = rxt.'Lv'                                                ;
'SINON'                                                       ;
 Lv = 2.3E6                                                   ;
'MESS' '==> Chaleur latente Lv mise par defaut a 2.3E6 J/kg'  ;
'FINSI'                                                       ;
 TBT.'Lv'=Lv                                                  ;
*--------------------------------------------------------
* DB = coefficient de diffusion Brownienne
*
'SI' ('EXIST' rxt 'db')                                  ;
 vertytab rxt 'db' 'FLOTTANT'                            ;
 db = rxt.'db'                                           ;
'SINON'                                                  ;
 db = 1.000e-5                                           ;
'FINSI'                                                  ;
 TBT.'db'=db                                             ;
*----------------------------------------------------------

   TBT.'Taxe' = FAUX                                     ;
  Si (exist rxt 'axe')                                   ;
   vertytab rxt 'axe' 'MAILLAGE'                         ;
   GEO.'Maxe'=chan 'QUAF' rxt.'axe'                      ;
   ELIM GEO.'Mvtf' GEO.'Maxe' rxt.'epsi'                 ;
   TBT.'Taxe' = VRAI                                     ;
  Finsi                                                  ;

*----------------------------------------------------------
* SCENARIO = on verifie existence de la TABLE necessaire
*            pour faire un calcul avec EXECRXT
*            si il y a au moins une brèche

*---------------------------------------------------------
* Cas d'un nombre quelconque de Sorties
   TBT.'TTsortie' = FAUX                                 ;
  Si (exist rxt 'Sorties')                               ;

   vertytab rxt 'Sorties' 'TABLE'                        ;
   TBT.'TTsortie' = VRAI                                 ;
   NBR=dime rxt.'Sorties'                                ;
   mess ' Il y a ' NBR ' Sortie(s)'                      ;

   ibr=index (rxt.'Sorties')                             ;

   Repeter BBRS NBR                                      ;
   Sriches=rxt.'Sorties'.(ibr.&BBRS)                     ;
   mess ' Vérification Sortie ' (ibr.&BBRS)              ;

   vertytab Sriches 'Maillage' 'MAILLAGE'                ;
   vertytab Sriches 'scenario' 'TABLE   '                ;
   scn = Sriches.'scenario'                              ;
   Sriches.'Modinj'=mot 'A'                              ;
   Si(EXIST Sriches.'scenario' 'Modinj')                 ;
   Sriches.'Modinj'=Sriches.'scenario'.'Modinj'          ;
   Finsi                                                 ;
* Petites initialisations
   Sriches.'guj'   = Prog 0.                             ;
   Sriches.'Qj'    = Prog 0.                             ;
   Sriches.'Ksi'   = Prog 0.                             ;
   Sriches.'Hj'    = Prog 0.                             ;
   Sriches.'Ej'    = Prog 0.                             ;
   Sriches.'Ltbp1' = Prog 0.                             ;
   Sriches.'Qlj'   = Prog 0.                             ;
   Sriches.'Hlj'   = Prog 0.                             ;
   Sriches.'Tinj'  = Prog 0.                             ;
   FIN BBRS                                              ;
   TBT.'Sorties' = rxt.'Sorties'                         ;
  Finsi                                                  ;
*---------------------------------------------------------

*---------------------------------------------------------
* Cas d'un nombre quelconque de brèches
   TBT.'TTbreche' = FAUX                                 ;
  Si (exist rxt 'Breches')                               ;

   vertytab rxt 'Breches' 'TABLE'                        ;
   TBT.'TTbreche' = VRAI                                 ;
   NBR=dime rxt.'Breches'                                ;
   mess ' Il y a ' NBR ' Brèche(s)'                      ;

   ibr=index (rxt.'Breches')                             ;

   Repeter BBRS NBR                                      ;
   Briches=rxt.'Breches'.(ibr.&BBRS)                     ;
   mess ' Vérification Breche ' (ibr.&BBRS)              ;

   vertytab Briches 'diru' 'POINT   '                    ;
   vertytab Briches 'Maillage' 'MAILLAGE'                ;
   vertytab Briches 'scenario' 'TABLE   '                ;
   scn = Briches.'scenario'                              ;
   Briches.'Modinj'=mot 'A'                              ;
   Si(EXIST Briches.'scenario' 'Modinj')                 ;
   Briches.'Modinj'=Briches.'scenario'.'Modinj'          ;
   Finsi                                                 ;
* Petites initialisations
   Briches.'guj'   = Prog 0.                             ;
   Briches.'Qj'    = Prog 0.                             ;
   Briches.'Ksi'   = Prog 0.                             ;
   Briches.'Hj'    = Prog 0.                             ;
   Briches.'Ej'    = Prog 0.                             ;
   Briches.'Ltbp1' = Prog 0.                             ;
   Briches.'Qlj'   = Prog 0.                             ;
   Briches.'Hlj'   = Prog 0.                             ;
   Briches.'Tinj'  = Prog 0.                             ;
   FIN BBRS                                              ;
   TBT.'Breches' = rxt.'Breches'                         ;
  Finsi                                                  ;
*---------------------------------------------------------

   TBT.'Tbreche' = FAUX                                  ;
  Si (exist rxt 'breche')                                ;

   vertytab rxt 'breche' 'MAILLAGE'                      ;
   vertytab 2 GEO (rxt.'breche')                         ;
   GEO.'Mbreche'=chan 'QUAF' rxt.'breche'                ;
   ELIM GEO.'Mvtf' GEO.'Mbreche' rxt.'epsi'              ;
   TBT.'Tbreche' = VRAI                                  ;

*  listentr= listentr et (mots 'diru1' 'scenario')       ;
   listentr.'diru1'       =''                            ;
   listentr.'scenario'    =''                            ;
   vertytab rxt 'diru1' 'POINT   '                       ;
   TBT.'diru1'=rxt.'diru1'                               ;

   vertytab rxt 'scenario' 'TABLE   '                    ;
   scn = rxt.'scenario'                                  ;
   TBT.'Modinj'=mot 'A'                                  ;
   Si(EXIST rxt.'scenario' 'Modinj')                     ;
   TBT.'Modinj'=rxt.'scenario'.'Modinj'                  ;
   Finsi                                                 ;

  Finsi                                                  ;

   TBT.'Tbreche2' = FAUX                                 ;
  Si (exist rxt 'breche2')                               ;

* pas de breche2 sans breche sinon pb ds les Qo
   vertytab rxt 'breche'  'MAILLAGE'                     ;
   vertytab rxt 'breche2' 'MAILLAGE'                     ;
   vertytab 2 GEO (rxt.'breche2')                        ;
   GEO.'Mbreche2'=chan 'QUAF' rxt.'breche2'              ;
   ELIM GEO.'Mvtf' GEO.'Mbreche2' rxt.'epsi'             ;
   TBT.'Tbreche2' = VRAI                                 ;

*  listentr= listentr et (mots 'diru2''scenario2')       ;
   listentr.'diru2'       =''                            ;
   listentr.'scenario2'   =''                            ;
   vertytab rxt 'diru2' 'POINT   '                       ;
   TBT.'diru2'=rxt.'diru2'                               ;

   vertytab rxt 'scenario2' 'TABLE   '                   ;
   scn2 = rxt.'scenario2'                                ;
   TBT.'Modinj2'=mot 'A'                                 ;
   Si(EXIST rxt.'scenario2' 'Modinj')                    ;
   TBT.'Modinj2'=rxt.'scenario2'.'Modinj'                ;
   Finsi                                                 ;

  Finsi                                                  ;

   TBT.'Tbreche3' = FAUX                                 ;
  Si (exist rxt 'breche3')                               ;

* pas de breche3 sans breche sinon pb ds les Qo
   vertytab rxt 'breche'  'MAILLAGE'                     ;
   vertytab rxt 'breche2' 'MAILLAGE'                     ;
   vertytab rxt 'breche3' 'MAILLAGE'                     ;
   vertytab 2 GEO (rxt.'breche3')                        ;
   GEO.'Mbreche3'=chan 'QUAF' rxt.'breche3'              ;
   ELIM GEO.'Mvtf' GEO.'Mbreche3' rxt.'epsi'             ;
   TBT.'Tbreche3' = VRAI                                 ;

*  listentr= listentr et (mots 'diru3''scenario3')       ;
   listentr.'diru3'       =''                            ;
   listentr.'scenario3'   =''                            ;
   vertytab rxt 'diru3' 'POINT   '                       ;
   TBT.'diru3'=rxt.'diru3'                               ;

   vertytab rxt 'scenario3' 'TABLE   '                   ;
   scn3 = rxt.'scenario3'                                ;
   TBT.'Modinj3'=mot 'A'                                 ;
   Si(EXIST rxt.'scenario3' 'Modinj')                    ;
   TBT.'Modinj3'=rxt.'scenario3'.'Modinj'                ;
   Finsi                                                 ;

  Finsi                                                  ;

*----------------------------------------------------------
   TBT.'Tsortie' = FAUX                                  ;

  Si (exist rxt 'sortie')                                ;
   vertytab rxt 'sortie' 'MAILLAGE'                      ;
   vertytab 2 GEO (rxt.'sortie')                         ;
   GEO.'Msortie'=chan 'QUAF' rxt.'sortie'                ;
   ELIM GEO.'Mvtf' GEO.'Msortie' rxt.'epsi'              ;
   TBT.'Tsortie' = VRAI                                  ;
   Si (NON (exist rxt 'CORTEMP'))                        ;
   TBT.'CORTEMP' = FAUX                                  ;
   Finsi                                                 ;
  Finsi                                                  ;

*----------------------------------------------------------
* XFIMP 1 : Flux de masse imposés
*
   TBT.'TFIMP'  = FAUX                                   ;
 Si (Exist rxt 'XFIMP')                                  ;
   TBT.'TFIMP'  = VRAI                                   ;
   vertytab rxt 'XFIMP'  'TABLE'                         ;
   NBFIMP=dime (rxt.'XFIMP')                             ;
   ifimp=INDEX (rxt.'XFIMP')                             ;
  REPETER BBFIMP NBFIMP                                  ;
   Bfimp=rxt.'XFIMP'.(ifimp.&BBFIMP)                     ;
   vertytab (rxt.'XFIMP') (ifimp.&BBFIMP) 'TABLE'        ;
   vertytab Bfimp 'MAILLAGE' 'MAILLAGE'                  ;
   vertytab Bfimp 't'        'LISTREEL'                  ;
   nds=dime Bfimp.'t';

   Si(Exist Bfimp 'qt')                                  ;
   vertytab Bfimp 'qt'       'LISTREEL'                  ;
   Sinon                                                 ;
   Bfimp.'qt'=prog nds*0.                                ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qeau')                                ;
   vertytab Bfimp 'qeau'     'LISTREEL'                  ;
   Sinon                                                 ;
   Bfimp.'qeau'=prog nds*0.                              ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qair')                                ;
   vertytab Bfimp 'qair'     'LISTREEL'                  ;
   Sinon                                                 ;
   Bfimp.'qair'=prog nds*0.                              ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qhe')                                 ;
   vertytab Bfimp 'qhe'     'LISTREEL'                   ;
   Sinon                                                 ;
   Bfimp.'qhe'=prog nds*0.                               ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qh2')                                 ;
   vertytab Bfimp 'qh2'     'LISTREEL'                   ;
   Sinon                                                 ;
   Bfimp.'qh2'=prog nds*0.                               ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qo2')                                 ;
   vertytab Bfimp 'qo2'     'LISTREEL'                   ;
   Sinon                                                 ;
   Bfimp.'qo2'=prog nds*0.                               ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qn2')                                 ;
   vertytab Bfimp 'qn2'     'LISTREEL'                   ;
   Sinon                                                 ;
   Bfimp.'qn2'=prog nds*0.                               ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qco')                                 ;
   vertytab Bfimp 'qco'     'LISTREEL'                   ;
   Sinon                                                 ;
   Bfimp.'qco'=prog nds*0.                               ;
   Finsi                                                 ;

   Si(Exist Bfimp 'qco2')                                ;
   vertytab Bfimp 'qco2'     'LISTREEL'                  ;
   Sinon                                                 ;
   Bfimp.'qco2'=prog nds*0.                              ;
   Finsi                                                 ;

* Petites initialisations
   Bfimp.'Kqt'  =chai 'Kqt'   &BBTIMP                    ;
   Bfimp.'Kqeau'=chai 'Kqeau' &BBTIMP                    ;
   Bfimp.'Kqair'=chai 'Kqair' &BBTIMP                    ;
   Bfimp.'Kqhe' =chai 'Kqhe'  &BBTIMP                    ;
   Bfimp.'Kqh2' =chai 'Kqh2'  &BBTIMP                    ;
   Bfimp.'Kqo2' =chai 'Kqo2'  &BBTIMP                    ;
   Bfimp.'Kqn2' =chai 'Kqn2'  &BBTIMP                    ;
   Bfimp.'Kqco' =chai 'Kqco'  &BBTIMP                    ;
   Bfimp.'Kqco2'=chai 'Kqco2' &BBTIMP                    ;
   Bfimp.'KFL1'=chai 'KFL1' &BBTIMP                      ;
  FIN BBFIMP                                             ;
   TBT.'XFIMP' = rxt.'XFIMP'                             ;
 Finsi                                                   ;
* XFIMP 1 : Flux de masse imposés

*----------------------------------------------------------
* vtp : thermique paroi
*

   TBT.'THERMP' = FAUX                                   ;
   TBT.'THERCO' = FAUX                                   ;
   TBT.'ECHEXT' = FAUX                                   ;

 Si (Exist rxt 'THERMP')                                 ;
   vertytab rxt 'THERMP' 'LOGIQUE'                       ;
   TBT.'THERMP' = rxt.'THERMP'                           ;
 Finsi                                                   ;

 Si (Exist rxt 'THERCO')                                 ;
   vertytab rxt 'THERCO' 'LOGIQUE'                       ;
   TBT.'THERCO' = rxt.'THERCO'                           ;
  Si (TBT.'THERCO')                                      ;
   TBT.'THERMP' = VRAI                                   ;
   listand=listand et (MOTS 'THCO')                      ;
  Finsi                                                  ;
 Finsi                                                   ;

*---------------------------------------------------------
* Cas d'un nombre quelconque de parois
  TBT.'TPAROIS' = FAUX                                   ;
  Si ('EXIST' rxt 'PAROIS')                              ;

   vertytab rxt 'PAROIS' 'TABLE'                         ;
   vertytab rxt 'ECHAN'    'FLOTTANT' 'CHPOINT'          ;
   NPAR=dime rxt.'PAROIS'                                ;
   mess ' Il y a ' NPAR ' Parois(s)'                     ;
   ipr=index (rxt.'PAROIS')                              ;
   Mvtp= vide 'MAILLAGE'                                 ;
   Repeter BPRS NPAR                                     ;
   Parois=rxt.'PAROIS'.(ipr.&BPRS)                       ;
   vertytab (rxt.'PAROIS') (ipr.&BPRS) 'TABLE'           ;
   mess ' Vérification Paroi ' (ipr.&BPRS)               ;
* On vérifie que le modèle est bien renseigné
   vertytab Parois 'vtp' 'MAILLAGE'                      ;
   Mvtp = Mvtp et Parois.'vtp'                           ;
   vertytab Parois 'ROCP'     'FLOTTANT' 'CHPOINT'       ;
   vertytab Parois 'LAMBDA'   'FLOTTANT' 'CHPOINT'       ;
   vertytab Parois 'Tp0'      'FLOTTANT' 'CHPOINT'       ;
*? vertytab Parois 'ECHAN'    'FLOTTANT' 'CHPOINT'       ;
   CROCP=chai 'ROCP' &BPRS                               ;
   CLAMBDA=chai 'LAMBDA' &BPRS                           ;
   CTP0=chai 'Tp0' &BPRS                                 ;
   'SI' ('NON' ('EXIST' tic CROCP))                      ;
     tic.CROCP=Parois.'ROCP'                             ;
   'FINSI'                                               ;
   'SI' ('NON' ('EXIST' tic CLAMBDA))                    ;
   tic.CLAMBDA=Parois.'LAMBDA'                           ;
   'FINSI'                                               ;
   'SI' ('NON' ('EXIST' tic CTp0))                       ;
   tic.CTp0   =Parois.'Tp0'                              ;
   'FINSI'                                               ;
   FIN BPRS                                              ;
   vertytab 1 GEO Mvtp                                   ;
   GEO.'Mvtp'=chan 'QUAF' Mvtp                           ;
   ELIM GEO.'Mvtp' rxt.'epsi'                            ;
   ELIM GEO.'Mvtf' GEO.'Mvtp' rxt.'epsi'                 ;
   TBT.'PAROIS' = rxt.'PAROIS'                           ;
   TBT.'THERMP' = VRAI                                   ;
   TBT.'TPAROIS' = VRAI                                  ;
  Finsi                                                  ;
*---------------------------------------------------------
 Si (TBT.'THERMP')                                       ;
  Si (NON(TBT.'TPAROIS'))                                ;

* On vérifie que le modèle est bien renseigné
   vertytab rxt 'vtp'      'MAILLAGE'                    ;
   vertytab 1 GEO (rxt.'vtp')                            ;
   GEO.'Mvtp'=chan 'QUAF' rxt.'vtp'                      ;
   ELIM GEO.'Mvtf' GEO.'Mvtp' rxt.'epsi'                 ;
   vertytab rxt 'ROCP'     'FLOTTANT' 'CHPOINT'          ;
   vertytab rxt 'LAMBDA'   'FLOTTANT' 'CHPOINT'          ;
   vertytab rxt 'Tp0'      'FLOTTANT' 'CHPOINT'          ;
   vertytab rxt 'ECHAN'    'FLOTTANT' 'CHPOINT'          ;

   listchp=listchp et (MOTS 'ROCP')                      ;
   listchp=listchp et (MOTS 'LAMBDA')                    ;
   listchp=listchp et (MOTS 'Tp0'   )                    ;
   listchp=listchp et (MOTS 'ECHAN' )                    ;

   'SI' ('NON' ('EXIST' tic 'ROCP'))                     ;
     tic.'ROCP'=rxt.'ROCP'                               ;
   'FINSI'                                               ;
   'SI' ('NON' ('EXIST' tic 'LAMBDA'))                   ;
   tic.'LAMBDA'=rxt.'LAMBDA'                             ;
   'FINSI'                                               ;
   'SI' ('NON' ('EXIST' tic 'Tp0'))                      ;
   tic.'Tp0'   =rxt.'Tp0'                                ;
   'FINSI'                                               ;
  Finsi                                                  ;

  Si (NON (Exist tic 'KHW'))                             ;
   tic.'KHW'   =rxt.'ECHAN'                              ;
  Finsi                                                  ;

  Si (Exist rxt 'ECHEXT')                                ;
   vertytab rxt 'ECHEXT' 'LOGIQUE'                       ;
   TBT.'ECHEXT'   = rxt.'ECHEXT'                         ;
  Finsi                                                  ;

  Si (TBT.'ECHEXT')                                      ;
   vertytab rxt 'parext'   'MAILLAGE'                    ;
   GEO.'Mparext'=chan 'QUAF' rxt.'parext'                ;
   ELIM GEO.'Mvtp' GEO.'Mparext' rxt.'epsi'              ;
   vertytab rxt 'HEXT'     'FLOTTANT' 'CHPOINT'          ;
   vertytab rxt 'TPEXT'    'FLOTTANT' 'CHPOINT'          ;

   listchp=listchp et (MOTS 'HEXT'  )                    ;
   listchp=listchp et (MOTS 'TPEXT' )                    ;

   'SI' ('NON' ('EXIST' tic 'HEXT'))                     ;
   tic.'HEXT'=rxt.'HEXT'                                 ;
   'FINSI'                                               ;
   'SI' ('NON' ('EXIST' tic 'TPEXT'))                    ;
   tic.'TPEXT'=rxt.'TPEXT'                               ;
   'FINSI'                                               ;

  Finsi                                                  ;

 'MESS' ' : ==> Scénario avec thermique paroi  '         ;
 Sinon                                                   ;
 'MESS' ' : ==> Scénario sans thermique paroi  '         ;
 Finsi                                                   ;
*----------------------------------------------------------
* TIMPi : Températures imposées
*
   TBT.'TTIMP'  = FAUX                                   ;
   TBT.'TTIMP1' = FAUX                                   ;
   TBT.'TTIMP2' = FAUX                                   ;
   TBT.'TTIMP3' = FAUX                                   ;
 Si (Exist rxt 'TIMP')                                   ;
   TBT.'TTIMP'  = VRAI                                   ;
   vertytab rxt 'TIMP'  'TABLE'                          ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 1 ';
   mess ' Vérification TIMP->'(itimp.&BBTIMP)            ;
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
   vertytab (rxt.'TIMP') (itimp.&BBTIMP) 'TABLE'         ;
   vertytab Btimp 'MAILLAGE' 'MAILLAGE'                  ;
   vertytab Btimp 'ECHAN'    'FLOTTANT'                  ;
   vertytab Btimp 't'        'LISTREEL'                  ;
   vertytab Btimp 'TIMP'     'LISTREEL'                  ;
* Petites initialisations
   Btimp.'KKC1'=chai 'KKC1' &BBTIMP                      ;
   Btimp.'ROVI1'=chai 'ROVI1' &BBTIMP                    ;
   Btimp.'FHP1'=chai 'FHP1' &BBTIMP                      ;
   Btimp.'KH1'=chai 'KH1' &BBTIMP                        ;
   Btimp.'Fcond1'=chai 'Fcond1' &BBTIMP                  ;
   Btimp.'Mcond1'=chai 'Mcond1' &BBTIMP                  ;
   Btimp.'TPI1'=chai 'TPI1' &BBTIMP                      ;
   Btimp.'TBP1'=chai 'TBP1' &BBTIMP                      ;
   Btimp.'KHE1'=chai 'KHE1' &BBTIMP                      ;
   Btimp.'Ltbpi'=prog                                    ;
   Btimp.'Qc1'=chai 'Qc1' &BBTIMP                        ;
  FIN BBTIMP                                             ;
   TBT.'TIMP' = rxt.'TIMP'                               ;
 Finsi                                                   ;

 Si (Exist rxt 'TIMP1')                                  ;
   TBT.'TTIMP1' = VRAI                                   ;
   vertytab rxt 'TIMP1' 'TABLE'                          ;
   vertytab (rxt.'TIMP1') 'MAILLAGE' 'MAILLAGE'          ;
   vertytab (rxt.'TIMP1') 'ECHAN'    'FLOTTANT'          ;
   vertytab (rxt.'TIMP1') 't'        'LISTREEL'          ;
   vertytab (rxt.'TIMP1') 'TIMP'     'LISTREEL'          ;
 Finsi                                                   ;

 Si (Exist rxt 'TIMP2')                                  ;
   TBT.'TTIMP2' = VRAI                                   ;
   vertytab rxt 'TIMP2' 'TABLE'                          ;
   vertytab (rxt.'TIMP2') 'MAILLAGE' 'MAILLAGE'          ;
   vertytab (rxt.'TIMP2') 'ECHAN'    'FLOTTANT'          ;
   vertytab (rxt.'TIMP2') 't'        'LISTREEL'          ;
   vertytab (rxt.'TIMP2') 'TIMP'     'LISTREEL'          ;
 Finsi                                                   ;

 Si (Exist rxt 'TIMP3')                                  ;
   TBT.'TTIMP3' = VRAI                                   ;
   vertytab rxt 'TIMP3' 'TABLE'                          ;
   vertytab (rxt.'TIMP3') 'MAILLAGE' 'MAILLAGE'          ;
   vertytab (rxt.'TIMP3') 'ECHAN'    'FLOTTANT' 'CHPOIN' ;
   vertytab (rxt.'TIMP3') 't'        'LISTREEL'          ;
   vertytab (rxt.'TIMP3') 'TIMP'     'LISTREEL'          ;
 Finsi                                                   ;

*----------------------------------------------------------
* ECHANP : Température du mur constante ou calculée via une procédure
* personnelle
   TBT.'TECHANP' = FAUX                                  ;
 Si (Exist rxt 'ECHANP')                                 ;
   TBT.'TECHANP' = VRAI                                  ;
   vertytab rxt 'ECHANP' 'TABLE'                         ;
   vertytab (rxt.'ECHANP') 'MAILLAGE' 'MAILLAGE'         ;
   vertytab (rxt.'ECHANP') 'ECHAN'    'FLOTTANT'         ;
   vertytab (rxt.'ECHANP') 'TMUR'     'FLOTTANT'         ;
 Finsi                                                   ;
*
* On verifie les données de la table RECOMB (définitions des recombineurs)
TBT . 'TRECOMB' = FAUX ;
'SI' ('EXIS' rxt 'RECOMB') ;
   vertytab rxt 'RECOMB' 'TABLE   ' ;
   NBREC = 'DIME' rxt . 'RECOMB' ;
   'REPE' BCL1 NBREC ;
      TRECI = rxt . 'RECOMB' . &BCL1 ;
      lxt = table            ;
      lxt . 'PAREXT'   = ' ' ;
      lxt . 'ENTREE'   = ' ' ;
      lxt . 'SORTIE'   = ' ' ;
      lxt . 'direntr'  = ' ' ;
      lxt . 'dirsort'  = ' ' ;
      lxt . 'NSECTION' = ' ' ;
      lxt . 'TYPR'     = ' ' ;
      vertytab TRECI 'PAREXT' 'MAILLAGE' ;
      vertytab TRECI 'ENTREE' 'MAILLAGE' ;
      vertytab TRECI 'SORTIE' 'MAILLAGE' ;
      vertytab TRECI 'direntr' 'POINT   ' ;
      vertytab TRECI 'dirsort' 'POINT   ' ;
      'SI' ('EXIS' TRECI 'NSECTION') ;
         vertytab TRECI 'NSECTION' 'ENTIER  ' ;
      'SINO' ;
         TRECI . 'NSECTION' = 1 ;
      'FINSI' ;
      'SI' ('EXIS' TRECI 'TYPR') ;
         vertytab TRECI 'TYPR' 'MOT' ;
         lm1 = 'MOTS' 'SIEMENS' 'HEATER' ;
         vertytab lm1 (TRECI . 'TYPR') 'MOT' ;
      'SINO' ;
         TRECI . 'TYPR' = 'SIEMENS' ;
      'FINSI' ;
      typr = TRECI . 'TYPR' ;
      'SI' ('EGA' typr 'SIEMENS') ;
         lxt . 'A'        = ' ' ;
         lxt . 'B'        = ' ' ;
         lxt . 'XH2ON'    = ' ' ;
         lxt . 'XH2OFF'   = ' ' ;
         lxt . 'BETA'     = ' ' ;
         'SI' ('EXIS' TRECI 'A') ;
            vertytab TRECI 'A' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'A' = 0.48D-8 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'B') ;
            vertytab TRECI 'B' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'B' = 0.58D-3 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'XH2ON') ;
            vertytab TRECI 'XH2ON' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'XH2ON' = 0.005D0 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'XH2OFF') ;
            vertytab TRECI 'XH2OFF' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'XH2OFF' = 0.005D0 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'BETA') ;
            vertytab TRECI 'BETA' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'BETA' = 0.2D0 ;
         'FINSI' ;
      'SINO' ;
         lxt . 'PUISSANCE' = ' ' ;
         lxt . 'QHOUSING'  = ' ' ;
         lxt . 'HRAPP'     = ' ' ;
         lxt . 'CRAPP'     = ' ' ;
         vertytab TRECI 'PUISSANCE' 'EVOLUTIO' ;
         'SI' ('EXIS' TRECI 'QHOUSING') ;
            vertytab TRECI 'QHOUSING' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'QHOUSING' = 0.1D0 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'HRAPP') ;
            vertytab TRECI 'HRAPP' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'HRAPP' = 1.7D0 ;
         'FINSI' ;
         'SI' ('EXIS' TRECI 'CRAPP') ;
            vertytab TRECI 'CRAPP' 'FLOTTANT' ;
         'SINO' ;
            TRECI . 'CRAPP' = 136.0868234D0 ;
         'FINSI' ;
      'FINSI' ;
      indtrec = 'INDE' treci ;
      nind    = 'DIME' indtrec ;
*      'LIST' indtrec ;
*      'LIST' lxt ;
      'REPE' bouind nind ;
         'SI' ('NON' ('EXIS'  lxt ('MOT' indtrec . &bouind))) ;
Mess                                                                 ;
Mess '**************************************************************';
Mess                                                                 ;
Mess ' Il y a un indice non reconnu :   ' (indtrec . &bouind)
'    dans la table RECOMB . ' &bcl1 ;
Mess                                                                 ;
Mess '**************************************************************';
'ERRE' 21 ;
         'FINSI' ;
      'FIN' bouind ;
   'FIN' BCL1 ;
   TBT . 'TRECOMB' = VRAI ;
   TBT . 'RECOMB'  = rxt . 'RECOMB' ;
'FINSI' ;
*----------------------------------------------------------
* MODTURB = Mot identifiant le modèle de turbulence
* NUTURB ou LMEL ou KEPSILON ou NUTCONS

  Si (Exist rxt 'MODTURB')                               ;

   vertytab rxt 'MODTURB' 'MOT'                          ;
   TBT.'MODTURB'=rxt.'MODTURB'                           ;

* On vérifie que le modèle est bien identifié
   lxt=table                                             ;
   lxt.'NUTURB'   = ' '                                  ;
   lxt.'LMEL'     = ' '                                  ;
   lxt.'KEPSILON' = ' '                                  ;
   vertytab lxt rxt.'MODTURB' 'MOT'                      ;

* Nu turbulent constant
   Si(Ega rxt.'MODTURB' 'NUTURB')                        ;
*  listentr=listentr et (mots 'NUT')                     ;
   listentr.'NUT'         =''                            ;
   vertytab rxt 'NUT' 'FLOTTANT'                         ;
   TBT.'NUT'    = rxt.'NUT'                              ;
   Finsi                                                 ;

* Longueur de mélange
   Si(Ega rxt.'MODTURB' 'LMEL' )                         ;
*  listentr=listentr et (mots 'LMEL')                    ;
   listentr.'LMEL'        =''                            ;
   vertytab rxt 'LMEL' 'FLOTTANT'                        ;
   TBT.'LMEL' = rxt.'LMEL'                               ;
   Finsi                                                 ;

 'MESS' '         : ==> Scenario avec modèle de turbulence '
  rxt.'MODTURB' ;
 Sinon                                                   ;
 'MESS' '         : ==> Scenario sans modèle de turbulence ';
 Finsi                                                   ;
*----------------------------------------------------------
* FPAROI = logique identifiant l'utilisation de fonctions
* de paroi

   TBT.'FPAROI' = FAUX                                   ;
 'SI' ('EXIST' rxt 'FPAROI')                             ;
   vertytab rxt 'FPAROI' 'LOGIQUE'                       ;
   TBT.'FPAROI' = rxt.'FPAROI'                           ;
 'FINSI'                                                 ;

 'SI' TBT.'FPAROI'                                       ;
 'MESS' '         : ==> Scenario avec fonction de paroi ';
*  listentr=listentr et (mots 'YP')                      ;
   listentr.'YP'          =''                            ;
   vertytab rxt 'YP' 'FLOTTANT'                          ;
   TBT.'YP'=rxt.'YP'                                     ;
 'FINSI'                                                 ;

*----------------------------------------------------------
* MODCOND = mot identifiant la formulation du flux de
* condensation
   TBT.'MODCOND' = 'CHIL0'                               ;
'SI' ('EXIST' rxt 'MODCOND')                             ;
   vertytab rxt 'MODCOND' 'MOT'                          ;
   TBT.'MODCOND' = rxt.'MODCOND'                         ;

* On vérifie que le modèle est bien identifié
   lxt=table                                             ;
   lxt.'CHIL0'   = ' '                                   ;
   lxt.'CHIL1'     = ' '                                 ;
   vertytab lxt rxt.'MODCOND' 'MOT'                      ;

'FINSI'                                                  ;
   'MESS' '       : ==> Scénario avec flux de condensation '
  TBT.'MODCOND' ;
*----------------------------------------------------------
* PERSO = logique identifiant une procédure PERSO
* dans le cas de calcul

   TBT.'PERSO' = FAUX                                    ;
'SI' ('EXIST' rxt 'PERSO')                               ;
   vertytab rxt 'PERSO' 'LOGIQUE'                        ;
   TBT.'PERSO' = rxt.'PERSO'                             ;
'FINSI'                                                  ;

 'SI' TBT.'PERSO'                                        ;
 'MESS' '         : ==> Scénario avec exécution d une  ' ;
 'MESS' '               procédure personnelle          ' ;

* listentr = listentr et (mots 'PRCPERSO' 'TABPERSO')    ;
  listentr.'PRCPERSO' =''                                ;

   vertytab rxt 'PRCPERSO' 'MOT'                         ;
   TBT.'PRCPERSO' = rxt.'PRCPERSO'                       ;
'FINSI'                                                  ;

*----------------------------------------------------------
* TABPERSO = table personnelle                           ;
 'SI' ('EXIST' rxt 'TABPERSO')                           ;
   vertytab rxt 'TABPERSO' 'TABLE'                       ;
   TBT.'TABPERSO' = rxt.'TABPERSO'                       ;
'FINSI'                                                  ;

*----------------------------------------------------------
* VAPEUR = logique identifiant l'utilisation de vapeur
* dans le cas de calcul

   TBT.'VAPEUR' = FAUX                                   ;
 'SI' ('EXIST' rxt 'VAPEUR')                             ;
   vertytab rxt 'VAPEUR' 'LOGIQUE'                       ;
   TBT.'VAPEUR' = rxt.'VAPEUR'                           ;
 'FINSI'                                                 ;

 'SI' TBT.'VAPEUR'                                       ;
   vertytab rxt 'Yvap0' 'FLOTTANT'                       ;
   listentr.'Yvap0'        =''                           ;
   listentr.'Mliq0'        =''                           ;
   listentr.'Lv'           =''                           ;
   listentr.'Cpvap'        =''                           ;
 'FINSI'                                                 ;

*-----------------------------------------------------------
* Modif. FP 18/05/00
* Introduction d'une nouvelle variable logique qui est vrai lorsque la
* condensation en masse est prise en compte.

* CONDMAS = Mot identifiant le modèle de condensation en masse
* CMAS0

   TBT.'CONDMAS' = FAUX                                  ;
   TBT.'MODCMAS'  ='????'                                ;
   listentr.'CONDMAS'     =''                            ;
   listentr.'HMAS'        =''                            ;
   listentr.'WCM'         =''                            ;
*'SI' ('EXIST' rxt 'CONDMAS')                             ;
*   vertytab rxt 'CONDMAS' 'MOT'                          ;
*   TBT.'CONDMAS' = VRAI                                  ;
** On vérifie que le modèle est bien identifié
*   lxt=table                                             ;
*   lxt.'CMAS0'    = ' '                                  ;
*   vertytab lxt rxt.'CONDMAS' 'MOT'                      ;
*   TBT.'MODCMAS'  = rxt.'CONDMAS'                        ;
*     Si ('EGA' rxt.'CONDMAS' 'CMAS0')                    ;
*      Si ('EXIST' rxt 'HMAS')                            ;
*      vertytab rxt 'HMAS' 'FLOTTANT'                     ;
*      TBT.'HMAS'=rxt.'HMAS'                              ;
*      Sinon                                              ;
*      TBT.'HMAS'=0.                                      ;
*      Finsi                                              ;
*      Si ('EXIST' rxt 'WCM')                             ;
*      vertytab rxt 'WCM' 'FLOTTANT'                      ;
*      TBT.'WCM'=rxt.'WCM'                                ;
*      Sinon                                              ;
*      TBT.'WCM'=0.                                       ;
*      Finsi                                              ;
*     Finsi                                               ;
*'FINSI'                                                  ;
*-----------------------------------------------------------
* ASPER logique indiquant qu'on traite l'aspersion

'SI' TBT.'VAPEUR'                                        ;
   listentr.'ASPER'       =''                            ;
'FINSI'                                                  ;

   TBT.'ASPER' = FAUX                                    ;
 'SI' ('EXIST' rxt 'ASPER')                              ;
   vertytab rxt 'ASPER' 'LOGIQUE'                        ;
   TBT.'ASPER' = rxt.'ASPER'                             ;
 'FINSI'                                                 ;

 'SI' (TBT.'ASPER')                                      ;
   listentr.'scenasp'    =''                             ;
   vertytab rxt 'scenasp' 'TABLE   '                     ;
   scn = rxt.'scenasp'                                   ;

   vertytab rxt 'aspinj' 'MAILLAGE'                      ;
   listentr.'aspinj'      =''                            ;
   vertytab rxt 'toitf'  'MAILLAGE'                      ;
   listentr.'toitf'       =''                            ;
   vertytab rxt 'rod'    'FLOTTANT'                      ;
   listentr.'rod'        =''                             ;
   vertytab rxt 'Cpd'    'FLOTTANT'                      ;
   listentr.'Cpd'         =''                            ;
 'FINSI'                                                 ;

*----------------------------------------------------------
* Vérification des incondensables utilisés
* Les incondensables possibles sont H2, HE, O2, N2, CO, CO2
*
*---------------------------------------------------------
LINCOND = 'MOTS'                                         ;
TBT.'TH2' = FAUX                                         ;
TBT.'THE' = FAUX                                         ;
TBT.'TO2' = FAUX                                         ;
TBT.'TN2' = FAUX                                         ;
TBT.'TCO2'= FAUX                                         ;
TBT.'TAIR'= FAUX                                         ;
TBT.'TCO' = FAUX                                         ;

'SI' ('EXIST' rxt 'H2' )                                 ;
 vertytab rxt 'H2' 'LOGIQUE'                             ;
 TBT.'TH2' = rxt.'H2'                                    ;
 'SI' TBT.'TH2'                                          ;
 LINCOND=LINCOND 'ET' ('MOTS' 'H2')                      ;
 vertytab rxt 'Yh20' 'FLOTTANT'                          ;
 listentr.'Yh20'        =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qh2' 'LISTREEL'           ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'HE' )                                 ;
 vertytab rxt 'HE' 'LOGIQUE'                             ;
 TBT.'THE' = rxt.'HE'                                    ;
 'SI' TBT.'THE'                                          ;
 LINCOND=LINCOND 'ET' ('MOTS' 'HE')                      ;
 vertytab rxt 'Yhe0' 'FLOTTANT'                          ;
 listentr.'Yhe0'        =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qhe' 'LISTREEL'           ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'O2' )                                 ;
 vertytab rxt 'O2' 'LOGIQUE'                             ;
 TBT.'TO2' = rxt.'O2'                                    ;
 'SI' TBT.'TO2'                                          ;
 LINCOND=LINCOND 'ET' ('MOTS' 'O2')                      ;
 vertytab rxt 'Yo20' 'FLOTTANT'                          ;
 listentr.'Yo20'        =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qo2' 'LISTREEL'           ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'N2' )                                 ;
 vertytab rxt 'N2' 'LOGIQUE'                             ;
 TBT.'TN2' = rxt.'N2'                                    ;
 'SI' TBT.'TN2'                                          ;
 LINCOND=LINCOND 'ET' ('MOTS' 'N2')                      ;
 vertytab rxt 'Yn20' 'FLOTTANT'                          ;
 listentr.'Yn20'        =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qn2' 'LISTREEL'           ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'CO2' )                                ;
 vertytab rxt 'CO2' 'LOGIQUE'                            ;
 TBT.'TCO2' = rxt.'CO2'                                  ;
 'SI' TBT.'TCO2'                                         ;
 LINCOND=LINCOND 'ET' ('MOTS' 'CO2')                     ;
 vertytab rxt 'Yco20' 'FLOTTANT'                         ;
 listentr.'Yco20'       =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qco2' 'LISTREEL'          ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'AIR' )                                ;
 vertytab rxt 'AIR' 'LOGIQUE'                            ;
 TBT.'TAIR' = rxt.'AIR'                                  ;
 'SI' TBT.'TAIR'                                         ;
 LINCOND=LINCOND 'ET' ('MOTS' 'AIR')                     ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qair' 'LISTREEL'          ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

'SI' ('EXIST' rxt 'CO' )                                 ;
 vertytab rxt 'CO' 'LOGIQUE'                             ;
 TBT.'TCO' = rxt.'CO'                                    ;
 'SI' TBT.'TCO'                                          ;
 LINCOND=LINCOND 'ET' ('MOTS' 'CO')                      ;
 vertytab rxt 'Yco0' 'FLOTTANT'                          ;
 listentr.'Yco0'        =''                              ;
  'SI' ('EXIST' rxt 'scenario')                          ;
    vertytab (rxt.'scenario') 'qco' 'LISTREEL'           ;
  'FINSI'                                                ;
 'FINSI'                                                 ;
'FINSI'                                                  ;

*---------------------------------------------------------
* Affichage de la liste des incondensables
*---------------------------------------------------------

TINCOND= 'NON' ( 'EGA' ('DIME' LINCOND ) 0 )             ;
'SI' TINCOND                                             ;
'MESS' ' Liste des incondensables : '                    ;
'LIST' LINCOND                                           ;
'SINON'                                                  ;
'MESS' ' Il n y a pas d incondensable hormis AIR '       ;
'FINSI'                                                  ;
*
'SI' TBT.'TRECOMB' ;
   LOG0  = TBT.'TH2' 'ET' TBT.'VAPEUR' 'ET' TBT.'TN2' 'ET' TBT.'TO2' ;
   NBREC = 'DIME' rxt . 'RECOMB' ;
   'REPE' BCL2 NBREC ;
        TRECI = rxt . 'RECOMB' . &BCL2 ;
        'SI' ('EGA' (TRECI . 'TYPR') 'SIEMENS') ;
             'SI' ('NON' LOG0) ;
               'MESS' 'RECOMBINEUR ==> H2, H20, O2 et N2 par defaut !' ;
               'ERRE' 5 ;
             'FINSI' ;
             'QUIT' BCL2 ;
        'FINSI' ;
   'FIN' BCL2 ;
'FINSI' ;
*---------------------------------------------------------
* Initialisation des paramètres du modèle
* nimpr = Niveau impression lors de la résolution
*         0 = Pas d'impression
* epsi = tolérance pour les maillages (OPERATEUR ELIM)
* FRPREC : ENTIER fréquence de recalcul du préconditionnement
*---------------------------------------------------------

 TBT.'nimpr'=0                                           ;
 TBT.'IMPR' =2                                           ;
'SI' ('EXIST' rxt 'IMPR' )                               ;
 vertytab rxt 'IMPR'  'ENTIER'                           ;
 TBT.'IMPR' =rxt.'IMPR'                                  ;
'FINSI'                                                  ;

'SI' ( 'EXIST' rxt 'FRPREC' )                                      ;
  vertytab rxt 'FRPREC' 'ENTIER'                                   ;
  TBT.'FRPREC'   = rxt.'FRPREC'                                    ;
'FINSI'                                                            ;
*-----------------------------------------------------------------------
* Controle des entrées de la table RXT et de la compatibilité
* entre les entrées.
*-----------------------------------------------------------------------
* On vérifie que les entrées de RXT sont autorisées


  lindex=index rxt ;
  n=dime lindex;

  repeter Bver n ;
*mess lindex.&bver ;
  tae=type lindex.&bver ;
  Si (non (ega tae 'MOT'));
  Mess ' Il y a un indice qui n est pas de type mot dans la table ';
  erreur 21 ;
  Finsi ;
  Si (non (exist listentr lindex.&bver)) ;
  Mess                                                                 ;
  Mess '**************************************************************';
  Mess                                                                 ;
  Mess ' Il y a un indice non reconnu :   ' lindex.&bver
 '    dans la table ';
  Mess                                                                 ;
  Mess '********************6*****************************************';

  erreur 21 ;
  Finsi ;
  Fin Bver ;

  n=dime listand ;
  Si (non (ega n 0));
  Mess                                                                 ;
  Mess ' Il y a des options surchargées dont voici la liste :   '      ;
  list listand                                                         ;
  Si (exist listand 'THCO')                                            ;
  Mess                                                                 ;
  Mess 'Commentaire:'                                                  ;
  mess 'THCO: le couplage thermique paroi/thermohydraulique'
  ' est implicite'                                                     ;
  Finsi                                                                ;
  Mess                                                                 ;
  Finsi ;

* Vérification de Compatibilités

'SI'(('EGA' TBT.'ALGO' 'EFM1') et ('EGA' TBT.'discr' 'QUAF'))          ;
vertytab 'ERREUR' 'ERREUR'
                            (CHAI 'Options QUAF et EFM1 incompatibles');
'FINSI'                                                                ;


'SI'(Exist TBT 'MODTURB')                                              ;
'SI'( (Ega TBT.'MODTURB' 'KEPSILON') et (non('EGA' TBT.'ALGO' 'EFM1')));
vertytab 'ERREUR' 'ERREUR'
       (CHAI 'L option EFM1 est nécessaire pour le modèle K-epsilon')  ;
'FINSI'                                                                ;
'FINSI'                                                                ;

'SI'(TBT.'Tsortie' et TBT.'CORTEMP')                                   ;
vertytab 'ERREUR' 'ERREUR'
  (CHAI 'Ecoulement ouvert (Sortie) incompatible avec CORTEMP VRAI')   ;
'FINSI'                                                                ;


mess WWW                                                               ;
mess '------------- FIN DES INITIALISATIONS ET VERIFICATIONS ---------';
mess '------------------------- DEBUT DU CALCUL ----------------------';
mess WWW                                                               ;
mess                                                                   ;
*-----------------------------------------------------------------------
*-----------------------------------------------------------------------
*-----------------------------------------------------------------------
* ------------- FIN DES INITIALISATIONS ET VERIFICATIONS ---------------
*-----------------------------------------------------------------------
*-----------------------------------------------------------------------
*-----------------------------------------------------------------------

 'SI' (TPREPA);
   PREPAENC rxt TBT GEO TIC ;
 'FINSI' ;

  rxt.'TBT'=TBT;

*==============================================================
 GEO=rxt.'GEO' ;

* On depile un certain nombre de renseignements sur le
* cas test a traiter

  idim = vale 'DIME';
  DIM3D=FAUX ;
  Si(EGA idim 3);
  DIM3D=VRAI ;
  Finsi ;

* B/ Les maillages ou modeles

**?? vtf         = rxt.'vtf'                             ;
 vtf         = GEO.'vtf'                                 ;
'SI' (TBT.'Tbreche');
 breche = rxt.'breche'                                   ;
 brechec=GEO.'brechec'                                   ;
 brechei=GEO.'brechei'                                   ;
 $breche=GEO.'$breche'                                   ;
 Sbreche = GEO.'Sbreche'                                 ;
'FINSI';
'SI' (TBT.'Tbreche2');
 breche2=rxt.'breche2'                                   ;
 brech2c=GEO.'brech2c'                                   ;
 brech2i=GEO.'brech2i'                                   ;
 $breche2=GEO.'$breche2'                                 ;
 Sbreche2= GEO.'Sbreche2'                                ;
'FINSI';
'SI' (TBT.'Tbreche3');
 breche3=rxt.'breche3'                                   ;
 brech3c=GEO.'brech3c'                                   ;
 brech3i=GEO.'brech3i'                                   ;
 $breche3=GEO.'$breche3'                                 ;
 Sbreche3= GEO.'Sbreche3'                                ;
'FINSI';

 $vtf      = GEO.'$vtf'                                  ;
'SI' TBT.'THERMP'                                        ;
 $vtp      = GEO.'$vtp'                                  ;
 $paroif  = GEO.'$paroif'                                ;
 paroif   = GEO.'paroif'                                 ;
'FINSI'                                                  ;

 Diag   = 'DOMA' $vtf    'XXDIAGSI'                      ;

 Volvtf = 'DOMA' $vtf    'VOLUME'                        ;
 VTotal  = GEO.'VTotal'                                  ;


'MESS' ' ************* GEOMETRIE  *********************' ;
'MESS' ' **********************************************' ;
  'DOMA' $vtf 'IMPR'                                     ;
'SI' TBT.'THERMP'                                        ;
  'DOMA' $vtp 'IMPR'                                     ;
'FINSI'                                                  ;


* C/ Les chaines de caracteres

 tic    = rxt.'TIC'                                      ;

* D/ Les données physiques

 Cpvap  = TBT.'Cpvap'                                    ;
 Lv     = TBT.'Lv'                                       ;
 Rgh2   = TBT.'Rgh2'                                     ;
 Rghe   = TBT.'Rghe'                                     ;
 Rgo2   = TBT.'Rgo2'                                     ;
 Rgn2   = TBT.'Rgn2'                                     ;
 Rgco2  = TBT.'Rgco2'                                    ;
 Rgco   = TBT.'Rgco'                                     ;
 Rgvap  = TBT.'Rgvap'                                    ;
 Rgair  = TBT.'Rgair'                                    ;

'MESS' ' ************* DISCRETISATION *****************' ;
'MESS' ' **********************************************' ;
'MESS' ' Discr = ' tbt.'discr' ' Pression = ' tbt.'KPRE' ;
'MESS' ' Algo  = ' algo  ' Niveau impression = ' nimpr   ;
'MESS' ' Pas de temps DT = ' rxt.'DT0'                   ;

* Calcul Cp (Tfm)
ndl   = 'DIME' (tic.'Tfm')                               ;
Tfm   = 'EXTR' (tic.'Tfm')    ndl                        ;
* CALCP initialisation  ?
Cph2 Cphe Cpo2 Cpn2 Cpco2 Cpco Cpair =  CALCP  Tfm       ;
Cpvap = TBT.'Cpvap'                                      ;

* Calcul Mu (Tkm)
Tkm=Tfm '+' 273.15                                       ;
Muh2 Muhe Muo2 Mun2 Muco2 Muco Muvap Muair =  CALMU  Tkm ;

'MESS' ' ******* PROPRIETES PHYSIQUES *****************' ;
'MESS' ' **********************************************' ;

'MESS' ' ***** Air ***** '                               ;
 Cvair       = Cpair '-' Rgair                           ;
'MESS' '==> Cpair = ' Cpair 'J/kg/K'                     ;
'MESS' '==> Cvair = ' Cvair 'J/kg/K'                     ;
'MESS' '==> Rgair = ' Rgair 'J/kg/K'                     ;

'SI' TBT.'VAPEUR'                                        ;
'MESS' ' ***** Vapeur H2o ***** '                        ;
 Cvvap       = Cpvap '-' Rgvap                           ;
'MESS' '==> Cpvap = ' Cpvap 'J/kg/K'                     ;
'MESS' '==> Cvvap = ' Cvvap 'J/kg/K'                     ;
'MESS' '==> Rgvap = ' Rgvap 'J/kg/K'                     ;
'MESS' '==> Lv    = ' Lv  'J/kg/K'                       ;
'FINSI'                                                  ;

'SI' TBT.'THE'                                           ;
'MESS' ' ***** He  ***** '                               ;
 Cvhe        = Cphe  '-' Rghe                            ;
'MESS' '==> Cphe  = ' Cphe 'J/kg/K'                      ;
'MESS' '==> Cvhe  = ' Cvhe 'J/kg/K'                      ;
'MESS' '==> Rghe  = ' Rghe 'J/kg/K'                      ;
'FINSI'                                                  ;

'SI' TBT.'TH2'                                           ;
'MESS' ' ***** H2  ***** '                               ;
 Cvh2        = Cph2  '-' Rgh2                            ;
'MESS' '==> Cph2  = ' Cph2 'J/kg/K'                      ;
'MESS' '==> Cvh2  = ' Cvh2 'J/kg/K'                      ;
'MESS' '==> Rgh2  = ' Rgh2 'J/kg/K'                      ;
'FINSI'                                                  ;

'SI' TBT.'TO2'                                           ;
'MESS' ' ***** O2  ***** '                               ;
 Cvo2        = Cpo2  '-' Rgo2                            ;
'MESS' '==> Cpo2  = ' Cpo2 'J/kg/K'                      ;
'MESS' '==> Cvo2  = ' Cvo2 'J/kg/K'                      ;
'MESS' '==> Rgo2  = ' Rgo2 'J/kg/K'                      ;
'FINSI'                                                  ;

'SI' TBT.'TN2'                                           ;
'MESS' ' ***** N2  ***** '                               ;
 Cvn2        = Cpn2  '-' Rgn2                            ;
'MESS' '==> Cpn2  = ' Cpn2 'J/kg/K'                      ;
'MESS' '==> Cvn2  = ' Cvn2 'J/kg/K'                      ;
'MESS' '==> Rgn2  = ' Rgn2 'J/kg/K'                      ;
'FINSI'                                                  ;

'SI' TBT.'TCO2'                                          ;
'MESS' ' ***** CO2 ***** '                               ;
 Cvco2       = Cpco2 '-' Rgco2                           ;
'MESS' '==> Cpco2 = ' Cpco2 'J/kg/K'                     ;
'MESS' '==> Cvco2 = ' Cvco2 'J/kg/K'                     ;
'MESS' '==> Rgco2 = ' Rgco2 'J/kg/K'                     ;
'FINSI'                                                  ;

'SI' TBT.'TAIR'                                          ;
'MESS' ' ***** AIR ***** '                               ;
 Cvair       = Cpair '-' Rgair                           ;
'MESS' '==> Cpair = ' Cpair 'J/kg/K'                     ;
'MESS' '==> Cvair = ' Cvair 'J/kg/K'                     ;
'MESS' '==> Rgair = ' Rgair 'J/kg/K'                     ;
'FINSI'                                                  ;

'SI' TBT.'TCO'                                           ;
'MESS' ' ***** CO  ***** '                               ;
 Cvco        = Cpco  '-' Rgco                            ;
'MESS' '==> Cpco  = ' Cpco 'J/kg/K'                      ;
'MESS' '==> Cvco  = ' Cvco 'J/kg/K'                      ;
'MESS' '==> Rgco  = ' Rgco 'J/kg/K'                      ;
'FINSI'                                                  ;

'MESS' ' *************** '                               ;
'MESS' ' Diffusion browniene db = ' db                   ;
'SI' TBT.'THERMP'                                        ;
  'SI' ('EGA' ('TYPE' tic.'KHW') 'CHPOINT')              ;
    'MESS' ' Coefficient d echange ECHAN (Min/Max)= '
       ('MINI' tic.'KHW') '  ' ('MAXI' tic.'KHW') 'W/m2/K' ;
  'SINON' ;
'MESS' ' Coefficient d echange ECHAN= ' tic.'KHW' 'W/m2/K' ;
  'FINSI'                                                ;
'FINSI'                                                  ;


*======================================================================;
'MESS' '*** Bilans initiaux 0D-MultiD ***'               ;
'MESS' '_____________________________________________________________';
'MESS' '---------Bilans 0D ____________________Bilans MultiD ________'
       '_____________ Erreur Relative (%)';
*---- Bilan masse
 Rhomn   = 'EXTR' (tic.'Rhomn')    ndl                    ;
 M0D = Rhomn '*' Vtotal                                  ;
 MMD = 'SOMT' (Diag '*' rxt.'TIC'.'RHO')                 ;

 'SI' TBT.'VAPEUR'                                       ;
      Rhomv   = 'EXTR' (tic.'Rhomv')    ndl              ;
      MV0D = Rhomv '*' Vtotal                            ;
      MVMD = 'SOMT' (Diag '*' rxt.'TIC'.'ROVP')          ;
      Rhomvg  = 'EXTR' (tic.'Rhomvg')    ndl             ;
*?    Rliqm   = 'EXTR' (tic.'Rliqm')     ndl             ;
*?    Rbrom   = 'EXTR' (tic.'Rbrom')     ndl             ;
      MVG0D = Rhomvg '*' Vtotal                          ;
      MVGMD = 'SOMT' (Diag '*' rxt.'TIC'.'RVP')          ;
 'FINSI'                                                 ;
 'SI' TBT.'THE'                                          ;
      Rhomhe   = 'EXTR' (tic.'Rhomhe')    ndl            ;
      MHE0D = Rhomhe '*' Vtotal                          ;
      MHEMD = 'SOMT' (Diag '*' rxt.'TIC'.'RHE')          ;
 'FINSI'                                                 ;
 'SI' TBT.'TH2'                                          ;
      Rhomh2   = 'EXTR' (tic.'Rhomh2')    ndl            ;
      MH20D = Rhomh2 '*' Vtotal                          ;
      MH2MD = 'SOMT' (Diag '*' rxt.'TIC'.'RH2')          ;
 'FINSI'                                                 ;
 'SI' TBT.'TO2'                                          ;
      Rhomo2   = 'EXTR' (tic.'Rhomo2')    ndl            ;
      MO20D = Rhomo2 '*' Vtotal                          ;
      MO2MD = 'SOMT' (Diag '*' rxt.'TIC'.'RO2')          ;
 'FINSI'                                                 ;
 'SI' TBT.'TN2'                                          ;
      Rhomn2   = 'EXTR' (tic.'Rhomn2')    ndl            ;
      MN20D = Rhomn2 '*' Vtotal                          ;
      MN2MD = 'SOMT' (Diag '*' rxt.'TIC'.'RN2')          ;
 'FINSI'                                                 ;
 'SI' TBT.'TCO'                                          ;
      Rhomco   = 'EXTR' (tic.'Rhomco')    ndl            ;
      MCO0D = Rhomco '*' Vtotal                          ;
      MCOMD = 'SOMT' (Diag '*' rxt.'TIC'.'RCO')          ;
 'FINSI'                                                 ;
 'SI' TBT.'TCO2'                                         ;
      Rhomco2   = 'EXTR' (tic.'Rhomco2')    ndl          ;
      MCO20D = Rhomco2 '*' Vtotal                        ;
      MCO2MD = 'SOMT' (Diag '*' rxt.'TIC'.'RCO2')        ;
 'FINSI'                                                 ;
 'SI' TBT.'TAIR'                                         ;
      Rhomair   = 'EXTR' (tic.'Rhomair')    ndl          ;
      MAIR0D = Rhomair '*' Vtotal                        ;
      MAIRMD = 'SOMT' (Diag '*' rxt.'TIC'.'RAIR')        ;
 'FINSI'                                                 ;

*---- Bilan energie

 Remn   = 'EXTR' (tic.'Remn')    ndl                     ;
 E0D = Remn                                              ;
 'SI' ( 'EGA' ndl 1 )                                    ;
 Cvm     = 'EXTR' (tic.'Cvm')      ndl                   ;
 'SINON'                                                 ;
 Cvm     = 'EXTR' (tic.'Cvm')     (ndl-1)                ;
 'FINSI'                                                 ;
 EMD = ( 'SOMT' (Diag '*' Cvm '*' rxt.'TIC'.'RHO' '*'
       (rxt.'TIC'.'TF' '+' 273.15)) ) '/' Vtotal         ;
 'MESS' ' Masse   (Kg)  ' M0D '_______' MMD '________'
       (100. '*'(M0D '-' MMD) '/'M0D)                    ;
 'MESS' ' Energie (J/m3)' E0D '_______' EMD '________'
       (100. '*' (E0D '-' EMD) '/' E0D)                  ;
 'SI' (TBT.'VAPEUR' 'ET' ('NON' ('EGA' MV0D 0.0)))       ;
 'MESS' ' M Vapeur(Kg)  ' MV0D '_______' MVMD '_______'
       (100. '*' (MV0D '-' MVMD) '/' MV0D)               ;
 'FINSI'                                                 ;
 'SI' (TBT.'THE' 'ET' ('NON' ('EGA' MHE0D 0.0)))         ;
 'MESS' ' M Helium (Kg)  ' MHE0D '_______' MHEMD '_______'
       (100. '*' (MHE0D '-' MHEMD) '/' MHE0D)            ;
 'FINSI'                                                 ;
 'SI' (TBT.'TH2' 'ET' ('NON' ('EGA' MH20D 0.0)))         ;
 'MESS' ' M Hydrogene (Kg)  ' MH20D '_______' MH2MD '_______'
       (100. '*' (MH20D '-' MH2MD) '/' MH20D)            ;
 'FINSI'                                                 ;
 'SI' (TBT.'TO2' 'ET' ('NON' ('EGA' MO20D 0.0)))         ;
 'MESS' ' M Oxygene (Kg)  ' MO20D '_______' MO2MD '_______'
       (100. '*' (MO20D '-' MO2MD) '/' MO20D)            ;
 'FINSI'                                                 ;
 'SI' (TBT.'TN2' 'ET' ('NON' ('EGA' MN20D 0.0)))         ;
 'MESS' ' M Azote (Kg)  ' MN20D '_______' MN2MD '_______'
       (100. '*' (MN20D '-' MN2MD) '/' MN20D)            ;
 'FINSI'                                                 ;
 'SI' (TBT.'TCO' 'ET' ('NON' ('EGA' MCO0D 0.0)))         ;
 'MESS' ' M CO (Kg)  ' MCO0D '_______' MCOMD '_______'
       (100. '*' (MCO0D '-' MCOMD) '/' MCO0D)            ;
 'FINSI'                                                 ;
 'SI' (TBT.'TCO2' 'ET' ('NON' ('EGA' MCO20D 0.0)))       ;
 'MESS' ' M CO2 (Kg)  ' MCO20D '_______' MCO2MD '_______'
       (100. '*' (MCO20D '-' MCO2MD) '/' MCO20D)         ;
 'FINSI'                                                 ;
 'SI' (TBT.'TAIR' 'ET' ('NON' ('EGA' MAIR0D 0.0)))       ;
 'MESS' ' M AIR (Kg)  ' MAIR0D '_______' MAIRMD '_______'
       (100. '*' (MAIR0D '-' MAIRMD) '/' MAIR0D)         ;
 'FINSI'                                                 ;
 'MESS' '_____________________________________________'
        '________________'                               ;
 'SI' TBT.'THERMP'                                       ;
      Emurn  = 'EXTR' (tic.'Emur')    ndl                ;
     'MESS' ' Energie Stockée Mur (J) ' Emurn            ;
 'MESS' '_____________________________________________'
        '________________'                               ;
 'FINSI'                                                 ;

'MESS' ' *** Divers **** '                               ;

'MESS' ' Dimension espace: ' idim                        ;
'MESS' ' Nombre d elements/noeuds ' ('NBEL' vtf)
                                    ('NBNO' vtf)         ;

'MESS' '***********************************************' ;

*======================================================================;
*TABLE INCO
*        Indice                          Objet
*     Type    Valeur                  Type   Valeur
*MOT       SOUSTYPE              MOT       INCO
*MOT       LTPS                  LISTREEL   2187011
*MOT       DT                    FLOTTANT   0.30000000E+01
*MOT       Tps                   FLOTTANT   0.60000000E+03
*MOT       NUPADT                ENTIER         200
*MOT       DSRC                  FLOTTANT   0.28350992E-02
*MOT       STF                   FLOTTANT   0.20968527E+00
*MOT       NUm                   FLOTTANT   0.99636704E-05
*
*MOT       drho                  LISTREEL   2201788
*MOT       MdTf                  LISTREEL   2200717
*MOT       mdTf                  LISTREEL   2200703
*MOT       Mdrvap                LISTREEL   2210335
*MOT       Mdrair                LISTREEL   2201151
*MOT       LMAXU                 LISTREEL   2189678
*
*Grandeurs moyennes
* Températures
*MOT       Tfm                   LISTREEL   Température moyenne fluide
*MOT       Tpm                   LISTREEL   Température moyenne paroi
* Densités
*MOT       Rhomn                 LISTREEL   densité moyenne mélange
*MOT       Rhomv                 LISTREEL   densité moyenne vapeur
*MOT       Rhomhe                LISTREEL   densité moyenne hélium
*MOT       Rhomh2                LISTREEL   densité moyenne hydrogène
*MOT       Rhomo2                LISTREEL   densité moyenne oxygène
*MOT       Rhomn2                LISTREEL   densité moyenne azote
*MOT       Rhomco                LISTREEL   densité moyenne CO
*MOT       Rhomco2               LISTREEL   densité moyenne CO2
*MOT       Rhomair               LISTREEL   densité moyenne air
*MOT       Rhomvg      LISTREEL  densité moyenne vapeur + goutte
*MOT       Rliqm                 LISTREEL   2204763
*MOT       Rbrom                 LISTREEL   2204658
*
*MOT       Remn                  LISTREEL   densité moyenne d'énergie
*
*MOT       Rgpm        LISTREEL   Constante gaz parfait mélange (moyen)
*MOT       Cvm                   LISTREEL   Cv mélange
*MOT       Gamm                  LISTREEL   Gamma moyen
*MOT       Cpm                   LISTREEL   Cp mélange
*
*MOT       PT                    LISTREEL   Pression thermodynamique
*MOT       dPdt                  LISTREEL   DP/Dt
*
*MOT       Qc                    LISTREEL   Débit condensation
*MOT       Qcw                   LISTREEL   Débit condensation parois
*MOT       Qc1                   LISTREEL   Débit condensation TIMP1
*MOT       Qc2                   LISTREEL   Débit condensation TIMP2
*MOT       Qc3                   LISTREEL   Débit condensation TIMP3
*MOT       Qc0                   LISTREEL
*MOT       Qcm                   LISTREEL   Débit condensation en masse
*MOT       Mcond                 LISTREEL   Masse condensée (totale?)
*MOT       Mcondw                LISTREEL   Masse condensée parois
*MOT       Mcond1                LISTREEL   Masse condensée TIMP1
*MOT       Mcond2                LISTREEL   Masse condensée TIMP2
*MOT       Mcond3                LISTREEL   Masse condensée TIMP3
*MOT       Mcondm                LISTREEL   masse condensée en masse
*MOT       Mrest                 LISTREEL   Masse restante
*MOT       Mliqpuis              LISTREEL   2210111
*MOT       Minj                  LISTREEL   Masse injectée
*MOT       Econd                 LISTREEL   2189580
*MOT       Hcond                 LISTREEL   2189566
*MOT       Econv                 LISTREEL   2199149
*MOT       Hliqpuis              LISTREEL   2173844
*
*MOT       lmatf                 LISTREEL   2182209
*MOT       lmitf                 LISTREEL   2182272
*
*MOT       Easpe                 LISTREEL   2196321
*MOT       Haspe                 LISTREEL   2196384
*MOT       Qaspe                 LISTREEL   2196398
*======================================================================;

*======================================================================;
* Qc cumul débit de condensation en paroi        -> tic.'Qc'
 Qc    = 0.0                                             ;
* Remn densité moyenne d'énergie dans le volume  -> tic.'Remn'
* Rhomn densité moyenne dans le volume pdt N     -> tic.'Rhomn'

* dr   Cumul des incréments d'énergie
* Qtot Cumul des incréments d'injection/soustraction
* Qtot          = Qtot '+' Qasp '-' Qcnm ;
* Rhomn = MAXI (PROG (Rhomnm '+' (tic.'DT' '*' Qtot '/' VTotal )) 0.0)  ;

 Econv = 0.0                                             ;
 Econd = 0.0                                             ;
 Hcond = 0.0                                             ;
 Rgp = tic.'Rgp'                                         ;

 dRhov  = 0.                                             ;
 dRhohe = 0.                                             ;
 dRhoh2 = 0.                                             ;
 dRhoo2 = 0.                                             ;
 dRhon2 = 0.                                             ;
 dRhoco = 0.                                             ;
 dRhoco2= 0.                                             ;

*----------------------------------------------------------
*----- BOUCLE PRINCIPALE DE RESOLUTION SUR LE NB ----------
*----- TOTAL DE PAS DE TEMPS A REALISER -------------------
*----------------------------------------------------------

  Si (NON (EXIST tic 'DT'))                              ;
  tic.'DT'   = rxt.'DT0'                                 ;
  Finsi                                                  ;

*>1 'REPETER' BCLTPS nbit
 'REPETER' BCLTPS nbit                                                 ;
mess ' VERIF DEBUT BCLTPS ' &BCLTPS ' Rhomn=' Rhomn ' Remn=' Remn      ;
mess ' VERIF DEBUT BCLTPS ' &BCLTPS ' Rhomn=' Rhomn ' Remn=' Remn      ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
mess ' VERIF '                                                         ;
Tf  = tic.'TF'                                                         ;
Rho = tic.'RHO'                                                        ;
Masi=somt (Diag * Rho)                                                 ;
Eini=somt (Diag * Rho * (Tf + 273.15)* cvm)                            ;
mess ' VERIF DEBUT PDT'                                                ;
mess ' VERIF DEBUT PDT: Masi =' Masi  ' Eini ' Eini ' cvm=' cvm        ;
mess ' VERIF DEBUT PDT: Rhomn=' Rhomn ' Masi/V=' (Masi/Vtotal)         ;
mess ' VERIF DEBUT PDT: Remn =' Remn  ' Eini/V=' (Eini/Vtotal)         ;
mess ' VERIF DEBUT PDT'                                                ;

*? Rhomn = MAXI (PROG (Rhomnm '+' (tic.'DT' '*' Qtot '/' VTotal )) 0.0)  ;
*? Remn  = MAXI (PROG (Remnm  '+' (tic.'DT' '*' dr '/' VTotal )  ) 0.0)  ;
*? tic.'Rhomn'  = tic.'Rhomn'  'ET' ('PROG' Rhomn)                       ;
*? tic.'Remn'  = tic.'Remn'  'ET' ('PROG' Remn)                          ;
*? Remnt = Cvmn '*' ( 'SOMT' (Diag '*' rho '*'
*?                (Tf '+' 273.15)) ) '/' Vtotal            ;
*? Remn  = (Somt(Diag * Rho * cvm * (Tf+273.15))) '/' VTotal             ;










* Gestion de la frequence de preconditionnement
 'SI' ('OU' ('EGA' &BCLTPS 1)
            ('MULT' &BCLTPS RXT.'FRPREC')) ;
   calprec = VRAI ;
 'SINON' ;
   calprec = FAUX ;
 'FINSI' ;

 'SI' ('EGA' nbit 0)                                     ;
      'QUITTER' BCLTPS                                   ;
 'FINSI'                                                 ;

 nupadt = tic.'NUPADT'                                   ;
 nupadt = nupadt '+' 1                                   ;
 tic.'NUPADT' = nupadt                                   ;
*>1 ndl   = 'DIME' (tic.'LTPS')
 ndl   = 'DIME' (tic.'LTPS')                             ;

 Tps='EXTR' (tic.'LTPS') ndl                             ;

 Tps        = tic.'Tps' '+' tic.'DT'                     ;
 tic.'Tps'  = Tps                                        ;
 tic.'LTPS' = tic.'LTPS' 'ET' ('PROG' Tps )              ;

 'SI' ( TBT.'IMPR' >EG 1)                                             ;
 'MESS' '*************************************************************'
        '***********************';
 'MESS' '*************************************************************'
        '***********************';
 'MESS' '==> Pas de temps ' nupadt
       ' Temps = ' tps 'Secondes     Pas de temps : DT= ' tic.'DT'    ;
 'FINSI'                                                              ;










*Breches entrées/sortie ===============================================;
*=============================================================
*BRECHES et SORTIES: pour chacune des sorties (BROCHE) et
* chacune des breches (BRUCHE)  => KAS1
* En entrée:  KAS2 1 rxt
*  KAS2: type de sortie
*  i   : numéro breche si i>3 nouvelle syntaxe, voir notice execrxt
*  rxt : table rxt
* En sortie: qeau qlj qair qhe qh2 qo2 qn2 qco qco2;
* différents débits (masse)
* vapeur, liquide et incondensables ...
*=============================================================
**** Initialisations en début de bas de temps ****************

**** Evolution de la source en fct du temps ******************
******** Scenario transitoire ********************************

 Ksi=1. ; Ksi2=1. ; Ksi3=1. ;
 Qlj=0. ; Qlj2=0. ; Qlj3=0. ;
 Qo='Qo'; Qlo='Qlo';
 Qovp=0.; Qlovp=0.;
 Qohe=0.;
 Qoh2=0.;
 Qon2=0.;
 Qoo2=0.;
 Qoco=0.;
 Qoco2=0.;

  Si (TBT.'TTsortie')                                                  ;
     NBR=dime rxt.'Sorties'                                            ;
     ibr=index (rxt.'Sorties')                                         ;
    Repeter BBRS NBR                                                   ;
mess ' VERIF BROCHE KAS1 '                                             ;
qeau qlj qair qhe qh2 qo2 qn2 qco qco2=broche 'KAS1' &BBRS rxt         ;

 Qovp=Qovp + Qeau; Qlovp=Qlovp + Qlj                                   ;
 Qohe=Qohe + Qhe                                                       ;
 Qoh2=Qoh2 + Qh2                                                       ;
 Qon2=Qon2 + Qn2                                                       ;
 Qoo2=Qoo2 + Qo2                                                       ;
 Qoco=Qoco + Qco                                                       ;
 Qoco2=Qoco2 + Qco2                                                    ;
    FIN BBRS                                                           ;
  FINSI                                                                ;

  Si (TBT.'TTbreche')                                                  ;
     NBR=dime rxt.'Breches'                                            ;
     ibr=index (rxt.'Breches')                                         ;
    Repeter BBRS NBR                                                   ;
*    mess ' Bruche KAS1 :  Breche  ' (ibr.&BBRS)                       ;
mess ' VERIF BRUCHE KAS1 '                                             ;
qeau qlj qair qhe qh2 qo2 qn2 qco qco2=bruche 'KAS1' (&BBRS + 3) rxt   ;
 Qovp=Qovp + Qeau; Qlovp=Qlovp + Qlj ;                                 ;
 Qohe=Qohe + Qhe ;                                                     ;
 Qoh2=Qoh2 + Qh2 ;                                                     ;
 Qon2=Qon2 + Qn2 ;                                                     ;
 Qoo2=Qoo2 + Qo2 ;                                                     ;
 Qoco=Qoco + Qco ;                                                     ;
 Qoco2=Qoco2 + Qco2 ;                                                  ;
    FIN BBRS                                                           ;
  FINSI                                                                ;

 Si (TBT.'Tbreche') ;
mess ' VERIF BRUCHE KAS1 -1 '                                          ;
 qeau qlj qair qhe qh2 qo2 qn2 qco qco2 =  bruche 'KAS1' 1 rxt     ;
 Qovp=Qovp + Qeau ; Qlovp=Qlovp + Qlj  ;
 Qohe=Qohe + Qhe ;
 Qoh2=Qoh2 + Qh2 ;
 Qon2=Qon2 + Qn2 ;
 Qoo2=Qoo2 + Qo2 ;
 Qoco=Qoco + Qco ;
 Qoco2=Qoco2 + Qco2 ;
 Finsi                                                             ;

 Si (TBT.'Tbreche2') ;
mess ' VERIF BRUCHE KAS1 -2 '                                          ;
 qeau2 qlj2 qair2 qhe2 qh22 qo22 qn22 q2co q2co2 = bruche 'KAS1' 2 rxt;
 Qovp=Qovp + Qeau2; Qlovp=Qlovp + Qlj2 ;
 Qohe=Qohe + Qhe2;
 Qoh2=Qoh2 + Qh22;
 Qon2=Qon2 + Qn22;
 Qoo2=Qoo2 + Qo22;
 Qoco=Qoco + Q2co;
 Qoco2=Qoco2 + Q2co2;
 Finsi;

 Si (TBT.'Tbreche3') ;
mess ' VERIF BRUCHE KAS1 -3 '                                          ;
 qeau3 qlj3 qair3 qhe3 qh23 qo23 qn23 q3co q3co2 = bruche 'KAS1' 3 rxt;
 Qovp=Qovp + Qeau3; Qlovp=Qlovp + Qlj3 ;
 Qohe=Qohe + Qhe3;
 Qoh2=Qoh2 + Qh23;
 Qon2=Qon2 + Qn23;
 Qoo2=Qoo2 + Qo23;
 Qoco=Qoco + Q3co;
 Qoco2=Qoco2 + Q3co2;
 Finsi;


*--------------------------------------------------------------
* Interpolation des conditions aux limites en température
* imposée sur une ou plusieurs parois et chargement coef d'échange
* TTIMP  -> rxt.'TIMP'.'TIMPI'
* TTIMP1 -> tic.'TBP1' etc

* XFIMP 2 : Flux de chaleur imposés  (exec RTF)
'SI' TBT.'TFIMP'                                             ;
   NBFIMP=dime (rxt.'XFIMP')                                 ;
   ifimp=INDEX (rxt.'XFIMP')                                 ;
  REPETER BBFIMP NBFIMP                                      ;
   Bfimp=rxt.'XFIMP'.(ifimp.&BBFIMP)                         ;
* Petites initialisations
  Smfpi=Bfimp.'Smfpi'                                        ;

  CKqt=Bfimp.'Kqt'                                           ;
  qft ='IPOL' tps (Bfimp.'t') (Bfimp.'qt')                   ;
  tic.CKqt =qft/Smfpi                                        ;

  CKqeau=Bfimp.'Kqeau'                                       ;
  qfeau ='IPOL' tps (Bfimp.'t') (Bfimp.'qeau')               ;
  tic.CKqeau =qfeau/Smfpi                                    ;

  CKqair=Bfimp.'Kqair'                                       ;
  qfair ='IPOL' tps (Bfimp.'t') (Bfimp.'qair')               ;
  tic.CKqair =qfair/Smfpi                                    ;

  CKqhe=Bfimp.'Kqhe'                                         ;
  qfhe ='IPOL' tps (Bfimp.'t') (Bfimp.'qhe')                 ;
  tic.CKqhe =qfhe/Smfpi                                      ;

  CKqh2=Bfimp.'Kqh2'                                         ;
  qfh2 ='IPOL' tps (Bfimp.'t') (Bfimp.'qh2')                 ;
  tic.CKqh2 =qfh2/Smfpi                                      ;

  CKqn2=Bfimp.'Kqn2'                                         ;
  qfn2 ='IPOL' tps (Bfimp.'t') (Bfimp.'qn2')                 ;
  tic.CKqn2 =qfn2/Smfpi                                      ;

  CKqo2=Bfimp.'Kqo2'                                         ;
  qfo2 ='IPOL' tps (Bfimp.'t') (Bfimp.'qo2')                 ;
  tic.CKqo2 =qfo2/Smfpi                                      ;

  CKqco=Bfimp.'Kqco'                                         ;
  qfco ='IPOL' tps (Bfimp.'t') (Bfimp.'qco')                 ;
  tic.CKqco =qfco/Smfpi                                      ;

  CKqco2=Bfimp.'Kqco2'                                       ;
  qfco2 ='IPOL' tps (Bfimp.'t') (Bfimp.'qco2')               ;
  tic.CKqco2 =qfco2/Smfpi                                    ;

  Qovp=Qovp + Qfeau                                          ;
  Qohe=Qohe + Qfhe                                           ;
  Qoh2=Qoh2 + Qfh2                                           ;
  Qon2=Qon2 + Qfn2                                           ;
  Qoo2=Qoo2 + Qfo2                                           ;
  Qoco=Qoco + Qfco                                           ;
  Qoco2=Qoco2 + Qfco2                                        ;

**Si  (NON ((TBT.'VAPEUR') et (exist tic CKH1)))             ;
**tic.CKH1  = (Btimp.'ECHAN')                                ;
**Finsi                                                      ;
**Bfimp.'Ltbpi'= Bfimp.'Ltbpi' et (prog tic.(Bfimp.'TBP1'))  ;
  FIN BBFIMP                                                 ;
'FINSI'                                                      ;
* XFIMP 2 : Flux de chaleur imposés  (exec RTF)

'SI' TBT.'TTIMP'                                             ;
   NBTIMP=dime (rxt.'TIMP')                                  ;
   itimp=INDEX (rxt.'TIMP')                                  ;
  REPETER BBTIMP NBTIMP                                      ;
* mess 'BBTIMP 2 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                          ;
* Petites initialisations
  CTBP1=Btimp.'TBP1'                                         ;
  CKH1=Btimp.'KH1'                                           ;
  tic.CTBP1 = 'IPOL' tps (Btimp.'t') (Btimp.'TIMP')          ;
  Si  (NON ((TBT.'VAPEUR') et (exist tic CKH1)))             ;
  tic.CKH1  = (Btimp.'ECHAN')                                ;
  Finsi                                                      ;
  Btimp.'Ltbpi'= Btimp.'Ltbpi' et (prog tic.(Btimp.'TBP1'))  ;
  FIN BBTIMP                                                 ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP1'                                            ;
  tic.'TBP1' = 'IPOL' tps (rxt.'TIMP1'.'t') (rxt.'TIMP1'.'TIMP');
  Si  (NON ((TBT.'VAPEUR') et (exist tic 'KH1')))            ;
  tic.'KH1'  = (rxt.'TIMP1'.'ECHAN')                         ;
  Finsi                                                      ;
  tic.'Ltbp1'= tic.'Ltbp1' et (prog (tic.'TBP1'))            ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP2'                                            ;
  tic.'TBP2' = 'IPOL' tps (rxt.'TIMP2'.'t') (rxt.'TIMP2'.'TIMP');
  Si  (NON ((TBT.'VAPEUR') et (exist tic 'KH2')))            ;
  tic.'KH2'  = (rxt.'TIMP2'.'ECHAN')                         ;
  Finsi                                                      ;
  tic.'Ltbp2'= tic.'Ltbp2' et (prog (tic.'TBP2'))            ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP3'                                            ;
  tic.'TBP3' = 'IPOL' tps (rxt.'TIMP3'.'t') (rxt.'TIMP3'.'TIMP');
  Si  (NON ((TBT.'VAPEUR') et (exist tic 'KH3')))            ;
  tic.'KH3'  = (rxt.'TIMP3'.'ECHAN')                         ;
  Finsi                                                      ;
  tic.'Ltbp3'= tic.'Ltbp3' et (prog (tic.'TBP3'))            ;
'FINSI'                                                      ;

'SI' TBT.'TECHANP'                                           ;
  'SI' ('NON' ('EXIST' TIC 'TBP0'))                          ;
  tic.'TBP0' = 'KCHT' RXT.'GEO'.'$mtp0' 'SCAL' 'SOMMET'
                                         rxt.'ECHANP'.'TMUR' ;
  'FINSI' ;
  Si  (NON ((TBT.'VAPEUR') et (exist tic 'KH0')))            ;
  tic.'KH0'  = 'KCHT' RXT.'GEO'.'$mtp0' 'SCAL' 'CENTRE'
                                        rxt.'ECHANP'.'ECHAN' ;
  Finsi                                                      ;
'FINSI'                                                      ;

*--------------------------------------------------------------
* Traitement de l'aspersion

'SI' TBT.'ASPER '                                            ;
   t       =  rxt.'scenasp'.'t'                             ;
   vzinj   = 'IPOL' tps t (rxt.'scenasp'.'vzinj')           ;
   xdinj   = 'IPOL' tps t (rxt.'scenasp'.'xdinj')           ;
   tdinj   = 'IPOL' tps t (rxt.'scenasp'.'tdinj')           ;
   ddinj   = 'IPOL' tps t (rxt.'scenasp'.'ddinj')           ;
   $aspinj = GEO.'$aspinj'                                   ;
   $toitf  = GEO.'$toitf'                                    ;
*   vnj     = 'KCHT' $aspinj 'VECT' 'SOMMET' 'COMP'
*                        ('MOTS' 1VN 2VN 3VN) (0.0 0.0 vzinj) ;

      'SI' (DIM3D) ;
   vnj     = 'KCHT' $aspinj 'VECT' 'SOMMET' 'COMP'
                        ('MOTS' 1VN 2VN 3VN) (0.0 0.0 vzinj) ;
   'SINON' ;
*--------------------------------------------------------------
*                    modif Tojo 12/07/2007                    *
*
*   mise en place de vecteurs inclinés conformément
*   à l'angle d'ouverture du jet
*   ici l'inclinaison est fixée à 30°
*   une prochaine évolution pourrait consister à mettre
*   l'angle d'ouverture comme donnée d'entrée
*   dans la table scenasp
*
*--------------------------------------------------------------
*
cc1 = coor 1 rxt.'aspinj'                                     ;
z0 = (sin(300. '*' cc1)) '*' ((cos(300. '*' cc1)) '**' (-1.0));
z0 = z0 '*' (vzinj '*' -1.)                                   ;
z0 = chan attribut z0 nature diffus                           ;
z1 = z0 '*' 0.                                                ;
ux0 = nomc '1VN' z0                                           ;
z1 = z1 '+' vzinj                                             ;
z1 = chan attribut z1 nature diffus                           ;
uy0 = nomc '2VN' z1                                           ;
vnj1 = ux0 et uy0                                             ;
vnj  = 'KCHT' $aspinj 'VECT' 'SOMMET' 'COMP'
('MOTS' '1VN' '2VN') vnj1                                     ;
*
*--------------------------------------------------------------
   'FINSI' ;
*--------------------fin modif Tojo Juillet 2007---------------

   xdj     = 'KCHT' $aspinj 'SCAL' 'SOMMET' 'COMP'
                         ('MOT'  'XD') xdinj                 ;
   tdj     = 'KCHT' $aspinj 'SCAL' 'SOMMET' 'COMP'
                         ('MOT'  'TD') tdinj                 ;
   ddj     = 'KCHT' $toitf  'SCAL' 'SOMMET' 'COMP'
                         ('MOT'  'DD') ddinj                 ;
'FINSI'                                                      ;

*--------------------------------------------------------------
*>1**********************************************************
*>1* Grandeurs moyennes au debut du pas de temps N **********
*>1* i.e. au temps N-1 **************************************

  Ptnm    = 'EXTR' (tic.'PT')    ndl                         ;
  mess 'VERIF PTnm au pdt N-1, Ptnm=' Ptnm                   ;
  dPdtnm  = 'EXTR' (tic.'dPdt')  ndl                         ;
  Rgpmnm  = 'EXTR' (tic.'Rgpm')  ndl                         ;
  Cvmnm   = 'EXTR' (tic.'Cvm')   ndl                         ;
  Gamnm   = 'EXTR' (tic.'Gamm')  ndl                         ;
  Cpmnm   = 'EXTR' (tic.'Cpm')   ndl                         ;
  Rhomnm  = 'EXTR' (tic.'Rhomn')  ndl                        ;
  mess 'VERIF propriété physiques au pdt N-1, cpmnm,cvmnm,gamnm=' cpmnm
  cvmnm gamnm                                                          ;
  Rhomvn  = 0.                                               ;
  Rhovgn  = 0.                                               ;
  Rbrom   = 0.                                               ;
  Rmhen   = 0.                                               ;
  Rmh2n   = 0.                                               ;
  Rmn2n   = 0.                                               ;
  Rmo2n   = 0.                                               ;
  Rmcon   = 0.                                               ;
  Rmco2n  = 0.                                               ;
  Rmairn  = 0.                                               ;

  'SI' TBT.'VAPEUR'                                          ;
*>1 Rhomvnm,Rhovgnm,Rliqm = EXTR tic.'Rhomv','Rhomvg','Rliqm' ndl
  Rhomvnm = 'EXTR' (tic.'Rhomv')  ndl                        ;
  Rhovgnm = 'EXTR' (tic.'Rhomvg') ndl                        ;
   'SI' TBT.'CONDMAS'                                        ;
    Rliqm   = 'EXTR' (tic.'Rliqm')  ndl                      ;
    Rbrom   = 'EXTR' (tic.'Rbrom')  ndl                      ;
   'FINSI'                                                   ;
  'FINSI'                                                    ;
  'SI' TBT.'THE'                                             ;
  Rmhenm  = 'EXTR' (tic.'Rhomhe') ndl                        ;
  'FINSI'                                                    ;
  'SI' TBT.'TH2'                                             ;
  Rmh2nm  = 'EXTR' (tic.'Rhomh2') ndl                        ;
  'FINSI'                                                    ;
  'SI' TBT.'TO2'                                             ;
  Rmo2nm  = 'EXTR' (tic.'Rhomo2') ndl                        ;
  'FINSI'                                                    ;
  'SI' TBT.'TN2'                                             ;
  Rmn2nm  = 'EXTR' (tic.'Rhomn2') ndl                        ;
  'FINSI'                                                    ;
  'SI' TBT.'TCO'                                             ;
  Rmconm  = 'EXTR' (tic.'Rhomco') ndl                        ;
  'FINSI'                                                    ;
  'SI' TBT.'TCO2'                                            ;
  Rmco2nm  = 'EXTR' (tic.'Rhomco2') ndl                      ;
  'FINSI'                                                    ;

  Rmairnm  = 'EXTR' (tic.'Rhomair') ndl                      ;
  Remnm   = 'EXTR' (tic.'Remn')  ndl                         ;
  'SI' TBT.'THERMP'                                          ;
  Emurnm  = 'EXTR' (tic.'Emur')  ndl                         ;
  'FINSI'                                                    ;
  'SI' TBT.'ASPER '                                          ;
       Qasp    = extr (tic.'Qaspe') ndl                      ;
       Easp    = extr (tic.'Easpe') ndl                      ;
       Hasp    = extr (tic.'Haspe') ndl                      ;
  'SINON'                                                    ;
       Qasp    = 0.0                                         ;
       Easp    = 0.0                                         ;
       Hasp    = 0.0                                         ;
  'FINSI'                                                    ;

  Qcnm    = 'EXTR' (tic.'Qc')    ndl                         ;
  Econdnm = 'EXTR' (tic.'Econd') ndl                         ;
  Econvnm = 'EXTR' (tic.'Econv') ndl                         ;
  Hcondnm = 'EXTR' (tic.'Hcond') ndl                         ;
  MinjT   = 'EXTR' (tic.'Minj')  ndl                         ;
  McondT  = 'EXTR' (tic.'Mcond') ndl                         ;

  'SI' (TBT.'VAPEUR')                                        ;
    'SI' (TBT.'VERSION' '>EG' 0)                             ;
      'SI' (EXIST TIC 'Mcondm')                              ;
        Mcondm  = 'EXTR' (tic.'Mcondm') ndl                  ;
      'SINON'                                                ;
        tic.'Mcondm' = 'PROG' 0.0                            ;
        Mcondm       = 0.0                                   ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qcm'))                           ;
        tic.'Qcm'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;

    'SI' (TBT.'TPAROIF')                                     ;
      'SI' (EXIST TIC 'Mcondw')                              ;
        McondTw = 'EXTR' (tic.'Mcondw') ndl                  ;
      'SINON'                                                ;
        tic.'Mcondw' = 'PROG' 0.0                            ;
        McondTw      = 0.0                                   ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qcw'))                           ;
        tic.'Qcw'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;
    'SI' (TBT.'TTIMP')                                       ;
       NBTIMP=dime (rxt.'TIMP')                              ;
       itimp=INDEX (rxt.'TIMP')                              ;
      REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 3 ';
       Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
      CQc1=Btimp.'Qc1'                                       ;
      'SI' (NON (EXIST TIC CQc1))                            ;
        tic.CQc1    = 'PROG' 0.0                             ;
      'FINSI'                                                ;
      CMcond1=Btimp.'Mcond1'                                 ;
      'SI' (EXIST tic.CMcond1)                               ;
        McondT1 = 'EXTR' (tic.CMcond1) ndl                   ;
      'SINON'                                                ;
        tic.CMcond1  = 'PROG' 0.0                            ;
        McondT1      = 0.0                                   ;
      'FINSI'                                                ;
      FIN BBTIMP                                             ;
    'FINSI'                                                  ;
    'SI' (TBT.'TTIMP1')                                      ;
      'SI' (EXIST TIC 'Mcond1')                              ;
        McondT1 = 'EXTR' (tic.'Mcond1') ndl                  ;
      'SINON'                                                ;
        tic.'Mcond1' = 'PROG' 0.0                            ;
        McondT1      = 0.0                                   ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qc1'))                           ;
        tic.'Qc1'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;
    'SI' (TBT.'TTIMP2')                                      ;
      'SI' (EXIST TIC 'Mcond2')                              ;
        McondT2 = 'EXTR' (tic.'Mcond2') ndl                  ;
      'SINON'                                                ;
        tic.'Mcond2' = 'PROG' 0.0                            ;
        McondT2      = 0.0                                   ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qc2'))                           ;
        tic.'Qc2'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;
    'SI' (TBT.'TTIMP3')                                      ;
      'SI' (EXIST TIC 'Mcond3')                              ;
        McondT3 = 'EXTR' (tic.'Mcond3') ndl                  ;
      'SINON'                                                ;
       tic.'Mcond3' = 'PROG' 0.0                             ;
       McondT3      = 0.0                                    ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qc3'))                           ;
        tic.'Qc3'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;
    'SI' (TBT.'TECHANP')                                     ;
      'SI' (EXIST TIC 'Mcond0')                              ;
        McondT0 = 'EXTR' (tic.'Mcond0') ndl                  ;
      'SINON'                                                ;
       tic.'Mcond0' = 'PROG' 0.0                             ;
       McondT0      = 0.0                                    ;
      'FINSI'                                                ;
      'SI' (NON (EXIST TIC 'Qc0'))                           ;
        tic.'Qc0'   = 'PROG' 0.0                             ;
      'FINSI'                                                ;
    'FINSI'                                                  ;
  'FINSI'                                                    ;
  MrestT  = 'EXTR' (tic.'Mrest') ndl                         ;

*-------------------------------------------------------------
* Calcul KH/Ro Cp pour l'équation en température TF

 'SI' TBT.'THERMP'                                           ;
  tic.'KHEW'=tic.'KHW' /  (Rhomnm '*' Cpmnm)                 ;
  tic.'LHEW' = -1.0 * tic.'KHEW'                             ;
 'FINSI'                                                     ;

'SI' TBT.'TTIMP'                                             ;
   NBTIMP=dime (rxt.'TIMP')                                  ;
   itimp=INDEX (rxt.'TIMP')                                  ;
  REPETER BBTIMP NBTIMP                                      ;
* mess 'BBTIMP 4 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                          ;
   CKHE1=Btimp.'KHE1'                                        ;
   CKH1 =Btimp.'KH1'                                         ;
   tic.CKHE1   = tic.CKH1 '/' (Rhomnm '*' Cpmnm)             ;
  FIN BBTIMP                                                 ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP1'                                            ;
   CKHE1='KHE1'                                              ;
   CKH1 ='KH1'                                               ;
     tic.CKHE1  = (tic.CKH1) '/' (Rhomnm '*' Cpmnm)          ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP2'                                            ;
     tic.'KHE2'  = (tic.'KH2') '/' (Rhomnm '*' Cpmnm)        ;
'FINSI'                                                      ;

'SI' TBT.'TTIMP3'                                            ;
     tic.'KHE3'  = (tic.'KH3') '/' (Rhomnm '*' Cpmnm)        ;
'FINSI'                                                      ;

'SI' TBT.'TECHANP'                                           ;
     tic.'KHE0'  = (tic.'KH0') '/' (Rhomnm '*' Cpmnm)        ;
'FINSI'                                                      ;











*=============================================================
*BRECHES et SORTIES: pour chacune des sorties (BROCHE) et
* chacune des breches (BRUCHE)  => KAS2
* En entrée:  KAS2 i rxt
*  KAS2: type de sortie
*  i   : numéro breche si i>3 nouvelle syntaxe, voir notice execrxt
*  rxt : table rxt
* En sortie: Rvapj Rairj Rhej Rh2j Ro2j Rn2j Rco2j Rcoj Rgj
*     Hj Ej Tj Qj Roj gj guj unvf0 src ;
* Constantes des gaz à l'injection et constante du mélange
* Energies, Température Débit(masse) Densité etc
*=============================================================
   Qtot = 0.                                                 ;
   dr   = 0.                                                 ;
   srcs = 0.                                                 ;

  Si (TBT.'TTsortie')                                        ;
     NBR=dime rxt.'Sorties'                                  ;
     ibr=index (rxt.'Sorties')                               ;
    Repeter BBRS NBR                                         ;
mess ' VERIF BROCHE KAS2 '                                             ;
  Rvapj Rairj Rhej Rh2j Ro2j Rn2j Rco2j Rcoj Rgj Hj Ej
  Tj aex Qj Roj gj guj unvf0 src = broche 'KAS2' &BBRS rxt   ;
     asrc = (Roj '*' ('ABS' src))                            ;
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBB BBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBB BBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBB   BBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBB     BBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBB   BBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBB BBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBB BBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB';
*mess ' BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB';
   Qtot   = Qtot '+' (aex*asrc)                              ;
   dr = dr + (Qj '*' Hj '*' aex)                             ;
   srcs=srcs + (aex '*' src)                                 ;
*----------------------------------------------------------
* STOCKAGE des valeurs de l'injection pour le temps courant
* Breches &BBRS
* La brèche peut avoir eu une existence évanescente (Tbreche=FAUX)
* Si tic.'Qj' existe on complete avec des valeurs nulles
* tic.'Qj',tic.'guj',tic.'Hj',tic.'Ej'
*
  Briches=rxt.'Sorties'.(ibr.&BBRS)                          ;
 Si(Exist Briches 'Qj')                                      ;
  Briches.'guj'= Briches.'guj' 'ET' ('PROG' guj)             ;
  Briches.'Qj' = Briches.'Qj' 'ET' ('PROG' asrc)             ;
 Finsi ;
    FIN BBRS                                                 ;
  FINSI                                                      ;


  Si (TBT.'TTbreche')                                        ;
     NBR=dime rxt.'Breches'                                  ;
     ibr=index (rxt.'Breches')                               ;
    Repeter BBRS NBR                                         ;
*    mess ' Bruche KAS2 : Breche  ' (ibr.&BBRS)              ;
mess ' VERIF BRUCHE KAS2 '                                             ;
  Rvapj Rairj Rhej Rh2j Ro2j Rn2j Rco2j Rcoj Rgj Hj Ej
  Tj Qj Roj gj guj unvf0 src = bruche 'KAS2' (&BBRS + 3) rxt ;
     asrc = (Roj '*' ('ABS' src))                            ;
   Qtot   = Qtot '+' asrc                                    ;
   dr = dr + (Qj '*' Hj)                                     ;
   srcs=srcs + src                                           ;
*----------------------------------------------------------
* STOCKAGE des valeurs de l'injection pour le temps courant
* Breches &BBRS
* La brèche peut avoir eu une existence évanescente (Tbreche=FAUX)
* Si tic.'Qj' existe on complete avec des valeurs nulles
* tic.'Qj',tic.'guj',tic.'Hj',tic.'Ej'
*
  Briches=rxt.'Breches'.(ibr.&BBRS)                          ;
 Si(Exist Briches 'Qj')                                      ;
  Briches.'guj'= Briches.'guj' 'ET' ('PROG' guj)             ;
  Briches.'Qj' = Briches.'Qj' 'ET' ('PROG' asrc)             ;
 Finsi ;
    FIN BBRS                                                 ;
  FINSI                                                      ;

*=============================================================
*BRECHE
*=============================================================
  Qj   = 0. ;
  Roj  = 1.e-10 ;
  src  = 0. ;
  guj  = 0. ;
  Ej=0. ;
  Hj=0. ;
  Tj=0. ;

 Rvapj Rairj Rhej Rh2j Ro2j Rn2j Rco2j Rcoj
 = 0. 0. 0. 0. 0. 0. 0. 0.;
 Si (TBT.'Tbreche') ;
mess ' VERIF BRUCHE KAS2 -1 '                                          ;
  Rvapj Rairj Rhej Rh2j Ro2j Rn2j Rco2j Rcoj Rgj Hj Ej
  Tj Qj Roj gj guj unvf0 src = bruche 'KAS2'   1 rxt         ;
   asrc = Roj '*' ('ABS' src)                                ;
   Qtot   = Qtot '+' asrc                                    ;
   dr = dr + (Qj '*' Hj)                                     ;
 Finsi;

*----------------------------------------------------------
* STOCKAGE des valeurs de l'injection pour le temps courant
* 1ere Breche
* La brèche peut avoir eu une existance évanescente (Tbreche=FAUX)
* Si tic.'Qj' existe on complete avec des valeurs nulles
* tic.'Qj',tic.'guj',tic.'Hj',tic.'Ej'
*
 Si(Exist tic 'Qj') ;
  tic.'guj'= tic.'guj' 'ET' ('PROG' guj)                   ;
  asrc = Roj '*' ('ABS' src)                               ;
  tic.'Qj' = tic.'Qj' 'ET' ('PROG' asrc)                   ;

  tic.'Hj'= tic.'Hj' 'ET' ('PROG' Hj)                      ;
  tic.'Ej'= tic.'Ej' 'ET' ('PROG' Ej)                      ;
 Finsi ;

*=============================================================
*BRECHE 2
*=============================================================
  Qj2   = 0. ;
  Roj2  = 1.e-10 ;
  src2  = 0. ;
  guj2  = 0. ;
  Ej2=0. ;
  Hj2=0. ;
  Tj2=0. ;

 Rvapj2 Rairj2 Rhej2 Rh2j2 Ro2j2 Rn2j2 Rco2j2 Rcoj2
 = 0. 0. 0. 0. 0. 0. 0. 0.;
 Si (TBT.'Tbreche2') ;
mess ' VERIF BRUCHE KAS2 -2 '                                          ;
  Rvapj2 Rairj2 Rhej2 Rh2j2 Ro2j2 Rn2j2 Rco2j2 Rcoj2 Rgj2 Hj2 Ej2
  Tj2 Qj2 Roj2 gj2 guj2 unvf0 src2 = bruche 'KAS2'   2 rxt    ;

 asrc2 = Roj2 '*' ('ABS' src2)                                ;
 Qtot  = Qtot '+' asrc2                                       ;
 dr    = dr + (Qj2 '*' Hj2)                                   ;
 Finsi                                                        ;

*----------------------------------------------------------
* STOCKAGE des valeurs de l'injection pour le temps courant
* 2eme Breche
* La brèche peut avoir eu une existance évanescente (Tbreche2=FAUX)
* Si tic.'Qj2' existe on complete avec des valeurs nulles
* tic.'Qj2',tic.'guj2',tic.'Hj2',tic.'Ej2'
*
 Si(Exist tic 'Qj2') ;
  tic.'guj2'= tic.'guj2' 'ET' ('PROG' guj2)                   ;
  asrc2 = Roj2 '*' ('ABS' src2)                               ;
  tic.'Qj2' = tic.'Qj2' 'ET' ('PROG' asrc2)                   ;
  tic.'Hj2'= tic.'Hj2' 'ET' ('PROG' Hj2)                      ;
  tic.'Ej2'= tic.'Ej2' 'ET' ('PROG' Ej2)                      ;
 Finsi ;
*=============================================================
*BRECHE 3
*=============================================================
  Qj3   = 0. ;
  Roj3  = 1.e-10 ;
  src3 = 0.;
  guj3  = 0. ;
  Ej3=0. ;
  Hj3=0. ;
  Tj3=0. ;

 Rvapj3 Rairj3 Rhej3 Rh2j3 Ro2j3 Rn2j3 Rco2j3 Rcoj3
 = 0. 0. 0. 0. 0. 0. 0. 0.;
 Si (TBT.'Tbreche3') ;
mess ' VERIF BRUCHE KAS2 -3 '                                          ;
  Rvapj3 Rairj3 Rhej3 Rh2j3 Ro2j3 Rn2j3 Rco2j3 Rcoj3 Rgj3 Hj3 Ej3
  Tj3 Qj3 Roj3 gj3 guj3 unvf0 src3 = bruche 'KAS2'   3  rxt   ;

 asrc3 = Roj3 '*' ('ABS' src3)                                ;
 Qtot  = Qtot '+' asrc3                                       ;
 dr = dr + (Qj3 '*' Hj3)                                      ;
 Finsi                                                        ;

*----------------------------------------------------------
* STOCKAGE des valeurs de l'injection pour le temps courant
* 3ème Breche
* La brèche peut avoir eu une existance évanescente (Tbreche3=FAUX)
* Si tic.'Qj3' existe on complète avec des valeurs nulles
* tic.'Qj3',tic.'guj3',tic.'Hj3',tic.'Ej3'
*
Si(Exist tic 'Qj3') ;
 tic.'guj3'= tic.'guj3' 'ET' ('PROG' guj3)                   ;
 asrc3 = Roj3 '*' ('ABS' src3)                               ;
 tic.'Qj3' = tic.'Qj3' 'ET' ('PROG' asrc3)                   ;
 tic.'Hj3'= tic.'Hj3' 'ET' ('PROG' Hj3)                      ;
 tic.'Ej3'= tic.'Ej3' 'ET' ('PROG' Ej3)                      ;
Finsi ;
*=============================================================


'SI' TBT.'TRECOMB' ;

MDRECOMB RXT ;

'FINSI' ;











*======================================================================;
**** Avancement des grandeurs moyennes 0D pour le pas de temps N   *****
**** à partir des grandeurs OD (injection,recombineur,condensation ****
**** pour le calcul de Rhomn Remn et P                             ****
*-----------------------------------------------------------------------

*-----------------------------------------------------------------------
* On commence par cumuler les débits et l'énergie injectée
* (breches/sorties -> dr précédent) avec les contributions en masse et
* énergie des condensations en paroi. La condensation en masse n'est pas
* prise en compte à ce stade)
 Htot          = Hcondnm '-' Hasp                            ;
 Etot          = Econvnm '-' Easp                            ;
 DPDT          = dPdtnm                                      ;
**?? Si (TBT.'CORTEMP')                                          ;
**?? dr            = dr '-' Etot '-' Htot + DPDT                 ;
**?? Sinon                                                       ;
**?? dr            = dr '-' Etot '-' Htot                        ;
**?? Finsi                                                       ;

 dr            = dr '-' Etot '-' Htot                        ;

 Qtot          = Qtot '+' Qasp '-' Qcnm ;
 Mess ' Débit condensation Fin pas de temps précédent  Qcnm=' Qcnm ;

*mess ' Etot ' Etot   ' Htot ' Htot  'dr=' dr;
*mess 'Econv pour calcul de dr ' Econv;


*-----------------------------------------------------------------------
* On prend en compte ensuite la contribution d'éventuels recombineurs

'SI' TBT.'TRECOMB'                                                     ;

   NBREC = 'DIME' rxt.'RECOMB' ;
   'REPETER' BCLREC NBREC ;

   DIRNAME = 'CHAIN' 'DREC' 'ent' &BCLREC ;
   direntr = RXT.'GEO'. DIRNAME ;
   DIRNAME = 'CHAIN' 'DREC' 'sor' &BCLREC ;
   dirsort = RXT.'GEO'. DIRNAME ;

   $NAME = 'CHAIN' '$REC' 'ent' &BCLREC ;
   $ENTREE = RXT.'GEO'. $NAME ;
   $NAME = 'CHAIN' '$REC' 'sor' &BCLREC ;
   $SORTIE = RXT.'GEO'. $NAME ;

   'SI' TBT.'FPAROI' ;
      NAME = 'CHAIN' 'REC' 'ent' &BCLREC ;
      ENTREE = RXT.'GEO'.NAME ;
      NAME = 'CHAIN' 'REC' 'sor' &BCLREC ;
      SORTIE = RXT.'GEO'.NAME ;
   'SINON' ;
      NAME = 'CHAIN' 'REC' 'entI' &BCLREC ;
      ENTREE = RXT.'GEO'.NAME ;
      NAME = 'CHAIN' 'REC' 'sorI' &BCLREC ;
      SORTIE = RXT.'GEO'.NAME ;
   'FINSI' ;

   LMOT1 = 'MOTS' 1UN 2UN ;
   LMOT2 = 'MOTS' UX  UY  ;

   'SI' DIM3D;
    LMOT1 = LMOT1 'ET' ('MOTS' 3UN ) ;
    LMOT2 = LMOT2 'ET' ('MOTS' UZ  ) ;
   'FINSI' ;
   NRECT = 'DIME' RXT.'TIC'.'RECOMB'.&BCLREC.'Uin' ;
   Uin1  = 'EXTR' RXT.'TIC'.'RECOMB'.&BCLREC.'Uin'  NRECT ;
   Uout1 = 'EXTR' RXT.'TIC'.'RECOMB'.&BCLREC.'Uout' NRECT ;
   DEB1  = 'EXTR' RXT.'TIC'.'RECOMB'.&BCLREC.'DEB'  NRECT ;
   Hin1  = 'EXTR' RXT.'TIC'.'RECOMB'.&BCLREC.'Hin'  NRECT ;
   Hout1 = 'EXTR' RXT.'TIC'.'RECOMB'.&BCLREC.'Hout' NRECT ;
   toto1 = 'KCHT' $ENTREE 'VECT' 'SOMMET' 'COMP'
             LMOT1  (direntr * Uin1);
   toto1 = 'REDU' toto1 ENTREE  ;
   toto1 = 'KCHT' $ENTREE 'VECT' 'SOMMET' 'COMP'
             LMOT1  toto1;
   toto2 = 'NOMC' LMOT1 LMOT2 toto1 ;
   toto3 = 'KCHT' RXT.'GEO'.'$menvf'  'VECT' 'SOMMET'  toto2 ;
   toto3 = 'DBIT' toto3 RXT.'GEO'.'$menvf' ;

   tutu1 = 'KCHT' $SORTIE 'VECT' 'SOMMET' 'COMP'
             LMOT1  (dirsort * Uout1);
   tutu1 = 'REDU' tutu1 SORTIE  ;
   tutu1 = 'KCHT' $SORTIE 'VECT' 'SOMMET' 'COMP'
             LMOT1  tutu1;
   tutu2 = 'NOMC' LMOT1 LMOT2 tutu1 ;
   tutu3 = 'KCHT' RXT.'GEO'.'$menvf'  'VECT' 'SOMMET'  tutu2 ;
   tutu3 = 'DBIT' tutu3 RXT.'GEO'.'$menvf' ;

   'SI' ('EGA' &BCLREC 1) ;
     Urec0 = toto1 'ET' tutu1 ;
*     Srho0 = tutu3 '-' toto3 ;
   'SINON' ;
     Urec0 = Urec0 'ET' toto1 'ET' tutu1 ;
*     Srho0 = Srho0 '+' tutu3 '-' toto3 ;
   'FINSI' ;
     Srho0 = 0.0 ;

** Dans le recombineur, on suppose que le debit massique entrant
** est egale au debit massique sortant
** ==> auncune correction n'est a effectué sur la densité totale !
* Qtot          = Qtot '+' 0.0  ;

 dr = dr '+' (DEB1 '*' (Hout1 '-' Hin1)) ;

   'FIN' BCLREC                                                        ;

'FINSI'                                                                ;
*-----------------------------------------------------------------------

*-----------------------------------------------------------------------
* On en déduit Rhomn et Remn à partir des grandeurs 0D cumulées dans
* Qtot et dr. Les valeurs moyennes de la densité et de l'énergie
* obtenues en intégrant les grandeurs CFD sur le volume peuvent être
* différentes. Rhomn et Remn serviront de référence pour la remise à la
* norme.

Si TBT.'Tsortie'                                                       ;

**?? Tf=tic.'TF'                                                       ;
**?? Rho=tic.'RHO'                                                     ;
 mess ' nrmalement RHO et Tf n ont pas du changer'                     ;
 Cvm     = 'EXTR' (tic.'Cvm')      ndl                                 ;
**?? Rhomn = Rhom                                                          ;
 Remn  = (Somt(Diag * Rho * cvm * (Tf+273.15))) '/' VTotal             ;
 tic.'Rhomn'  = tic.'Rhomn'  'ET' ('PROG' Rhomn)                       ;
 tic.'Remn'  = tic.'Remn'  'ET' ('PROG' Remn)                          ;

Sinon                                                                  ;

* Détermination de la masse volumique et de l'énergie interne moyenne

 Rhomn = MAXI (PROG (Rhomnm '+' (tic.'DT' '*' Qtot '/' VTotal )) 0.0)  ;
 Remn  = MAXI (PROG (Remnm  '+' (tic.'DT' '*' dr '/' VTotal )  ) 0.0)  ;
mess ' RECALCUL ' &BCLTPS ' Rhomn=' Rhomn ' Remn=' Remn                ;

 tic.'Rhomn'  = tic.'Rhomn'  'ET' ('PROG' Rhomn)                       ;
 tic.'Remn'  = tic.'Remn'  'ET' ('PROG' Remn)                          ;

 mess 'VERIF: densité moyenne et énergie moyenne pas de temps N'       ;
 mess 'VERIF: Rhomn=' Rhomn ' Remn=' Remn                              ;
Finsi                                                                  ;
* Calcul Rhomn et Remn                                        FIN
*======================================================================;










*======================================================================;
* Calcul de l'energie dans le mur au pas de temps N
* Il manque la partie convective !!!!
 'SI' TBT.'THERMP'                                           ;
 Hmur = Qcnm '*' TBT.'Lv'                                    ;
 Emurn = Emurnm '+' ( tic.'DT' '*' Hmur)                     ;
 tic.'Emur'  = tic.'Emur'  'ET' ('PROG' Emurn)               ;
 'FINSI'                                                     ;
*======================================================================;










*======================================================================;
* Calcul de la densité moyenne de vapeur au pas de temps N

* Vapeur et Recomb
 'SI' TBT.'VAPEUR'                                           ;
  'SI' TBT.'TRECOMB' ;
 QIN_H2O  = 'EXTR' RXT.'TIC'.'QIN_H2O'  ('DIME' RXT.'TIC'.'QIN_H2O')  ;
 QOUT_H2O = 'EXTR' RXT.'TIC'.'QOUT_H2O' ('DIME' RXT.'TIC'.'QOUT_H2O') ;
*FD
*mess 'QIN_H2O - QOUT_H2O' (QIN_H2O - QOUT_H2O) ;

 Qovp=Qovp + QOUT_H2O - QIN_H2O  ;
  'FINSI' ;
*>2       Calcul Rhovgn Rhomvn -> tic.'Rhomvg' et tic.'Rhomv'
*>2 Rhomvn= Rhovgn - Rbrom
 mess ' Le débit de condensation en masse (Qcm) est retiré dans RETSAT';
 Rhovgn= MAXI (PROG (Rhovgnm '+'
  (tic.'DT' '*' (Qovp '-' Qcnm '+' Qasp) '/' VTotal )) 0.0)            ;
 Rhomvn= Rhovgn -  Rbrom                                               ;
 tic.'Rhomv' = tic.'Rhomv' 'ET' ('PROG' Rhomvn)                        ;
 tic.'Rhomvg'= tic.'Rhomvg' 'ET' ('PROG' Rhovgn)                       ;
 Mlq = (tic.'DT' '*' (Qcnm + Qlovp))                                   ;

 'FINSI'                                                               ;
* Calcul de la densité moyenne de vapeur au pas de temps N     FIN
*======================================================================;










* Calcul de la densité moyenne incondensable au pas de temps N
*======================================================================;
 'SI' TBT.'THE'                                                        ;
 Rmhen= MAXI (PROG (Rmhenm '+' (tic.'DT' '*' Qohe '/' VTotal )) 0.0)   ;
 tic.'Rhomhe' = tic.'Rhomhe' 'ET' ('PROG' Rmhen)                       ;
 'FINSI'                                                               ;

 'SI' TBT.'TH2'                                                        ;
  'SI' TBT.'TRECOMB'                                                   ;
 QIN_H2   = 'EXTR' RXT.'TIC'.'QIN_H2'   ('DIME' RXT.'TIC'.'QIN_H2' )   ;
 QOUT_H2  = 'EXTR' RXT.'TIC'.'QOUT_H2'  ('DIME' RXT.'TIC'.'QOUT_H2')   ;
 Qoh2=Qoh2 + QOUT_H2 - QIN_H2                                          ;
*FD
mess 'QIN_H2 - QOUT_H2' QIN_H2 QOUT_H2 (QIN_H2 - QOUT_H2)              ;
  'FINSI'                                                              ;
 Rmh2n= MAXI (PROG (Rmh2nm '+' (tic.'DT' '*' Qoh2 '/' VTotal )) 0.0)   ;
 tic.'Rhomh2' = tic.'Rhomh2' 'ET' ('PROG' Rmh2n)                       ;
 'FINSI'                                                               ;

 'SI' TBT.'TN2'                                                        ;
  'SI' TBT.'TRECOMB'                                                   ;
 QIN_N2   = 'EXTR' RXT.'TIC'.'QIN_N2'   ('DIME' RXT.'TIC'.'QIN_N2' )   ;
 QOUT_N2  = 'EXTR' RXT.'TIC'.'QOUT_N2'  ('DIME' RXT.'TIC'.'QOUT_N2')   ;
 Qon2=Qon2 + QOUT_N2 - QIN_N2                                          ;
*FD
*mess 'QIN_N2 - QOUT_N2' (QIN_N2 - QOUT_N2)                            ;
  'FINSI'                                                              ;
 Rmn2n= MAXI (PROG (Rmn2nm '+' (tic.'DT' '*' Qon2 '/' VTotal )) 0.0);  ;
 tic.'Rhomn2' = tic.'Rhomn2' 'ET' ('PROG' Rmn2n)                       ;
 'FINSI'                                                               ;

 'SI' TBT.'TO2'                                                        ;
 'SI' TBT.'TRECOMB'                                                    ;
 QIN_O2   = 'EXTR' RXT.'TIC'.'QIN_O2'   ('DIME' RXT.'TIC'.'QIN_O2' )   ;
 QOUT_O2  = 'EXTR' RXT.'TIC'.'QOUT_O2'  ('DIME' RXT.'TIC'.'QOUT_O2')   ;
 Qoo2=Qoo2 + QOUT_O2 - QIN_O2                                          ;
*FD                                                                    ;
*mess 'QIN_O2 - QOUT_O2' (QIN_O2 - QOUT_O2) ;                          ;
 'FINSI'                                                               ;
 Rmo2n= MAXI (PROG (Rmo2nm '+' (tic.'DT' '*' Qoo2 '/' VTotal )) 0.0)   ;
 tic.'Rhomo2' = tic.'Rhomo2' 'ET' ('PROG' Rmo2n)                       ;
 'FINSI'                                                               ;

 'SI' TBT.'TCO'                                                        ;
 Rmcon= MAXI (PROG (Rmconm '+' (tic.'DT' '*' Qoco '/' VTotal )) 0.0)   ;
 tic.'Rhomco' = tic.'Rhomco' 'ET' ('PROG' Rmcon)                       ;
 'FINSI'                                                               ;

 'SI' TBT.'TCO2'                                                       ;
 Rmco2n=MAXI (PROG (Rmco2nm '+' (tic.'DT' '*' Qoco2 '/' VTotal )) 0.0) ;
 tic.'Rhomco2' = tic.'Rhomco2' 'ET' ('PROG' Rmco2n)                    ;
 'FINSI'                                                               ;

*D'où la masse d'air totale                                            ;
 Rmairn = Rhomn - Rhomvn - Rmhen - Rmh2n - Rmn2n -
 Rmo2n -  Rmcon - Rmco2n                                               ;
  mess 'Rmairn=' Rmairn;
 'SI' (Rmairn '<' 0.0)                                                 ;
    'MESS' 'Pb avec la masse d air 0D'                                 ;
 'FINSI'                                                               ;
 tic.'Rhomair' = tic.'Rhomair' 'ET' ('PROG' Rmairn)                    ;
*======================================================================;

Mas1=somt (Diag * Rho)                                                 ;
Ein1=somt (Diag * Rho * (Tf + 273.15)* cvm)                            ;
mess ' VERIF ETAPE 1, a ce stade on a avancé rhomn mais pas Rho  '     ;
mess ' VERIF ETAPE 1  : Mas1 =' Mas1 ' Ein1=' Ein1 ' cvm=' cvm         ;
mess ' VERIF ETAPE 1  : Rhomn=' Rhomn ' Mas1/V=' (Mas1/Vtotal)         ;
mess ' VERIF ETAPE 1  : Remn =' Remn  ' Ein1/V=' (Ein1/Vtotal)         ;
mess ' VERIF ETAPE 1, a ce stade on a avancé rhomn mais pas Rho  '     ;
mess ' VERIF ETAPE 1  '                                                ;









*======================================================================;
*µµµµµµµµ Estimation de la Pression 0D au pas de temps N
* Si Cavité ouverte Pression nulle !
 Si TBT.'Tsortie'                                                      ;
  Pt       = 0.                                                        ;
  DPDT     = 0.                                                        ;
 Sinon                                                                 ;
* Calcul de la Pression 0D au pas de temps N
* Estimation de la pression Pt au temps N

  Pt       = (Gamnm '-' 1.) '*' Remn                                   ;
 mess 'VERIF Estimation pas de tps N de Pt =' Pt ' (gamnm - 1)*Remn'   ;
  DPDT     = (Pt '-' Ptnm) '/' (tic.'DT')                              ;
 Finsi                                                                 ;
  tic.'dPdt' = tic.'dPdt' 'ET' ('PROG' DPDT)                           ;
 mess 'VERIF Calcul de dPdT=' dpdt                                     ;
*µµµµµµµµ Estimation de la Pression 0D au pas de temps N      FIN
*======================================================================;










*======================================================================;
 'SI' TBT.'PERSO'                                                      ;
  'SI' ( TBT.'IMPR' >EG 2)                                             ;
mess '                             ***********************************';
mess '                             * Execution d une procédure PERSO *';
mess '                             *          '(rxt.'PRCPERSO')
     '                *';
mess '                             ***********************************';
  'FINSI'                                                              ;
 (TEXT (rxt.'PRCPERSO')) Tps rxt                                       ;
  'SI' ( TBT.'IMPR' >EG 2)                                             ;
mess '                             ***********************************';
mess '                             * Fin execution de la procédure   *';
mess '                             *          '(rxt.'PRCPERSO')
     '                *';
mess '                             ***********************************';
  'FINSI'                                                              ;
 'FINSI'                                                               ;
* Execution d'une eventuelle procedure PERSO        FIN
*======================================================================;










Mas2=somt (Diag * Rho)                                                 ;
Ein2=somt (Diag * Rho * (Tf + 273.15)* cvm)                            ;
mess ' VERIF AVANT EDP  Rien n a encore changé '                       ;
mess ' VERIF AVANT EDP: Mas2 =' Mas2 ' Ein2 ' Ein2 ' cvm=' cvm         ;
mess ' VERIF AVANT EDP: Rhomn=' Rhomn ' (Mas2/V)=' (Mas2/Vtotal)       ;
mess ' VERIF AVANT EDP: Remn =' Remn  ' (Ein2/V)=' (Ein2/Vtotal)       ;
mess ' VERIF AVANT EDP'                                                ;

*======================================================================;
* Résolutions des EDP -------------------------------------------------
* RESOLUTION DE LA QDM
* Calcul du terme source de l'equation de QDM
* Ajout de la CLIM injection

 tic.'DSRC'  =  ((-1.) '*' (srcs + src + src2 + src3) '/' VTotal)      ;

** contribution source densité des recombineurs ---
 'SI' (TBT.'TRECOMB')                                                  ;
 tic.'DSRC'  =  tic.'DSRC' '+' Srho0                                   ;
 'FINSI                                                              ' ;
** ------------------------------------------------

 rv         =  TBT.'RV'                                    ;

 gjo  matxx= 'KOPS' 'MATRIK'                               ;
  Si (TBT.'TTsortie')                                      ;
     NBR=dime rxt.'Sorties'                                ;
     ibr=index (rxt.'Sorties')                             ;
    Repeter BBRS NBR                                       ;
     Briches=rxt.'Sorties'.(ibr.&BBRS)                     ;
*     mess ' Sorties CL pour QDM '   (ibr.&BBRS)            ;
     gjo=gjo et (Briches.'gj')                             ;
*     list gjo;
    FIN BBRS                                               ;
  FINSI                                                    ;
  Si (TBT.'TTbreche')                                      ;
     NBR=dime rxt.'Breches'                                ;
     ibr=index (rxt.'Breches')                             ;
    Repeter BBRS NBR                                       ;
     Briches=rxt.'Breches'.(ibr.&BBRS)                     ;
*    mess ' Breches CL pour QDM '   (ibr.&BBRS)            ;
     gjo=gjo et (Briches.'gj')                             ;
    FIN BBRS                                               ;
  FINSI                                                    ;
 Si (TBT.'Tbreche')                                        ;
 gjo= gjo et gj                                            ;
 Finsi                                                     ;
 Si (TBT.'Tbreche2')                                       ;
 gjo= gjo et gj2                                           ;
 Finsi                                                     ;
 Si (TBT.'Tbreche3')                                       ;
 gjo= gjo et gj3                                           ;
 Finsi                                                     ;

'SI'((EGA TBT.'MODTURB' 'KEPSILON') et (EGA TBT.'FEF' 'EFM1'));
*---- Modèle K-Epsilon EFM1 --------------------------------
*mess 'Modèle K-Epsilon EFM1' ;
  Si (TBT.'TTsortie')                                      ;
     NBR=dime rxt.'Sorties'                                ;
     ibr=index (rxt.'Sorties')                             ;
    Repeter BBRS NBR                                       ;
     Briches=rxt.'Sorties'.(ibr.&BBRS)                     ;
*    mess ' Sorties CL pour QDM'   (ibr.&BBRS)             ;
     gjs=Briches.'gj'                                      ;
 lcj=extr gjs 'COMP'                                       ;
 mdj=gjs 'PSCA' gjs lcj lcj                                ;
 gk=((0.05**2.)*mdj) nomc 'KN'                             ;
 gk=CHAN 'ATTRIBUT' gk 'NATURE' 'DISCRET'                  ;
 ge=((gk**1.5)/(GEO.'Dbreche')) nomc 'EN'                  ;
 gjo= gjo et gk                                            ;
 gjo= gjo et ge                                            ;
    FIN BBRS                                               ;
  FINSI                                                    ;
  Si (TBT.'TTbreche')                                      ;
     NBR=dime rxt.'Breches'                                ;
     ibr=index (rxt.'Breches')                             ;
    Repeter BBRS NBR                                       ;
     Briches=rxt.'Breches'.(ibr.&BBRS)                     ;
*    mess ' Breches CL pour QDM'   (ibr.&BBRS)             ;
     gjs=Briches.'gj'                                      ;
 lcj=extr gjs 'COMP'                                       ;
 mdj=gjs 'PSCA' gjs lcj lcj                                ;
 gk=((0.05**2.)*mdj) nomc 'KN'                             ;
 gk=CHAN 'ATTRIBUT' gk 'NATURE' 'DISCRET'                  ;
 ge=((gk**1.5)/(GEO.'Dbreche')) nomc 'EN'                  ;
 gjo= gjo et gk                                            ;
 gjo= gjo et ge                                            ;
    FIN BBRS                                               ;
  FINSI                                                    ;
 Si (TBT.'Tbreche')                                        ;
 lcj=extr gj 'COMP'                                        ;
 mdj=gj 'PSCA' gj lcj lcj                                  ;
 gk=((0.05**2.)*mdj) nomc 'KN'                             ;
 gk=CHAN 'ATTRIBUT' gk 'NATURE' 'DISCRET'                  ;
 ge=((gk**1.5)/(GEO.'Dbreche')) nomc 'EN'                  ;
 gjo= gjo et gk                                            ;
 gjo= gjo et ge                                            ;
 Finsi                                                     ;
 Si (TBT.'Tbreche2')                                       ;
 lcj=extr gj2 'COMP'                                       ;
 mdj=gj2 'PSCA' gj2 lcj lcj                                ;
 gk=((0.05**2.)*mdj) nomc 'KN'                             ;
 gk=CHAN 'ATTRIBUT' gk 'NATURE' 'DISCRET'                  ;
 ge=((gk**1.5)/(GEO.'Dbreche2')) nomc 'EN'                 ;
 gjo= gjo et gk                                            ;
 gjo= gjo et ge                                            ;
 Finsi                                                     ;
 Si (TBT.'Tbreche3')                                       ;
 lcj=extr gj3 'COMP'                                       ;
 mdj=gj3 'PSCA' gj3 lcj lcj                                ;
 gk=((0.05**2.)*mdj) nomc 'KN'                             ;
 gk=CHAN 'ATTRIBUT' gk 'NATURE' 'DISCRET'                  ;
 ge=((gk**1.5)/(GEO.'Dbreche3')) nomc 'EN'                 ;
 gjo= gjo et gk                                            ;
 gjo= gjo et ge                                            ;
 Finsi                                                     ;

*---- Modèle K-Epsilon EFM1 -- FIN -------------------------
 'FINSI'                                                   ;

Si ((TBT.'Tbreche') ou (TBT.'Tbreche2') ou (TBT.'Tbreche3')
      ou TBT.'TTbreche' ou TBT.'TTsortie')                ;
rv.'CLIM'    = (rv.'CLIM'  '-' rv.'CLIM')  '+' gjo        ;
Finsi ;

** contribution CL vitesse des recombineurs ---
 'SI' (TBT.'TRECOMB') ;
  'SI' ((TBT.'Tbreche') 'OU' (TBT.'Tbreche2') 'OU' (TBT.'Tbreche3')
      ou TBT.'TTbreche' ou TBT.'TTsortie')                ;
     rv.'CLIM'    = rv.'CLIM' '+' Urec0 ;
  'SINON' ;
     rv.'CLIM'    = (rv.'CLIM'  '-' rv.'CLIM')  '+' Urec0 ;
  'FINSI' ;
 'FINSI' ;
** --------------------------------------------


 Rgp = tic.'Rgp' ;

 'SI' ( TBT.'IMPR' >EG 2)                                  ;
 'MESS' '==> RESOLUTION QDM'                               ;
 'FINSI'                                                   ;

*--- Actualisation de NU
 tic.'NU'  = (tic.'Mu' '/' Rhomnm)                         ;
 tic.'NUm' = somt (GEO.'Diag' * tic.'NU') / GEO.'VTotal'   ;

*--- On actualise YP (si Fonction de paroi)
 Si (TBT.'FPAROI');
 tic.'YP'=rxt.'YP';
 Finsi ;

*--- Actualisation de NUEFF
Si (Exist TBT 'MODTURB')                                   ;

*---- Modèle viscosité tourbillonnaire constante -----------
 Si ( Ega TBT.'MODTURB' 'NUTURB')                          ;
  tic.'NUEFF'=tic.'NU' + rxt.'NUT'                         ;
 Finsi                                                     ;
*---- Modèle viscosité tourbillonnaire constante -- FIN ----

*---- Modèle de longueur de mélange ------------------------
 Si ( Ega TBT.'MODTURB' 'LMEL')                            ;
  un    = tic.'UN'                                         ;
  P = PRODT UN $vtf                                        ;
  lm=TBT.'LMEL'                                            ;
  NUT= (lm*lm*(P**0.5))                                    ;
*Réalisabilité sur Nut
   Nu=tic.'NU'                                             ;
   a = 5000.*Nu                                            ;
   al=0.8 ; ala=al*a ; b=ala*((2.*(1.-al))**(-1.))         ;
   ik=masq Nut 'INFERIEUR' ala                             ;
   Nut=(ik*Nut)+( (1.-ik)*a*(Nut + b)*(inve (a + Nut + b)));
   Nutsnu=Nut*(inve Nu)                                    ;
  'SI' ( TBT.'IMPR' >EG 2)                                 ;
   MESS ' Mini Maxi Nut/Nu ' (mini Nutsnu) (maxi Nutsnu)   ;
  'FINSI'                                                  ;
   tic.'NUEFF'=NUT + tic.'NU'                              ;

 Finsi                                                     ;
*---- Modèle de longueur de mélange -- FIN -----------------

*---- Modèle K-Epsilon Implicite ---------------------------
 Si (( Ega TBT.'MODTURB' 'KEPSILON') et (non(EGA TBT.'FEF' 'EFM1')));
* Calcul KEPSILON
************** Constantes du K epsilon ******
cnu=0.09;
c1=1.44;
c2=1.92;
sgk=1. ;
sge=1.3;

 Dg = doma $vtf 'XXDIAGSI' ;
 Lma=(somt Dg)**(1./(vale DIME));
 Lmi=(mini Dg)**((1.)/(vale DIME));
  un    = tic.'UN'                                         ;
  P = PRODT UN $vtf                                        ;
* P= PRODT UN $vtf m4 m5 ;

 Rrk=  TBT.'Rrk'                                           ;
 Rre=  TBT.'Rre'                                           ;

 En=tic.'EN'    ;
 Kn=tic.'KN'    ;
*Nut=Cnu * Kn * Kn * (inve En) ;
 Nut = (Lmi*Lma*(P**0.5)) ;
* Réalisabilité sur Nut
* Nut > 1.e-15
 ik=masq Nut 'SUPERIEUR' 1.e-15 ;
 Nut=(ik*Nut)+((1.-ik)*1.e-15);
* Nut P < En
*a= En * (inve P) * 0.133;
 a= En * (inve P) * 0.133;
 al=0.8; ala=al*a; b=ala*((2.*(1.-al))**(-1.));
 ik=masq Nut 'INFERIEUR' ala ;
*Nut=(ik*Nut)+( (1.-ik)*a*(Nut + b)*(inve (a + Nut + b)));
*Nut = kcht $vtf scal sommet Nut  ;
 mess 'mini maxi Nut ' (mini Nut ) (maxi Nut ) ;
 Sk=Nut * P - ((KN**1.5)*(1./Lma))  ;
 Kn         =  'KOPS' Kn  '|<' 1.e-5                       ;
 EsK= En * (inve Kn) ;
 Se=EsK*(Nut * P - (c2*En));
 tic.'Se'=Se;
 tic.'Sk'=Sk;

tic.'NUEFF'=NUT + tic.'NU'                               ;
*-- On traite l'injection comme une C.L. en température
cpv  matxx= 'KOPS' 'MATRIK' ;
Si (TBT.'Tbreche') ;
 cpv = cpv et ('MANU' 'CHPO' brechei 1 'KN'
                           Knj 'NATURE' 'DISCRET')        ;
Finsi ;
Si (TBT.'Tbreche2') ;
 cpv = cpv et ('MANU' 'CHPO' brech2i 1 'KN'
                           Knj2 'NATURE' 'DISCRET')       ;
Finsi ;
Si (TBT.'Tbreche3') ;
 cpv = cpv et ('MANU' 'CHPO' brech3i 1 'KN'
                           Knj3 'NATURE' 'DISCRET')       ;
Finsi ;

 Si ((TBT.'Tbreche') ou (TBT.'Tbreche2') ou (TBT.'Tbreche3'));
 Rrk.'CLIM' = cpv;
 Finsi ;


 Rrk.'METHINV'.'CALPREC' = calprec ;
 EXEC Rrk                                                              ;
*  Filtre  0 '<' Kn
 Kn         =  tic.'KN'                                                ;
 Kn         =  'KOPS' Kn  '|<' 1.e-5                                   ;
 tic.'KN'   = Kn                                                       ;



*-- On traite l'injection comme une C.L. en température
cpv  matxx= 'KOPS' 'MATRIK' ;
Si (TBT.'Tbreche') ;
 cpv = cpv et ('MANU' 'CHPO' brechei 1 'EN'
                           Enj 'NATURE' 'DISCRET')        ;
Finsi ;
Si (TBT.'Tbreche2') ;
 cpv = cpv et ('MANU' 'CHPO' brech2i 1 'EN'
                           Enj2 'NATURE' 'DISCRET')       ;
Finsi ;
Si (TBT.'Tbreche3') ;
 cpv = cpv et ('MANU' 'CHPO' brech3i 1 'EN'
                           Enj3 'NATURE' 'DISCRET')       ;
Finsi ;

 Si ((TBT.'Tbreche') ou (TBT.'Tbreche2') ou (TBT.'Tbreche3')
      ou TBT.'TTbreche' ou TBT.'TTsortie')                ;
 Rre.'CLIM' = cpv;
 Finsi ;


 Rre.'METHINV'.'CALPREC' = calprec ;
 EXEC Rre                                                              ;
*  Filtre  0 '<' En
 En         =  tic.'EN'                                                ;
 En         =  'KOPS' En  '|<' 1.e-15                                  ;
 tic.'EN'   = En                                                       ;

* Réalisabilité sur Nut
   Nut = cnu * Kn * Kn * (inve En) ;                       ;
   Nu= tic.'NU'                                             ;
mess 'Réalisabilité sur Nut';
   a = 1500.*Nu ; al=0.8 ; ala=al*a ; b=ala*((2.*(1.-al))**(-1.));
 tic.'ala'=ala ;
 tic.'nut'=nut ;
   ik=masq Nut 'INFERIEUR' ala ;
   Nut=(ik*Nut)+( (1.-ik)*a*(Nut + b)*(inve (a + Nut + b)));
   Nut = kcht $vtf scal sommet Nut ;
   Nutsnu=(1./Nu)*Nut;
 'SI' ( TBT.'IMPR' >EG 2)                                  ;
  MESS ' Mini Maxi Nut/Nu ' (mini Nutsnu) (maxi Nutsnu)    ;
 'FINSI'                                                   ;

tic.'NUEFF'=NUT + tic.'NU'                                 ;


 Finsi                                                     ;
*---- Modèle K-Epsilon Implicite -- FIN --------------------

*---- Modèle K-Epsilon EFM1 --------------------------------
'SI'(( Ega TBT.'MODTURB' 'KEPSILON') et (EGA TBT.'FEF' 'EFM1'));
  tic.'NUEFF'=tic.'NUT' + tic.'NU'                         ;
*---- Modèle K-Epsilon EFM1 -- FIN -------------------------
 Finsi                                                     ;

Sinon                                                      ;
*---- Il n'y a pas de modèle de turbulence -----------------
  tic.'NUEFF'=tic.'NU'                                     ;
Finsi                                                      ;

*--- Actualisation de MUT
  tic.'MUT'   = (tic.'NUEFF'* Rhomnm)                        ;
*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


  rv.'METHINV'.'CALPREC' = calprec                                     ;
  'SI' ('EXIS' rv 'PROJ')                                              ;
    rv.'PROJ'.'METHINV'.'CALPREC' = calprec                            ;
  'FINSI'                                                              ;

  RV.'MRESOP'=VRAI                                                     ;
  RV.'TCPT'=rxt.'TBT'.'TCPT'                                           ;
  RV.'TKPR'=rxt.'TBT'.'TKPR'                                           ;
  RV.'TRESOU'=rxt.'TBT'.'TRESOU'                                       ;
  RV.'IMPARA'=rxt.'TBT'.'IMPARA'                                       ;

  Si (NON (TBT.'TRTOUT'))                                              ;
* Dans ce cas on résoud la qdm en tête
* sinon on attend d'avoir tout cumulé pour résoudre la qdm et le reste
  EXEC  rv                                                             ;
  Finsi;
*======================================================================;

*======================================================================;
Si (TBT.'TRTF') ;
mess '$$$$ ON RAJOUTE LA TEMPERATURE TF à LA QDM               $$$$ '  ;
   rtf        = rv                                                     ;
   CLINC RXT rtf (TBT.'TRTF') 'TF' 'Tj' Tj Tj2 Tj3                     ;
   rtf.'METHINV'.'CALPREC' = calprec                                   ;
'FINSI'                                                                ;
*======================================================================;
'SI' ((TBT.'VAPEUR') et (TBT.'TRrvap'))                                ;
mess '$$$$ ON RAJOUTE LA DENSITE DE VAPEUR à la QDM '                  ;
   Rrvap       = rv                                                    ;
   CLINC RXT Rrvap (TBT.'TRrvap') 'RVP' 'Rvapj' Rvapj Rvapj2 Rvapj3    ;
   Rrvap.'METHINV'.'CALPREC' = calprec                                 ;
'FINSI'                                                                ;
*======================================================================;
 'SI' ((TBT.'THE') et (TBT.'TRrhe'))                                   ;
mess '$$$$ ON RAJOUTE LA RESOLUTION DE LA DENSITE HELIUM'              ;
   Rrhe        =  rv                                                   ;
   CLINC RXT Rrhe (TBT.'TRrhe') 'RHE' 'Rhej' Rhej Rhej2 Rhej3          ;
   Rrhe.'resmn'              = tic.'RHE' NOMC 'RHE'                    ;
   Rrhe.'METHINV'.'CALPREC' = calprec ;                                ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TH2') et (TBT.'TRrh2'))                                   ;
mess '$$$$ ON RAJOUTE LA RESOLUTION DE LA DENSITE HYDROGENE'           ;
   Rrh2        =  rv                                                   ;
   CLINC RXT Rrh2 (TBT.'TRrh2') 'RH2' 'Rh2j' Rh2j Rh2j2 Rh2j3          ;
   Rrh2.'resmn'              = tic.'RH2' NOMC 'RH2'                    ;
   Rrh2.'METHINV'.'CALPREC' = calprec ;                                ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TO2') et (TBT.'TRro2'))                                   ;
   Rro2        =  rv                                                   ;
   CLINC RXT Rro2 (TBT.'TRro2') 'RO2' 'Ro2j' Ro2j Ro2j2 Ro2j3          ;
   Rro2.'resmn'              = tic.'RO2' NOMC 'RO2'                    ;
   Rro2.'METHINV'.'CALPREC' = calprec                                  ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TN2') et (TBT.'TRrn2'))                                   ;
   Rrn2        =  rv                                                   ;
   CLINC RXT Rrn2 (TBT.'TRrn2') 'RN2' 'Rn2j' Rn2j Rn2j2 Rn2j3          ;
   Rrn2.'resmn'              = tic.'RN2' NOMC 'RN2'                    ;
   Rrn2.'METHINV'.'CALPREC' = calprec                                  ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TCO2') et (TBT.'TRrco2'))                                 ;
   Rrco2       =  rv                                                   ;
   CLINC RXT Rrco2 (TBT.'TRrco2') 'RCO2' 'Rco2j' Rco2j Rco2j2 Rco2j3   ;
   Rrco2.'resmn'              = tic.'RCO2' NOMC 'RCO2'                 ;
   Rrco2.'METHINV'.'CALPREC' = calprec                                 ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TCO') et (TBT.'TRrco'))                                   ;
mess '$$$$ ON RAJOUTE LA RESOLUTION DE LA DENSITE MONOXYDE DE CARBONE' ;
   Rrco        =  rv                                                   ;
   CLINC RXT Rrco (TBT.'TRrco') 'RCO' 'Rcoj' Rcoj Rcoj2 Rcoj3          ;
   Rrco.'resmn'              = tic.'RCO' NOMC 'RCO'                    ;
   Rrco.'METHINV'.'CALPREC' = calprec                                  ;
 'FINSI'                                                               ;
*======================================================================;
 'SI' ((TBT.'TAIR') et (TBT.'TRrair'))                                 ;
mess '$$$$ ON RAJOUTE LA RESOLUTION DE LA DENSITE DE L AIR '           ;
   Rrair       =  rv                                                   ;
   CLINC RXT Rrair (TBT.'TRrair') 'RAIR' 'Rairj' Rairj Rairj2 Rairj3   ;
   Rrair.'resmn'              = tic.'RAIR' NOMC 'RAIR'                 ;
   Rrair.'METHINV'.'CALPREC' = calprec                                 ;
 'FINSI'                                                               ;
*======================================================================;

Si (TBT.'TRTOUT')                                                      ;
 EXEC rv                                                               ;

Finsi                                                                  ;


*======================================================================;
* RESOLUTION DE LA DENSITE DE VAPEUR
* Affichage des masses totales vapeur AVANT et APRES
* Creation de la CLIM pour injection

'SI' ((TBT.'VAPEUR') et (NON (TBT.'TRrvap')))                          ;
 Rrvap       =  TBT.'Rrvap'                                            ;
   CLINC RXT Rrvap (TBT.'TRrvap') 'RVP' 'Rvapj' Rvapj Rvapj2 Rvapj3    ;
 Rrvap.'METHINV'.'CALPREC' = calprec                                   ;
   mess ' ON EXEC Rrvap ====================';                         ;
 EXEC  Rrvap                                                           ;
'FINSI'                                                                ;

'SI' TBT.'VAPEUR'                                                      ;
 tic.'ROVP' = tic.'RVP'                                                ;
'SINON'                                                                ;
 Rvp        = 0.                                                       ;
 tic.'RVP'  = Rvp                                                      ;
'FINSI'                                                                ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE HELIUM
*
 'SI' ((TBT.'THE') et (NON (TBT.'TRrhe')))                             ;
   Rrhe        =  TBT.'Rrhe'                                           ;
   CLINC RXT Rrhe (TBT.'TRrhe') 'RHE' 'Rhej' Rhej Rhej2 Rhej3          ;
   Rrhe.'resmn'              = tic.'RHE' NOMC 'RHE'                    ;
   Rrhe.'METHINV'.'CALPREC' = calprec ;                                ;
   EXEC  Rrhe                                                          ;
 'FINSI'                                                               ;

 'SI' (TBT.'THE')                                                      ;
*  Filtre  0 '<' Rhe
   rhe        =  tic.'RHE'                                             ;
   rhe        =  'KOPS' rhe '|<' 1.e-10                                ;
   rhe        =  'KOPS' rhe '>|' (maxi tic.'RHO')                      ;
 'SINON'                                                               ;
   rhe        = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE HYDROGENE
*
 'SI' ((TBT.'TH2') et (NON (TBT.'TRrh2')))                             ;
   Rrh2        =  TBT.'Rrh2'                                           ;
   CLINC RXT Rrh2 (TBT.'TRrh2') 'RH2' 'Rh2j' Rh2j Rh2j2 Rh2j3          ;
   Rrh2.'resmn'              = tic.'RH2' NOMC 'RH2'                    ;
   Rrh2.'METHINV'.'CALPREC' = calprec ;                                ;
   EXEC  Rrh2                                                          ;
 'FINSI'                                                               ;

 'SI' TBT.'TH2'                                                        ;
*  Filtre  0 '<' Rh2
   rh2        =  tic.'RH2'                                             ;
   rh2        =  'KOPS' rh2 '|<' 1.e-10                                ;
   rh2        =  'KOPS' rh2 '>|' (maxi tic.'RHO')                      ;
 'SINON'                                                               ;
   rh2        = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE OXYGENE
*
 'SI' ((TBT.'TO2') et (NON (TBT.'TRro2')))                             ;
   Rro2        =  TBT.'Rro2'                                           ;
   CLINC RXT Rro2 (TBT.'TRro2') 'RO2' 'Ro2j' Ro2j Ro2j2 Ro2j3          ;
   Rro2.'resmn'              = tic.'RO2' NOMC 'RO2'                    ;
   Rro2.'METHINV'.'CALPREC' = calprec                                  ;
   EXEC  Rro2                                                          ;
 'FINSI'                                                               ;

 'SI' TBT.'TO2'                                                        ;
*  Filtre  0 '<' Ro2
   ro2        =  tic.'RO2'                                             ;
   ro2        =  'KOPS' ro2 '|<' 1.e-10                                ;
   ro2        =  'KOPS' ro2 '>|' (maxi tic.'RHO')                      ;
 'SINON'                                                               ;
   ro2        = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE AZOTE
*
 'SI' ((TBT.'TN2') et (NON (TBT.'TRrn2')))                             ;
   Rrn2        =  TBT.'Rrn2'                                           ;
   CLINC RXT Rrn2 (TBT.'TRrn2') 'RN2' 'Rn2j' Rn2j Rn2j2 Rn2j3          ;
   Rrn2.'resmn'              = tic.'RN2' NOMC 'RN2'                    ;
   Rrn2.'METHINV'.'CALPREC' = calprec                                  ;
   EXEC  Rrn2                                                          ;
 'FINSI'                                                               ;

 'SI' TBT.'TN2'                                                        ;
*  Filtre  0 '<' Rn2
   rn2        =  tic.'RN2'                                             ;
   rn2        =  'KOPS' rn2 '|<' 1.e-10                                ;
   rn2        =  'KOPS' rn2 '>|' (maxi tic.'RHO')                      ;
 'SINON'                                                               ;
   rn2        = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE DIOXYDE DE CARBONE
*
 'SI' ((TBT.'TCO2') et (NON (TBT.'TRrco2')))                           ;
   Rrco2       =  TBT.'Rrco2'                                          ;
   CLINC RXT Rrco2 (TBT.'TRrco2') 'RCO2' 'Rco2j' Rco2j Rco2j2 Rco2j3   ;
   Rrco2.'resmn'              = tic.'RCO2' NOMC 'RCO2'                 ;
   Rrco2.'METHINV'.'CALPREC' = calprec                                 ;
   EXEC  Rrco2                                                         ;
 'FINSI'                                                               ;

 'SI' TBT.'TCO2'                                                       ;
*  Filtre  0 '<' Rco2
   rco2        =  tic.'RCO2'                                           ;
   rco2        =  'KOPS' rco2 '|<' 1.e-10                              ;
   rco2        =  'KOPS' rco2 '>|' (maxi tic.'RHO')                    ;
 'SINON'                                                               ;
   rco2       = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE D'AIR
*
 'SI' ((TBT.'TAIR') et (NON (TBT.'TRrair')))                           ;
   Rrair       =  TBT.'Rrair'                                          ;
   CLINC RXT Rrair (TBT.'TRrair') 'RAIR' 'Rairj' Rairj Rairj2 Rairj3   ;
   Rrair.'resmn'              = tic.'RAIR' NOMC 'RAIR'                 ;
   Rrair.'METHINV'.'CALPREC' = calprec                                 ;
   EXEC  Rrair                                                         ;
 'FINSI'                                                               ;

 'SI' TBT.'TAIR'                                                       ;
*  Filtre  0 '<' Rair
   rair        =  tic.'RAIR'                                           ;
   rair        =  'KOPS' rair '|<' 1.e-10                              ;
   rair        =  'KOPS' rair '>|' (maxi tic.'RHO')                    ;
 'FINSI'                                                               ;
*======================================================================;





*======================================================================;
* RESOLUTION DE LA DENSITE MONOXYDE DE CARBONE
*
 'SI' ((TBT.'TCO') et (NON (TBT.'TRrco')))                             ;
   Rrco        =  TBT.'Rrco'                                           ;
   CLINC RXT Rrco (TBT.'TRrco') 'RCO' 'Rcoj' Rcoj Rcoj2 Rcoj3          ;
   Rrco.'resmn'              = tic.'RCO' NOMC 'RCO'                    ;
   Rrco.'METHINV'.'CALPREC' = calprec                                  ;
   EXEC  Rrco                                                          ;
 'FINSI'                                                               ;

 'SI' TBT.'TCO'                                                        ;
*  Filtre  0 '<' Rco
   rco        =  tic.'RCO'                                             ;
   rco        =  'KOPS' rco '|<' 1.e-10                                ;
   rco        =  'KOPS' rco '>|' (maxi tic.'RHO')                      ;
 'SINON'                                                               ;
   rco        = 0.                                                     ;
 'FINSI'                                                               ;
*======================================================================;




*======================================================================;
si (NON (TBT.'TRTF'));
mess '$$$$ RESOLUTION DE LA TEMPERATURE DU FLUIDE TF SEQUENTIELLEMENT' ;
* Definition des températures TBPW et TBP pour ECHI
*                             TBPW température paroi (THERMP)
* Definition des CLIM pour l'injection et ajout
* des CLIM pour température paroi imposée
* Le terme source STF est calcule avant (fin pas precedent)
   rtf        = TBT.'RTF'                                              ;
   CLINC RXT rtf (TBT.'TRTF') 'TF' 'Tj' Tj Tj2 Tj3                     ;
   rtf.'METHINV'.'CALPREC' = calprec                                   ;
   mess ' ON EXEC RTF ======================';                         ;
   EXEC  rtf                                                           ;
'FINSI'                                                                ;
*======================================================================;




*======================================================================;
* RESOLUTION DE LA TEMPERATURE PAROI TP
* Le terme SOURCE FHP1 est calulé dans la procédure CONDENS

'SI' TBT.'THERMP'                                        ;
 'SI' ('NON' TBT.'THERCO')                               ;
    rtp        = TBT.'RTP'                               ;
  'SI' ( TBT.'IMPR' >EG 2)                               ;
  'MESS' '==> RESOLUTION rtp '                           ;
  'FINSI'                                                ;
    rtp.'METHINV'.'CALPREC' = calprec                    ;

  EXEC  rtp                                                            ;

 'FINSI'                                                 ;
   Tp         = tic.'TP'                                 ;
'FINSI'                                                  ;
*======================================================================;






 Tfgd = 1.E10 ;
* Filtre  Tfmini '<' Tf
 CHrtf1 = rtf.'CLIM'                                     ;
 MArtf1 = EXTR CHrtf1 'MAILLAGE'                         ;
 'SI' ( MArtf1 'EGA' 0 )                                 ;
   tfmi0 = Tfgd                                          ;
 'SINON'                                                 ;
   tfmi0 = mini rtf.'CLIM'                               ;
 'FINSI'                                                 ;
 'SI' TBT.'ASPER '                                       ;
   tfmiij= tdinj                                         ;
 'SINON'                                                 ;
   tfmiij= Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'THERMP'                                       ;
   tfmiw = mini tic.'TP'                                 ;
 'SINON'                                                 ;
   tfmiw = Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'TTIMP'                                        ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
   ltfmi=prog                                            ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 5 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
   ltfmi=ltfmi et (prog tic.(Btimp.'TBP1') )             ;
  FIN BBTIMP                                             ;
   tfmii = mini ltfmi                                    ;
 'SINON'                                                 ;
   tfmii = Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'TTIMP1'                                       ;
   tfmi1 = tic.'TBP1'                                    ;
 'SINON'                                                 ;
   tfmi1 = Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'TTIMP2'                                       ;
   tfmi2 = tic.'TBP2'                                    ;
 'SINON'                                                 ;
   tfmi2 = Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'TTIMP3'                                       ;
   tfmi3 = tic.'TBP3'                                    ;
 'SINON'                                                 ;
   tfmi3 = Tfgd                                          ;
 'FINSI'                                                 ;
 'SI' TBT.'TECHANP'                                      ;
   tfmi4 = 'MINI' tic.'TBP0'                             ;
 'SINON'                                                 ;
   tfmi4 = Tfgd                                          ;
 'FINSI'                                                 ;
 Tfmi = MINI (PROG tfmi0 tfmiw tfmii
  tfmi1 tfmi2 tfmi3 tfmi4 tfmiij
             (rxt.'TF0'));
 Tf         = tic.'TF'                                   ;
 Tf         = 'KOPS' Tf  '|<' tfmi                       ;
 Tf         = 'KOPS' Tf  '|<' (maxi (prog tfmi 0.))      ;
 tic.'TF'   = Tf                                         ;

*list
* (PROG tfmi0 tfmiw tfmii
*  tfmi1 tfmi2 tfmi3 tfmi4 tfmiij
*             (rxt.'TF0'));
* mess 'Tf est bornée inférieurement par tfmi=' tfmi;
* mess 'Tf est bornée inférieurement par tfmi=' tfmi;
* mess 'Tf est bornée inférieurement par tfmi=' tfmi;

* Tf est bornée inférieurement par la température minimale
* physique

'SI' TBT.'ASPER '                                        ;
*** RVN ***   Velocita gocce
   rvn       =  TBT.'RVN'                                ;
   rvn.'CLIM'  = (rvn.'CLIM' '-' rvn.'CLIM') '+' vnj     ;
    rvn.'METHINV'.'CALPREC' = calprec                    ;
    EXEC  rvn                                                          ;

*** RXD ***   Frazione volume fase dispersa
   rxd       =  TBT.'RXD'                                ;
   rxd.'CLIM'  = (rxd.'CLIM' '-' rxd.'CLIM') '+' xdj     ;
    rxd.'METHINV'.'CALPREC' = calprec                    ;
    EXEC  rxd                                                          ;
   tic.'XD'  =  'KOPS' (tic.'XD') '|<' 1.e-10            ;

*** RTD ***   Temperature fase dispersa
   rtd       =  TBT.'RTD'                                ;
   rtd.'CLIM'  = (rtd.'CLIM' '-' rtd.'CLIM') '+' tdj     ;
    rtd.'METHINV'.'CALPREC' = calprec                    ;
    EXEC  rtd                                                          ;

*** RDD ***   Diametro fase dispersa
   rdd       =  TBT.'RDD'                                ;
   rdd.'CLIM'  = (rdd.'CLIM' '-' rdd.'CLIM') '+' ddj     ;
    rdd.'METHINV'.'CALPREC' = calprec                    ;
    EXEC  rdd                                                          ;
   tic.'DD'  =  'KOPS' (tic.'DD') '|<' 1.e-10            ;

'FINSI'                                                  ;

**** Fin EDP **********************
mess 'FIN EDP '                                                        ;
*======================================================================;
Mas3=somt (Diag * Rho)                                                 ;
Ein3=somt (Diag * Rho * (Tf + 273.15)* cvm)                            ;
mess ' VERIF APRES EDP ça doit commencer à changer '                   ;
mess ' VERIF APRES EDP: Mas3 =' Mas3 ' Ein3 ' Ein3 ' cvm=' cvm         ;
mess ' VERIF APRES EDP: Rhomn=' Rhomn ' ( Mas3/V)=' (Mas3/Vtotal)      ;
mess ' VERIF APRES EDP: Remn =' Remn  ' ( Ein3/V)=' (Ein3/Vtotal)      ;
mess ' VERIF APRES EDP'                                                ;











*======================================================================;
*>5 CONTRAINTES BILANS MASSE 0D
*>5 Contraintes sur :
*>5   - la masse totale
*>5   - les masses des differents constituants incondensables
*>5   - la masse de vapeur d'eau
*
*------------------------------------------------------------
'SI' TBT.'VAPEUR'                                         ;
  'SI' (exist tic 'RAIR')                                 ;
   Mvp=somt (diag*tic.'RVP')                              ;
   Mair=somt (diag*tic.'RAIR')                            ;
  'FINSI'                                                 ;
dRhov    rvp Rhomvnt =  CORMASSE 'RVP' Rhovgn 'Mdrvap'    ;
Mvp=somt (diag*tic.'RVP')                                 ;
Mdrov= drhov*Vtotal                                       ;
*>5 D'où RVP
'FINSI'                                                   ;

*------------------------------------------------------------
'SI' TBT.'THE'                                            ;
dRhohe    rhe Rhomhet =  CORMASSE 'RHE' Rmhen 'Mdrhe'     ;
'FINSI'                                                   ;

*--------------------------------------------------------
'SI' TBT.'TH2'                                            ;
dRhoh2    rh2 Rhomh2t =  CORMASSE 'RH2' Rmh2n 'Mdrh2'     ;
'FINSI'                                                   ;

*--------------------------------------------------------
'SI' TBT.'TO2'                                            ;
dRhoo2    ro2 Rhomo2t =  CORMASSE 'RO2' Rmo2n 'Mdro2'     ;
'FINSI'                                                   ;

*---------------------------------------------------------
'SI' TBT.'TN2'                                            ;
dRhon2    rn2 Rhomn2t =  CORMASSE 'RN2' Rmn2n 'Mdrn2'     ;
'FINSI'                                                   ;

*---------------------------------------------------------
'SI' TBT.'TCO'                                            ;
dRhoco    rco Rhomcot =  CORMASSE 'RCO' Rmcon 'Mdrco'     ;
'FINSI'                                                   ;

*---------------------------------------------------------
'SI' TBT.'TCO2'                                           ;
dRhoco2    rco2 Rhomco2t =  CORMASSE 'RCO2' Rmco2n 'Mdrco2';
'FINSI'                                                   ;
*>5 CONTRAINTES BILANS MASSE 0D                                 FIN
*======================================================================;
Mas4=somt (Diag * Rho)                                                 ;
Ein4=somt (Diag * Rho * (Tf + 273.15)* cvm)                            ;
mess ' VERIF AP BILMAS On devrait retomber sur nos pattes'             ;
mess ' VERIF AP BILMAS: Mas4=' Mas4 ' Ein4 ' Ein4 ' cvm=' cvm          ;
mess ' VERIF AP BILMAS: Rhomn=' Rhomn ' (Mas4/V)=' (Mas4/Vtotal)       ;
mess ' VERIF AP BILMAS: Remn='  Remn  ' (Ein4/V)=' (Ein4/Vtotal)       ;
mess ' VERIF AP BILMAS'                                                ;










*======================================================================;
*>6 CONTRAINTE CALCUL PRESSION
*>6 Calcul de la Pression au pas de temps N
*>6 On distingue trois cas :
*>6 Cavité ouverte, Cavité fermée, Cavité fermée retour à la saturation
*-----------------------------------------------------------------------
* Si Cavité ouverte Pression nulle !
 Si TBT.'Tsortie'                                        ;
 Pt = 0.                                                 ;
 tic.'PT' = tic.'PT' 'ET' ('PROG' Pt)                    ;
 rho = Rhomn                                             ;

 Sinon                                                   ;
*-----------------------------------------------------------------------
* La cavité est fermée
* Calcul de la pression 0D avec le champ Tf actualise
 mess 'VERIF Cavité fermée Calcul Pt à pdt N avec le champ Tf (N)' ;

 Si (NON (EXIST tic 'RAIR'))                               ;
 Rho  = tic.'RHO'                                          ;
 Rair = tic.'YAIR' * tic.'RHO'                             ;
 tic.'RAIR' = Rair                                         ;
 Finsi                                                     ;

* Si (NON (EXIST tic 'RBRO'))                               ;
* tic.'RBRO' = kcht $vtf scal sommet 0.                     ;
* Finsi                                                     ;

*-----------------------------------------------------------------------
** Cette partie est l'ancienne manière de calculer Pt
** Le problème c'est que rgp date du pas de temps précédent
** ainsi que Rhomn, mais on considère que c'est un bon début

   irtf = 'INVE' (rgp '*' (tic.'TF' '+' 273.15))           ;
   Pt = ((Rhomn-Rbrom) '*' Vtotal) '/' ('SOMT' (Diag '*' irtf));
   rhot = Pt '*' ('INVE' (Rgp '*' (Tf '+' 273.15)))        ;

* Calcul de la Densité au pas de temps N

*-----------------------------------------------------------------------
  Si((EGA TBT.'VERSION' 0) ou (NON (TBT.'VAPEUR')))        ;
* Version V0 ==> Loi d état gaz parfait pour la vapeur
 Mess 'VERIF Version V0 ==> Loi d état gaz parfait pour vapeur Pt=' Pt ;

   Qcm   = 0.                                              ;
   Rebro = 0.                                              ;
   Mliq  = 0.                                              ;
   Mlq   = 0.                                              ;

  Sinon                                                    ;
*-----------------------------------------------------------------------
* Version V1 ==> Loi d état gaz réel pour la vapeur

 Rbro = tic.'RBRO'                                         ;
 Rair = tic.'RAIR'                                         ;
 Pto= Pt;

 Pt Rhot Qcm Rebro Mliq Mlq = RETSAT TBT TIC $vtf Pto ndl Rhomn &BCLTPS;
 mess ' RETSAT Qcm=' Qcm;

 Mess 'VERIF Version V1 ==> Loi d état gaz réel pour vapeur Pt=' Pt    ;
* Fin traitement Version V1
  Finsi                                                    ;
*.......................................................................

 rxt.'TIC'.'Mcondm'= rxt.'TIC'.'Mcondm' et (prog Qcm)      ;
 tic.'PT' = tic.'PT' 'ET' ('PROG' Pt)                      ;
 Mlq = Mlq + (extr (dime tic.'Mliqpuis') tic.'Mliqpuis')   ;
 tic.'Mliqpuis'= tic.'Mliqpuis' 'ET' ('PROG' Mlq)          ;

* Fin traitement enceinte fermée
 Finsi ;
*µµµµµµµµ Calcul de la Pression au pas de temps N µµµµµµ FIN µµµµµµµµµµµ
*======================================================================;










*======================================================================;
*µµµµµµµµ Calcul de la Densité au pas de temps N
 rho = 'KCHT' $vtf 'SCAL' 'SOMMET' rhot                  ;
 Rhomnt  = ('SOMT' (Diag '*' rho)) + (Rbrom*Vtotal)      ;
*mess ' Rhomn=' Rhomn '  Rhomnt=' Rhomn;
*-----------------------------
  dRho    = ((Rhomn '*' VTotal) '-' Rhomnt )  '/' Vtotal ;
  tic.'drho' = tic.'drho' 'ET' ( 'PROG' dRho )           ;

*---------- Recalcul pour bilan nul
  drot=rho - rhot;
  rho     = 'KCHT' $vtf 'SCAL' 'SOMMET' (rho '+' dRho)   ;
  rhot    = 'KCHT' $vtf 'SCAL' 'SOMMET'  rho             ;

  tic.'RHO' = rho                                        ;
  Rhomnt  = 'SOMT' (Diag '*' rho)                        ;
  dRho    = dRho '*' Vtotal                              ;

*---------------------------------------------------------
* On corrige l'air apres le calcul de la masse total car
* dans le cas où on ne transporte pas l'air on en a besoin !!
'SI'((NON TBT.'TAIR') et (TBT.'VERSION' '<EG' 1))          ;
* On calcule la masse d'air
*mess 'Rho ' (type Rho) 'Rvp ' (type Rvp) 'rhe ' (type rhe);
*mess 'rh2 ' (type rh2) 'ro2 ' (type ro2) 'rco2 ' (type rco2);
*mess 'rco ' (type rco) ;
 Rair  =  Rho - Rvp - Rhe - Rh2 - Ro2 - Rn2 - Rco2 - Rco   ;
 tic.'RAIR' = Rair                                         ;
'SINON'                                                    ;
 Rair       =  tic.'RAIR'                                  ;
'FINSI'                                                    ;

dRhoair    rair Rhomairt =  CORMASSE 'RAIR' Rmairn 'Mdrair';
*µµµµµµµµ Calcul de la Densité au pas de temps N             FIN
*======================================================================;










*======================================================================;
* CONTRAINTE BILAN ENERGIE
* Correction de la température fluide pour vérifier l'énergie
* ATTENTION : Cv n'est pas reactualise pour l'instant
*mess 'Cvmnm=' cvmnm  'mini maxi Tf ' (mini tf) (maxi tf) ;
*mess 'mini maxi rho ' (mini rho) (maxi rho) ;

 TF = tic.'TF'                                           ;

  Remnt = Cvmnm '*' ( 'SOMT' (Diag '*' rho '*'
                       (Tf '+' 273.15)) )                ;

* On rajoute à l'énergie du mélange l'énergie du Brouillard
* Si il y en a
  Remnt = Remnt - rebro                                  ;

  dE = (Remn '*' Vtotal) '-' Remnt                       ;

*MESS '==> Erreur Energie = ' dE ' Joules'               ;

  Cvmn=Cvmnm                                             ;
  IndE = rho '*' Cvmn '*' (Tf '+' 273.15) '*' Diag
                            '/' Remnt                    ;
  dE = IndE '*' dE                                       ;

  dTf= ('INVE' (Diag '*' rho)) '*' (dE '/' Cvmn)         ;
  dTf = 'KCHT' $vtf 'SCAL' 'SOMMET' dTf                  ;

Si (NON (TBT.'CORTEMP'))                                 ;
*mess ' On supprime la correction sur Tf' ;
 dTf = 'KCHT' $vtf 'SCAL' 'SOMMET' 0. ;
FINsi ;

* mess '%$$ dtf ' (mini dtf) (maxi dtf) ;
  Tf = 'KCHT' $vtf 'SCAL' 'SOMMET' (Tf '+' dTf)          ;
  Tf = KOPS Tf '|<' Tfmi                                 ;
  tic.'TF'  = Tf                                         ;
  tic.'MdTf' = tic.'MdTf' 'ET' ( 'PROG' ('MAXI' dTf) )   ;
  tic.'mdTf' = tic.'mdTf' 'ET' ( 'PROG' ('MINI' dTf) )   ;

*'MESS' '==>>> Mini dTf = ' ('MINI' dTf) ' Maxi dTf '
*                 ( 'MAXI' dTf)                          ;

*--- Recalcul pour bilan nul
  Remnt = Cvmn '*' ( 'SOMT' (Diag '*' rho '*'
                (Tf '+' 273.15)) ) '/' Vtotal            ;
  dE = 'SOMT' ( Diag '*' dE  ) '/' VTotal                ;
  dTf= dE '/' Cvmn '/' ('SOMT'(Diag '*' rho) )          ;
* Correction de la température fluide pour vérifier l'énergie
* CONTRAINTE BILAN ENERGIE                                FIN
*======================================================================;










*======================================================================;
**** Test sur la conservation energie dans le mur

'SI' (TBT.'THERMP' et (NON (TBT.'TPAROIS')))             ;
 Diagp1 = 'DOMA' $vtp 'VOLUME'                           ;
 Vtotalp1 = 'SOMT' Diagp1                                ;
 tp01 = 'NOEL' $vtp Tp                                   ;
 Emurm = ( 'SOMT' (tic.'ROCP' '*' Diagp1 '*'
                    (tp01 '+' 273.15 ) ) )
                     '/' Vtotalp1                        ;
 tic.'TP'  = Tp                                          ;
'FINSI'                                                  ;
'SI' TBT.'TPAROIS'                                       ;
   NPAR=dime rxt.'PAROIS'                                ;
   ipr=index (rxt.'PAROIS')                              ;
   ROCP=0.                                               ;
   Repeter BPRS NPAR                                     ;
     Parois=rxt.'PAROIS'.(ipr.&BPRS)                     ;
     Diagpi = GEO.(ipr.&BPRS).'Diagp'                    ;
     CROCP=chai 'ROCP' &BPRS                             ;
     Rocpi=tic.CROCP                                     ;
     ROCP=ROCP + (Rocpi * Diagpi)                        ;
   FIN BPRS                                              ;
   Diagp=GEO.'Diagp'                                     ;
   ROCP=ROCP*(INVE Diagp)                                ;
   Vtotalp  = 'SOMT' Diagp                               ;
 Emurm = ( 'SOMT' (ROCP '*' Diagp '*' (tp '+' 273.15 )))
                     '/' Vtotalp                         ;
 tic.'TP'  = Tp                                          ;
'FINSI'                                                  ;
**** Test sur la conservation energie dans le mur      FIN
*======================================================================;










*======================================================================;
* Calcul de la Température moyenne fluide

  Tfm= (Remn '*' Vtotal)
     / ('SOMT' (Diag '*' (tic.'RHO') * Cvmn))            ;
  Tfm=Tfm - 273.15                                       ;
  Tfm = maxi (prog Tfm Tfmi)                             ;

  tic.'Tfm'= tic.'Tfm' 'ET' ('PROG' Tfm)                 ;

*---------------------------------------------------------
* Calcul de la Température moyenne paroi

'SI' TBT.'THERMP'                                        ;
  Tpm= 'SOMT' (GEO.'Diagp' '*' Tp) '/' GEO.'VTotalp'     ;
  tic.'Tpm'= tic.'Tpm' 'ET' ('PROG' Tpm)                 ;
'FINSI'                                                  ;

*---------------------------------------------------------
*======================================================================;










*======================================================================;
**** Actualisation des proprietes physiques **************
**** Calcul de la pression *******************************
**** et avancement en temps ******************************

* Calcul Cp (Tfm)
Cph2 Cphe Cpo2 Cpn2 Cpco2 Cpco Cpair = CALCP Tfm         ;
* CALCP on est en fin de boucle

* Calcul Mu (Tkm)
Tkm=Tfm '+' 273.15                                       ;
Muh2 Muhe Muo2 Mun2 Muco2 Muco Muvap Muair = CALMU Tkm   ;


*Dans ces conditions la masse totale est
* Ceci en vue de calculer des fractions massiques
* dont la somme vaut 1 qqst x
* 0<= Yi <= 1 parceque  les rair Rvp etc sont >0
* Rhot diffère de Rho dans sa distribution mais
* l'intégrale doit être la même

Si (TBT.'VERSION' '<EG' 1)                                 ;
Cpvap = TBT.'Cpvap'                                      ;
Rhot=rair + Rvp + rhe + rh2 + ro2 + rn2 + rco + rco2     ;
Finsi ;
* Sinon Rhot est donné par RETSAT (un peu plus haut)

ermas=somt ((Rho - Rhot)*Diag)                           ;

 'SI' ( TBT.'IMPR' >EG 2)                                ;
   MESS 'ERMAS=' ermas                                   ;
 'FINSI'                                                 ;

* Calcul fraction massique eau
'SI' TBT.'VAPEUR'                                        ;
  Yvap =  'KOPS' Rvp '/' Rhot                            ;
'SINON'                                                  ;
  Yvap = 0.                                              ;
'FINSI'                                                  ;
  tic.'YVAP'= Yvap                                       ;

* Calcul fraction massique de He
'SI' TBT.'THE'                                           ;
  Yhe  =  'KOPS' rhe '/' Rhot                            ;
'SINON'                                                  ;
  Yhe  = 0.                                              ;
'FINSI'                                                  ;
  tic.'YHE'= Yhe                                         ;

* Calcul fraction massique de H2
'SI' TBT.'TH2'                                           ;
  Yh2  =  'KOPS' rh2 '/' Rhot                            ;
'SINON'                                                  ;
  Yh2  = 0.                                              ;
'FINSI'                                                  ;
  tic.'YH2'= Yh2                                         ;

* Calcul fraction massique de O2
'SI' TBT.'TO2'                                           ;
  YO2  =  'KOPS' ro2 '/' Rhot                            ;
'SINON'                                                  ;
  Yo2  = 0.                                              ;
'FINSI'                                                  ;
  tic.'YO2'= Yo2                                         ;

* Calcul fraction massique de N2
'SI' TBT.'TN2'                                           ;
  YN2  =  'KOPS' rn2 '/' Rhot                            ;
'SINON'                                                  ;
  Yn2  = 0.                                              ;
'FINSI'                                                  ;
  tic.'YN2'= Yn2                                         ;

* Calcul fraction massique de CO2
'SI' TBT.'TCO2'                                          ;
  YCO2  =  'KOPS' rco2 '/' Rhot                          ;
'SINON'                                                  ;
  Yco2  = 0.                                             ;
'FINSI'                                                  ;
  tic.'YCO2'= Yco2                                       ;

* Calcul fraction massique de CO
'SI' TBT.'TCO'                                           ;
  YCO   =  'KOPS' rco  '/' Rhot                          ;
'SINON'                                                  ;
  Yco   = 0.                                             ;
'FINSI'                                                  ;
  tic.'YCO'= Yco                                         ;

* Calcul de la fraction massique d'air
  Yair = 'KOPS' rair '/' Rhot                            ;
  Yair = KCHT $vtf 'SCAL' 'SOMMET' Yair                  ;
  tic.'YAIR'= Yair                                       ;

* a= yair + yvap + yh2 + yhe + yn2 + yo2 + yco2 + yco    ;
* mess ' Controle de la somme des fractions massiques '
*(mini a) (maxi a) ;

* Calcul de la constante des gaz du mélange et du gamma
* du mélange
* Calcul du Cp du mélange
  Rgp  =  (Rgvap '*' Yvap) '+' (Rgair '*' Yair)
        '+' (Rghe '*' Yhe ) '+'  (Rgh2  '*' Yh2 )
        '+' (Rgo2 '*' Yo2 ) '+' (Rgn2 '*' Yn2 )
        '+' (Rgco '*' Yco ) '+' (Rgco2 '*' Yco2 )        ;

  Rgp  =  'KCHT' $vtf 'SCAL' 'SOMMET' Rgp                ;
  Rgpm = 'SOMT' (Diag '*' Rgp) '/' VTotal                ;
* Mess ' Rgpm = ' Rgpm ;

  Cp   =  (Cpvap '*' Yvap) '+' (Cpair '*' Yair)
        '+' (Cphe '*' Yhe ) '+' (Cph2  '*' Yh2 )
        '+' (Cpo2 '*' Yo2 ) '+' (Cpn2  '*' Yn2 )
        '+' (Cpco '*' Yco ) '+' (Cpco2 '*' Yco2 )        ;

  Cp   =  'KCHT' $vtf 'SCAL' 'SOMMET' Cp                 ;
  Cpm  = 'SOMT' (Diag '*' Cp) '/' VTotal                 ;
  Cvm  = Cpm '-' Rgpm                                    ;
  Gamm = Cpm '/' Cvm                                     ;

  Mu   =  (Muvap '*' Yvap) '+' (Muair '*' Yair)
        '+' (Muhe '*' Yhe ) '+' (Muh2  '*' Yh2 )
        '+' (Muo2 '*' Yo2 )  '+' (Mun2 '*' Yn2 )
        '+' (Muco '*' Yco ) '+' (Muco2 '*' Yco2 )        ;

  tic.'Mu' = Mu                                          ;

 tic.'Rgp'  = Rgp                                        ;
 tic.'Rgpm' = tic.'Rgpm' 'ET' ('PROG' Rgpm)              ;
 tic.'Cvm'  = tic.'Cvm'  'ET' ('PROG' Cvm)               ;
 tic.'Gamm' = tic.'Gamm' 'ET' ('PROG' Gamm)              ;
 tic.'Cpm'  = tic.'Cpm'  'ET' ('PROG' Cpm)               ;
 mess 'VERIF Actualisation Rgpm, Cpm, Cvm, Gamm=' Rgpm Cpm Cvm Gamm    ;
**** Actualisation des proprietes physiques **************    FIN
*======================================================================;










*======================================================================;
*---------------------------------------------------------
* Calcul du terme source de l'equation energie

  stf       = DPDT '/' (Cpm '*' Rhomn)                   ;
  tic.'STF' = stf                                        ;

*---------------------------------------------------------
* Calcul de l'energie convective

  Tf=tic.'TF'                                            ;
Econvw = 0.0                                             ;
Econvi = 0.0                                             ;
Econv1 = 0.0                                             ;
Econv2 = 0.0                                             ;
Econv3 = 0.0                                             ;
Econv0 = 0.0                                             ;


'SI'((TBT.'THERMP') et (TBT.'TPAROIF'))                  ;
  Tp=tic.'TP'                                            ;
* Energie extraite du gaz par convection
   Tfpw        = 'REDU' tic.'TF' GEO.'paroif'            ;
   Tbpw        = 'REDU' tic.'TP' GEO.'paroif'            ;
   Hconv      = KCHT GEO.'$paroif' SCAL CENTRE tic.'KHW' ;
   Hconv      = elno  GEO.'$paroif' Hconv                ;
   Econvw      = 'SOMT' ( GEO.'Diagpf' '*'
                        (Hconv '*' (Tfpw '-' Tbpw)))     ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP'                                         ;
* Energie extraite du gaz par convection
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 6 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
   Tfp1 = 'REDU' Tf (Btimp.'mtpi')                       ;
   Tbp1        = tic.(Btimp.'TBP1')                      ;
   CKH1        = Btimp.'KH1'                             ;
   Hconv      = KCHT Btimp.'$mtpi' SCAL CENTRE tic.CKH1  ;
   Hconv      = elno  Btimp.'$mtpi'   Hconv              ;
*   Diagmp1 = 'DOMA' (GEO.'$mtp1') 'XXDIAGSI'            ;
   Econvi = Econvi + (
'SOMT' ( Btimp.'Diagif' '*' (Hconv '*' (Tfp1 '-' Tbp1))));
  FIN BBTIMP                                             ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP1'                                        ;
* Energie extraite du gaz par convection
   Tfp1        = 'REDU' Tf (GEO.'mtp1')                  ;
   Tbp1        = tic.'TBP1'                              ;
   Hconv      = KCHT GEO.'$mtp1'   SCAL CENTRE tic.'KH1' ;
   Hconv      = elno  GEO.'$mtp1'   Hconv                ;
*   Diagmp1 = 'DOMA' (GEO.'$mtp1') 'XXDIAGSI'             ;
   Econv1      = 'SOMT' ( GEO.'Diag1f' '*' (Hconv '*'
                             (Tfp1 '-' Tbp1)))           ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP2'                                        ;
* Energie extraite du gaz par convection
   Tfp2        = 'REDU' Tf (GEO.'mtp2')                  ;
   Tbp2        = tic.'TBP2'                              ;
   Hconv      = KCHT GEO.'$mtp2'   SCAL CENTRE tic.'KH2' ;
   Hconv      = elno  GEO.'$mtp2'   Hconv                ;
*   Diagmp2 = 'DOMA' (GEO.'$mtp2') 'XXDIAGSI'             ;
   Econv2      = 'SOMT' ( GEO.'Diag2f' '*' (Hconv '*'
                             (Tfp2 '-' Tbp2)))           ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP3'                                        ;
* Energie extraite du gaz par convection
   Tfp3        = 'REDU' Tf (GEO.'mtp3')                  ;
   Tbp3        = tic.'TBP3'                              ;
   Hconv      = KCHT GEO.'$mtp3'   SCAL CENTRE tic.'KH3' ;
   Hconv      = elno  GEO.'$mtp3'   Hconv                ;
*   Diagmp3 = 'DOMA' (GEO.'$mtp3') 'XXDIAGSI'             ;
   Econv3      = 'SOMT' ( GEO.'Diag3f' '*' (Hconv '*'
                             (Tfp3 '-' Tbp3)))           ;
'FINSI'                                                  ;

'SI' TBT.'TECHANP'                                       ;
* Energie extraite du gaz par convection
   Tfp0        = 'REDU' Tf (GEO.'mtp0')                  ;
   Tbp0        = tic.'TBP0'                              ;
   Hconv      = KCHT GEO.'$mtp0'   SCAL CENTRE tic.'KH0' ;
   Hconv      = elno  GEO.'$mtp0'   Hconv                ;
*   Diagmp3 = 'DOMA' (GEO.'$mtp3') 'XXDIAGSI'             ;
   Econv0      = 'SOMT' ( GEO.'Diag0f' '*' (Hconv '*'
                             (Tfp0 '-' Tbp0)))           ;
'FINSI'                                                  ;

   Econv = Econvw '+' Econvi '+'
    Econv1 + Econv2 '+' Econv3 '+' Econv0 ;
   tic.'Econv' = tic.'Econv' 'ET' ('PROG' Econv)         ;

 Easp           = 0.0                                    ;
 Hasp           = 0.0                                    ;
 Qasp           = 0.0                                    ;

'SI' TBT.'ASPER '                                        ;
    Tf          = tic.'TF'                               ;
    Td          = tic.'TD'                               ;
    Hgas        = tic.'HGAS'                             ;
    Diagvtf     = doma $vtf 'XXDIAGSI'                   ;
    Easp        = (somt ( Diagvtf * (Hgas * (Td - Tf)))) *Rhomnm*Cpmnm;
    srvp        = tic.'SRVP'                             ;
    Qasp        = somt (srvp * Volvtf)                   ;
    Tfe         = noel $vtf tic.'TFNM'                   ;
    Hasp        = somt ((srvp * (tfe + 273.15) * Volvtf) * Cpvap) ;

*****modif 2005
* température goutte max et min
  Td          = tic.'TD'                                 ;
  maTd         =  'MAXI' Td                              ;
  tic.'Tdma' =  tic.'Tdma' et (prog maTd)                ;
  miTd         =  'MINI' Td                              ;
  tic.'Tdmi' =  tic.'Tdmi' et (prog miTd)                ;
*****************


'FINSI'                                                  ;

 tic.'Easpe'    = tic.'Easpe' et (prog Easp )            ;
 tic.'Haspe'    = tic.'Haspe' et (prog Hasp )            ;
 tic.'Qaspe'    = tic.'Qaspe' et (prog Qasp )            ;
*=======================================================================





*=======================================================================
*>9* Prediction de la condensation pour le pas suivant ***
* Qc = Qcw    + Qci   + Qc1   + Qc2   + QC3   + Qc0
*      paroif   $mtpi   $mtp1   $mtp2   $mtp3   $mtp0
*               TTIMP   TIMP?   TIMP2   TIMP3   ????

  Qc=0. ; Econd=0. ; Hcond=0.                            ;

'SI' (TBT.'VAPEUR')                                      ;
* Incrément condensation en masse ??? POURQUOI ICI ???
   tic.'Qcm'= tic.'Qcm' 'ET' ('PROG' Qcm)                ;
'FINSI'                                                  ;


*>9-2 Calcul des flux condenses  thermique paroi (paroif)
'SI' (TBT.'VAPEUR' 'ET' (TBT.'TPAROIF'))                 ;
 KHcu = rxt.'ECHAN'                                      ;
Qcw Fcondw Econdw Hcondw KKC ROVI FHP  HT
 = CONDENS rxt (GEO.'$paroif') 'TP' 'TF' 'RVP' KHcu     ;
  tic.'KKCW' = KKC                                       ;
  tic.'ROVIW'= ROVI                                      ;
  tic.'FHPW' = FHP                                       ;
  tic.'KHW'  = HT                                        ;
  tic.'Fcondw'=Fcondw                                    ;
*'MESS' 'Calcul des flux condenses '  Qcw 'Kg/s'         ;
 Qc=Qc+Qcw                                               ;
 Econd= Econd + Econdw                                   ;
 Hcond= Hcond + Hcondw                                   ;
'SINON'                                                  ;
 Qcw=0. ; Econdw=0. ; Hcondw=0.                          ;
'FINSI'                                                  ;

*>9-3 Calcul des flux condenses  Température imposée i
'SI' (TBT.'VAPEUR' 'ET' TBT.'TTIMP')                     ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 7 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
tic.(Btimp.'TPI1')=kcht (Btimp.'$mtpi') scal sommet
 tic.(Btimp.'TBP1')                                      ;
 KHcu=(Btimp.'ECHAN')                                    ;
 CTPI1=Btimp.'TPI1'                                      ;

Qc1 Fcond1 Econd1 Hcond1 KKC ROVI FHP  HT
 = CONDENS rxt (Btimp.'$mtpi') CTPI1 'TF' 'RVP'  KHcu    ;
  CKKC1=Btimp.'KKC1'                                     ;
  CROVI1=Btimp.'ROVI1'                                   ;
  CFHP1=Btimp.'FHP1'                                     ;
  CKH1=Btimp.'KH1'                                       ;
  CFcond1 = Btimp.'Fcond1'                               ;

  tic.CKKC1 = KKC                                        ;
  tic.CROVI1= ROVI                                       ;
  tic.CFHP1 = FHP                                        ;
  tic.CKH1 = HT                                          ;
  tic.CFcond1=Fcond1                                     ;

 'SI' ( TBT.'IMPR' >EG 2)                                ;
*'MESS' 'Calcul des flux condenses '  Qc1 'Kg/s'         ;
 'FINSI'                                                 ;
 Qc=Qc+Qc1                                               ;
 Econd= Econd + Econd1                                   ;
 Hcond= Hcond + Hcond1                                   ;

 CMcond1=chai 'Mcond1' &BBTIMP                           ;
 Mcond1      = Qc1 '*' tic.'DT'                          ;

 McondT1     = 'EXTR' (tic.CMcond1) ndl                  ;
 McondT1     = McondT1 '+' Mcond1                        ;
 tic.CMcond1=tic.CMcond1 'ET' ('PROG' McondT1)           ;

 CQc1=Btimp.'Qc1'                                        ;
 tic.CQc1= tic.CQc1 'ET' ('PROG' Qc1)                    ;

  FIN BBTIMP                                             ;
'SINON'                                                  ;
 Qc1=0. ; Econd1=0. ; Hcond1=0.                          ;
'FINSI'                                                  ;

*>9-4 Calcul des flux condenses  Température imposée 1
'SI' (TBT.'VAPEUR' 'ET' TBT.'TTIMP1')                    ;
tic.'TPI1'=kcht (GEO.'$mtp1') scal sommet (tic.'TBP1')   ;
 KHcu=(rxt.'TIMP1'.'ECHAN')                              ;
Qc1 Fcond1 Econd1 Hcond1 KKC ROVI FHP  HT
 = CONDENS rxt (GEO.'$mtp1') 'TPI1' 'TF' 'RVP' KHcu      ;
  tic.'KKC1'= KKC                                        ;
  tic.'ROVI1'= ROVI                                      ;
  tic.'FHP1' = FHP                                       ;
  tic.'KH1'  = HT                                        ;
  tic.'Fcond1'=Fcond1                                    ;
 'SI' ( TBT.'IMPR' >EG 2)                                ;
*'MESS' 'Calcul des flux condenses '  Qc1 'Kg/s'         ;
 'FINSI'                                                 ;
 Qc=Qc+Qc1                                               ;
 Econd= Econd + Econd1                                   ;
 Hcond= Hcond + Hcond1                                   ;
'SINON'                                                  ;
 Qc1=0. ; Econd1=0. ; Hcond1=0.                          ;
'FINSI'                                                  ;

*>9-5 Calcul des flux condenses  Température imposée 2
'SI' (TBT.'VAPEUR' 'ET' TBT.'TTIMP2')                    ;
tic.'TPI2'=kcht (GEO.'$mtp2') scal sommet (tic.'TBP2')   ;
 KHcu=(rxt.'TIMP2'.'ECHAN')                              ;
Qc2 Fcond2 Econd2 Hcond2 KKC ROVI FHP HT
 = CONDENS rxt (GEO.'$mtp2') 'TPI2' 'TF' 'RVP' KHcu      ;
  tic.'KKC2' = KKC                                       ;
  tic.'ROVI2'= ROVI                                      ;
  tic.'FHP2' = FHP                                       ;
  tic.'KH2'  = HT                                        ;
  tic.'Fcond2'=Fcond2                                    ;
 'SI' ( TBT.'IMPR' >EG 2)                                ;
*'MESS' 'Calcul des flux condenses '  Qc2 'Kg/s'         ;
 'FINSI'                                                 ;
 Qc=Qc+Qc2                                               ;
 Econd= Econd + Econd2                                   ;
 Hcond= Hcond + Hcond2                                   ;
'SINON'                                                  ;
 Qc2=0. ; Econd2=0. ; Hcond2=0.                          ;
'FINSI'                                                  ;

*>9-6 Calcul des flux condenses  Température imposée 3
'SI' (TBT.'VAPEUR' 'ET' TBT.'TTIMP3')                    ;
tic.'TPI3'=kcht (GEO.'$mtp3') scal sommet (tic.'TBP3')   ;
 KHcu=(rxt.'TIMP3'.'ECHAN')                              ;
Qc3 Fcond3 Econd3 Hcond3 KKC ROVI FHP HT
 = CONDENS rxt (GEO.'$mtp3') 'TPI3' 'TF' 'RVP' KHcu      ;
  tic.'KKC3' = KKC                                       ;
  tic.'ROVI3'= ROVI                                      ;
  tic.'FHP3' = FHP                                       ;
  tic.'KH3'  = HT                                        ;
  tic.'Fcond3'=Fcond3                                    ;
 'SI' ( TBT.'IMPR' >EG 2)                                ;
*'MESS' 'Calcul des flux condenses '  Qc3 'Kg/s'         ;
 'FINSI'                                                 ;
 Qc=Qc+Qc3                                               ;
 Econd= Econd + Econd3                                   ;
 Hcond= Hcond + Hcond3                                   ;
'SINON'                                                  ;
 Qc3=0. ; Econd3=0. ; Hcond3=0.                          ;
'FINSI'                                                  ;

*>9-7 Calcul des flux condensés
'SI' (TBT.'VAPEUR' 'ET' TBT.'TECHANP')                   ;
tic.'TPI0'=kcht (GEO.'$mtp0') scal sommet (tic.'TBP0')   ;
 KHcu=(rxt.'ECHANP'.'ECHAN')                             ;
Qc0 Fcond0 Econd0 Hcond0 KKC ROVI FHP HT
 = CONDENS rxt (GEO.'$mtp0') 'TPI0' 'TF' 'RVP' KHcu      ;
  tic.'KKC0' = KKC                                       ;
  tic.'ROVI0'= ROVI                                      ;
  tic.'FHP0' = FHP                                       ;
  tic.'KH0'  = HT                                        ;
  tic.'Fcond0'=Fcond0                                    ;
 'SI' ( TBT.'IMPR' >EG 2)                                ;
*'MESS' 'Calcul des flux condenses '  Qc0 'Kg/s'         ;
 'FINSI'                                                 ;
 Qc=Qc+Qc0                                               ;
 Econd= Econd + Econd0                                   ;
 Hcond= Hcond + Hcond0                                   ;
'SINON'                                                  ;
 Qc0=0. ; Econd0=0. ; Hcond0=0.                          ;
'FINSI'                                                  ;
*>9* Prediction de la condensation pour le pas suivant ***    FIN
 Mess ' Débit condensation Fin pas de temps courant  Qc=' Qc  ;
*=======================================================================











**********************************************************
'SI' TBT.'ASPER '                                        ;
   asparam rxt                                           ;
'FINSI'                                                  ;


**********************************************************
**** Avancement en temps ************************************
*mess 'Avancement en temps' ;

* Calcul densité drho/rho pour le terme de flotabilite

 Mrho=somt (Diag*Rho);
 Mrhot=somt (Diag*Rhot);
*mess '%$$ Mrho=' Mrho ' Mrhot=' Mrhot ;
*mess '%$$ Mini/Maxi rho=' (mini rho)(maxi rho);
*mess '%$$ Mini/Maxi rhot=' (mini rhot)(maxi rhot);

*Rhop = (-1.) '*' (Rhomn '-' Rho) '*' (Rho **(-1.0))     ;
 Rhop = (-1.) '*' (Rhomn '-' Rhot) '*' (Rhot **(-1.0))   ;
 Rhop = 'KCHT' $vtf 'SCAL' 'SOMMET' Rhop                 ;
 rmc  = 'NOEL' $vtf Rhop                                 ;
 tic.'Rhop' = Rhop                                       ;
 'SI' DIM3D                                              ;
 rogx       = 'KCHT' $vtf 'SCAL' 'CENTRE' 0.0            ;
 rogy       = 'KCHT' $vtf 'SCAL' 'CENTRE' 0.0            ;
 rogz       = 'KCHT' $vtf 'SCAL' 'CENTRE' (-9.81 '*' rmc);
 rogx       = 'NOMC' 'UX' rogx 'NATU' 'DISCRET'          ;
 rogy       = 'NOMC' 'UY' rogy 'NATU' 'DISCRET'          ;
 rogz       = 'NOMC' 'UZ' rogz 'NATU' 'DISCRET'          ;
 tic.'ROG'=kcht $vtf 'VECT' 'CENTRE'
                (rogx 'ET' rogy 'ET' rogz)               ;
 'SINON'                                                 ;
 rogx       = 'KCHT' $vtf 'SCAL' 'CENTRE' 0.0            ;
 rogy       = 'KCHT' $vtf 'SCAL' 'CENTRE' (-9.81 '*' rmc);
 rogx       = 'NOMC' 'UX' rogx 'NATU' 'DISCRET'          ;
 rogy       = 'NOMC' 'UY' rogy 'NATU' 'DISCRET'          ;
 tic.'ROG'=kcht $vtf 'VECT' 'CENTRE'
               (rogx 'ET' rogy)                          ;
 'FINSI'                                                 ;

* Vitesse max
 un          = tic.'UN'                                  ;
 lcu=extr un 'COMP'                                      ;
 modu        = (un lcu 'PSCA' un lcu) '**' 0.5           ;
 mmu         =  'MAXI' modu                              ;
 tic.'LMAXU' =  tic.'LMAXU' 'ET' ('PROG' mmu)            ;

 tic.'Qc'    = tic.'Qc' 'ET' ('PROG' Qc)                 ;
 Mess ' Débit condensation Fin pas de temps courant  Qc=' Qc  ;

 Minj        = (Qj '+' Qj2 '+' Qj3 '+' Qlj '+' Qlj2 '+' Qlj3)
                                    '*' tic.'DT'         ;
 MinjT       = MinjT '+' Minj                            ;
 Mcond       = Qc '*' tic.'DT'                           ;
 McondT      = McondT '+' Mcond + Mliq                   ;
 Mrest       =(Qj  '+' Qj2  '+' Qj3  '-' Qc '+' Qasp)
                                      '*' tic.'DT'       ;
 MrestT      = MrestT '+' Mrest                          ;
 tic.'Minj'  = tic.'Minj'  'ET' ('PROG' MinjT)           ;
 tic.'Mcond' = tic.'Mcond' 'ET' ('PROG' McondT)          ;
'SI' TBT.'VAPEUR'                                        ;

'SI' TBT.'TPAROIF'                                       ;
 Mcondw      = Qcw '*' tic.'DT'                          ;
 McondTw     = McondTw '+' Mcondw                        ;
 tic.'Mcondw'= tic.'Mcondw' 'ET' ('PROG' McondTw)        ;
 tic.'Qcw'= tic.'Qcw' 'ET' ('PROG' Qcw)                  ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP1'                                        ;
 Mcond1      = Qc1 '*' tic.'DT'                          ;
 McondT1     = McondT1 '+' Mcond1                        ;
 tic.'Mcond1'= tic.'Mcond1' 'ET' ('PROG' McondT1)        ;
 tic.'Qc1'= tic.'Qc1' 'ET' ('PROG' Qc1)                  ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP2'                                        ;
 Mcond2      = Qc2 '*' tic.'DT'                          ;
 McondT2     = McondT2 '+' Mcond2                        ;
 tic.'Mcond2'= tic.'Mcond2' 'ET' ('PROG' McondT2)        ;
 tic.'Qc2'= tic.'Qc2' 'ET' ('PROG' Qc2)                  ;
'FINSI'                                                  ;

'SI' TBT.'TTIMP3'                                        ;
 Mcond3      = Qc3 '*' tic.'DT'                          ;
 McondT3     = McondT3 '+' Mcond3                        ;
 tic.'Mcond3'= tic.'Mcond3' 'ET' ('PROG' McondT3)        ;
 tic.'Qc3'= tic.'Qc3' 'ET' ('PROG' Qc3)                  ;
'FINSI'                                                  ;

'SI' TBT.'TECHANP'                                       ;
 Mcond0      = Qc0 '*' tic.'DT'                          ;
*McondT0     = McondT0 '+' Mcond0                        ;
*tic.'Mcond0'= tic.'Mcond0' 'ET' ('PROG' McondT0)        ;
 tic.'Qc0'= tic.'Qc0' 'ET' ('PROG' Qc0)                  ;
'FINSI'                                                  ;

'FINSI'                                                  ;

 tic.'Mrest' = tic.'Mrest' 'ET' ('PROG' MrestT)          ;
 tic.'Econd' = tic.'Econd' 'ET' ('PROG' Econd)           ;
* tic.'Econdw'= tic.'Econdw' 'ET' ('PROG' Econdw)         ;
* tic.'Econd1'= tic.'Econd1' 'ET' ('PROG' Econd1)         ;
* tic.'Econd2'= tic.'Econd2' 'ET' ('PROG' Econd2)         ;
* tic.'Econd3'= tic.'Econd3' 'ET' ('PROG' Econd3)         ;
 tic.'Hcond' = tic.'Hcond' 'ET' ('PROG' Hcond)           ;
* tic.'Hcondw'= tic.'Hcondw' 'ET' ('PROG' Hcondw)         ;
* tic.'Hcond1'= tic.'Hcond1' 'ET' ('PROG' Hcond1)         ;
* tic.'Hcond2'= tic.'Hcond2' 'ET' ('PROG' Hcond2)         ;
* tic.'Hcond3'= tic.'Hcond3' 'ET' ('PROG' Hcond3)         ;


Si( TBT.'IMPR' >EG 2)                                    ;
'MESS' ' ************* BILAN au temps ' Tps ' -> '
              &bcltps ' DT=' tic.'DT'
              ' ****'                                    ;
'SI' TBT.'Tbreche'                                       ;
'MESS' '________________________________________________';
'MESS' '-------- Paramètres Injection 1 ---------------' ;
'MESS' ' Débit Masse (Kg/s)               Qj=' Qj        ;
 'SI' TBT.'VAPEUR'                                       ;
 'MESS' ' Ksi (taux de vapeur injectée)   Ksi=' Ksi      ;
 'FINSI'                                                 ;
'MESS' ' Vitesse (m/s)                   guj=' guj       ;
'MESS' ' Densité à l injection (Kg/m**3) Roj=' Roj       ;
'MESS' ' R/M a l Injection (J/kg/K)      Rgj=' Rgj       ;
'MESS' ' Température d injection (oC)     Tj=' Tj        ;
'MESS' ' Enthalpie d injection (J/Kg)     Hj=' Hj        ;
'MESS' ' Energie injection  (J/Kg)        Ej=' Ej        ;
'MESS' ' Puissance à l injection (Watt)   Pj=' (Qj '*'Ej);
'MESS' '________________________________________________';
'FINSI'                                                  ;
'SI' TBT.'Tbreche2'                                      ;
'MESS' '-------- Paramètres Injection 2 ---------------' ;
'MESS' ' Débit Masse (Kg/s)               Qj=' Qj2       ;
 'SI' TBT.'VAPEUR'                                       ;
 'MESS' ' Ksi2 (taux de vapeur injectée) Ksi2=' Ksi2     ;
 'FINSI'                                                 ;
'MESS' ' Vitesse (m/s)                   guj=' guj2      ;
'MESS' ' Densité à l injection (Kg/m**3) Roj=' Roj2      ;
'MESS' ' R/M a l Injection (J/kg/K)      Rgj=' Rgj2      ;
'MESS' ' Température d injection (oC)     Tj=' Tj2       ;
'MESS' ' Enthalpie d injection (J/Kg)     Hj=' Hj2       ;
'MESS' ' Energie injection  (J/Kg)        Ej=' Ej2       ;
'MESS' ' Puissance à l injection (Watt)   Pj='(Qj2'*'Ej2);
'MESS' '________________________________________________';
'FINSI'                                                  ;
'SI' TBT.'Tbreche3'                                      ;
'MESS' '-------- Paramètres Injection 2 ---------------' ;
'MESS' ' Débit Masse (Kg/s)               Qj=' Qj3       ;
 'SI' TBT.'VAPEUR'                                       ;
 'MESS' ' Ksi3 (taux de vapeur injectée) Ksi3=' Ksi3     ;
 'FINSI'                                                 ;
'MESS' ' Vitesse (m/s)                   guj=' guj3      ;
'MESS' ' Densité à l injection (Kg/m**3) Roj=' Roj3      ;
'MESS' ' R/M a l Injection (J/kg/K)      Rgj=' Rgj3      ;
'MESS' ' Température d injection (oC)     Tj=' Tj3       ;
'MESS' ' Enthalpie d injection (J/Kg)     Hj=' Hj3       ;
'MESS' ' Energie injection  (J/Kg)        Ej=' Ej3       ;
'MESS' ' Puissance à l injection (Watt)   Pj='(Qj3'*'Ej3);
'MESS' '________________________________________________';
'FINSI'                                                  ;

'MESS' ' Pression corrigée  (Pa)         Pt =' Ptnm      ;
'MESS' '________________________________________________';
'MESS' '  '                                              ;
'SI' TBT.'VAPEUR'                                        ;
'MESS' '________________________________________________';
'MESS' '--------Bilan sur la vapeur--------------------' ;
'MESS' ' Débit masse condensée (kg/s)         QC=' Qc    ;
'MESS' ' Masse injectée (kg)                Minj=' Minj  ;
'MESS' ' Masse injectée totale (kg)        MinjT=' MinjT ;
'MESS' ' Masse condensée (kg)              Mcond=' Mcond ;
'SI' TBT.'TPAROIF'                                       ;
'MESS' ' Masse condensée (mur vtp) (kg) Mcondw=' Mcondw  ;
'MESS' ' Masse condensée totale (mur vtp) (kg) McondTw=' McondTw;
'FINSI';
'SI' TBT.'TTIMP'                                         ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 8 ';
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
*  Mcondi =Btimp.'Mcondi'                                ;
*  McondTi=Btimp.'McondTi'                               ;
*'MESS' ' Masse condensée (mur Timp1) (kg) Mcondi=' Mcondi;
*'MESS' ' Masse condensée totale (mur Timp1) (kg) McondTi=' McondTi;
  FIN BBTIMP                                             ;
'FINSI';
'SI' TBT.'TTIMP1'                                        ;
'MESS' ' Masse condensée (mur Timp1) (kg) Mcond1=' Mcond1;
'MESS' ' Masse condensée totale (mur Timp1) (kg) McondT1=' McondT1;
'FINSI';
'SI' TBT.'TTIMP2'                                        ;
'MESS' ' Masse condensée (mur Timp2) (kg) Mcond2=' Mcond2;
'MESS' ' Masse condensée totale (mur Timp2) (kg) McondT2=' McondT2;
'FINSI';
'SI' TBT.'TTIMP3'                                        ;
'MESS' ' Masse condensée (mur Timp3) (kg) Mcond3=' Mcond3;
'MESS' ' Masse condensée totale (mur Timp3) (kg) McondT3=' McondT3;
'FINSI';
'MESS' ' Masse condensée totale (kg)      McondT=' McondT;
'MESS' ' Masse vapeur restante (kg)        Mrest=' Mrest ;
'MESS' ' Masse vapeur restante totale(kg) MrestT=' MrestT;
'MESS' ' Puissance condensation (Watt)     QC*Lv='
         (QC '*' Lv)                                     ;
'MESS' ' Energie extraite du gaz par condensation (J)'
         'Econd=' Econd                                  ;
'MESS' '________________________________________________';
'MESS' '  '                                              ;
'FINSI'                                                  ;
'MESS' '________________________________________________';
'MESS' '----- Grandeurs Moyennes ----------------------' ;
'MESS' ' Energie extraite du gaz par convection (J)   Econv= ' Econv ;
'MESS' ' Densité moyenne (kg/m3)                      Rhomn= ' Rhomn ;
'SI' TBT.'VAPEUR'                                                    ;
'MESS' ' Densité moyenne de vapeur(kg/m3)            Rhomvn= ' Rhomvn;
'FINSI'                                                              ;
'SI' TBT.'THE'                                                       ;
'MESS' ' Densité moyenne de helium(kg/m3)             Rmhen= ' Rmhen ;
'FINSI'                                                              ;
'SI' TBT.'TH2'                                                       ;
'MESS' ' Densité moyenne de Hydrogene(kg/m3)          Rmh2n= ' Rmh2n ;
'FINSI'                                                              ;
'SI' TBT.'TO2'                                                       ;
'MESS' ' Densité moyenne de oxygene (kg/m3)           Rmo2n= ' Rmo2n ;
'FINSI'                                                              ;
'SI' TBT.'TN2'                                                       ;
'MESS' ' Densité moyenne de azote(kg/m3)              Rmn2n= ' Rmn2n ;
'FINSI'                                                              ;
'SI' TBT.'TCO'                                                       ;
'MESS' ' Densité moyenne de CO (kg/m3)                Rmcon= ' Rmcon ;
'FINSI'                                                              ;
'SI' TBT.'TCO2'                                                      ;
'MESS' ' Densité moyenne de CO2 (kg/m3)              Rmco2n= ' Rmco2n;
'FINSI'                                                              ;
'SI' TBT.'TAIR'                                                      ;
'MESS' ' Densité moyenne de AIR (kg/m3)              Rmairn= ' Rmairn;
'FINSI'                                                              ;
'SI' TBT.'TPAROIF'                                                   ;
'MESS' ' Température moyenne des murs THERMP (oC)       Tpm= ' Tpm   ;
'SI' ('EGA' ('TYPE' tic.'KHW') 'FLOTTANT')                           ;
   KHWm=tic.'KHW'                                                    ;
'SINON'                                                              ;
   KHW1 = 'ELNO' GEO.'$paroif' (tic.'KHW')                           ;
   KHWm = 'SOMT' (GEO.'Diagpf' '*' KHW1) '/' GEO.'Sparoif'           ;
'FINSI'                                                              ;
'MESS' ' Coefficient echange convectif moyen (Watt/m**2/°C) KHWm='
                                                                KHWm ;
'FINSI'                                                              ;
'SI' TBT.'TTIMP'                                                     ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 9' ;
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
'MESS' ' Température paroi (oC) '(itimp.&BBTIMP)' TBPI='
 tic.(Btimp.'TBP1');
'SI' TBT.'VAPEUR'                                                    ;
 CKH1=Btimp.'KH1'                                                    ;
 KH1  = 'ELNO' Btimp.'$mtpi' (tic.CKH1)                              ;
 KH1m = 'SOMT' (Btimp.'Diagif' '*' KH1) '/' Btimp.'Smtpi'            ;
'SINON'                                                              ;
 KH1m = tic.CKH1                                                     ;
'FINSI'                                                              ;
'MESS' ' Coefficient échange convectif (Watt/m**2/°C) KH1m=' KH1m    ;
  FIN BBTIMP                                                         ;
'FINSI'                                                              ;
'SI' TBT.'TTIMP1'                                                    ;
'MESS' ' Température paroi 1 (oC) (TIMP1)          TBP1= ' tic.'TBP1';
'SI' TBT.'VAPEUR'                                                    ;
 KH11 = 'ELNO' GEO.'$mtp1' (tic.'KH1')                               ;
 KH1m = 'SOMT' (GEO.'Diag1f' '*' KH11) '/' GEO.'Smtp1'               ;
'SINON'                                                              ;
 KH1m = tic.'KH1'                                                    ;
'FINSI'                                                              ;
'MESS' ' Coefficient echange convectif (Watt/m**2/°C) KH1m='
                                                                KH1m ;
'FINSI'                                                              ;
'SI' TBT.'TTIMP2'                                                    ;
'MESS' ' Température paroi 2 (oC) (TIMP2)          TBP2= ' tic.'TBP2';
'SI' TBT.'VAPEUR'                                                    ;
 KH21 = 'ELNO' GEO.'$mtp2' (tic.'KH2')                               ;
 KH2m = 'SOMT' (GEO.'Diag2f' '*' KH21) '/' GEO.'Smtp2'               ;
'SINON'                                                              ;
 KH2m = tic.'KH2'                                                    ;
'FINSI'                                                              ;
'MESS' ' Coefficient echange convectif (Watt/m**2/°C) KH2m='
                                                                KH2m ;
'FINSI'                                                              ;
'SI' TBT.'TTIMP3'                                                    ;
'MESS' ' Température paroi 3 (oC) (TIMP3)          TBP3= ' tic.'TBP3';
'SI' TBT.'VAPEUR'                                                    ;
 KH31 = 'ELNO' GEO.'$mtp3' (tic.'KH3')                               ;
 KH3m = 'SOMT' (GEO.'Diag3f' '*' KH31) '/' GEO.'Smtp3'               ;
'SINON'                                                              ;
 KH3m = tic.'KH3'                                                    ;
'FINSI'                                                              ;
'MESS' ' Coefficient echange convectif (Watt/m**2/°C) KH3m='
                                                                KH3m ;
'FINSI'                                                              ;
'MESS' ' Température fluide moyenne (oC)                Tfm= ' Tfm   ;
'MESS' ' Pression moyenne (Pa)                           Pt= ' Pt    ;
'MESS' ' Gamma moyen                                   Gamm= ' Gamm  ;
'MESS' ' Rgaz moyen (J/kg/K)                           Rgpm= ' Rgpm  ;
'MESS' ' Cv moyen (J/kg/K)                              Cvm= ' Cvm   ;
'MESS' ' Cp moyen (J/kg/K)                              Cpm= ' Cpm   ;
Si(EGA (TYPE Cpvap) 'FLOTTANT')                                      ;
'MESS' ' Cp vapeur moyen (J/kg/K)                     Cpvap= ' Cpvap ;
Sinon                                                                ;
'MESS' ' Cp vapeur moyen (J/kg/K)                     Cpvap= '
 (mini Cpvap) (maxi Cpvap)                                           ;
Finsi                                                                ;
'MESS' '____________________________________________________________';
'MESS' '  '                                                          ;
'MESS' '____________________________________________________________';
'MESS' '-------------------- Corrections -------------------------- ';
'MESS' ' dTf =' dTf ' K   dRho=' dRho ' Kg    dRhov = ' dRhov  ' Kg' ;
'MESS' ' dRhohe=' dRhohe ' Kg    dRhoh2=' dRhoh2 ' Kg';
  'SI' TBT.'TO2' ;
 'MESS' ' dRhoo2=' dRhoo2 ' Kg'; 'FINSI'                 ;
  'SI' TBT.'TN2' ;
 'MESS' ' dRhon2=' dRhon2 ' Kg'; 'FINSI'                 ;
  'SI' TBT.'TCO' ;
 'MESS' ' dRhoco=' dRhoco ' Kg'; 'FINSI'                 ;
  'SI' TBT.'TCO2' ;
 'MESS' ' dRhoco2=' dRhoco2 ' Kg'; 'FINSI'              ;
  'SI' TBT.'TAIR' ;
 'MESS' ' dRhoair=' dRhoair ' Kg'; 'FINSI'              ;
'MESS' '____________________________________________________________';
'MESS' '___Bilans 0D_________Bilans MultiD _____ Erreur Relative (%)';

*---- Bilan masse
 M0D = Rhomn '*' Vtotal                                              ;
 MMD = Rhomnt                                                        ;
 'SI' TBT.'VAPEUR'                                                   ;
 MV0D = Rhomvn '*' Vtotal                                            ;
 MVMD =  Rhomvnt                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'THE'                                                      ;
 MHE0D = Rmhen '*' Vtotal                                            ;
 MHEMD = Rhomhet                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'TH2'                                                      ;
 MH20D = Rmh2n '*' Vtotal                                            ;
 MH2MD = Rhomh2t                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'TO2'                                                      ;
 MO20D = Rmo2n '*' Vtotal                                            ;
 MO2MD = Rhomo2t                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'TN2'                                                      ;
 MN20D = Rmn2n '*' Vtotal                                            ;
 MN2MD = Rhomn2t                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'TCO'                                                      ;
 MCO0D = Rmcon '*' Vtotal                                            ;
 MCOMD = Rhomcot                                                     ;
 'FINSI'                                                             ;
 'SI' TBT.'TCO2'                                                     ;
 MCO20D = Rmco2n '*' Vtotal                                          ;
 MCO2MD = Rhomco2t                                                   ;
 'FINSI'                                                             ;
 'SI' TBT.'TAIR'                                                     ;
 MAIR0D = Rmairn '*' Vtotal                                          ;
 MAIRMD = Rhomairt                                                   ;
 'FINSI'                                                             ;

*---- Bilan energie
 E0D = Remn                                                          ;
 EMD = Remnt                                                         ;
  'MESS' ' Masse   (Kg)  ' M0D '_______' MMD '________'
       (100. '*' (M0D '-' MMD) '/' M0D)                              ;
  'MESS' ' Energie (J/m3)' E0D '_______' EMD '________'
       (100. '*' (E0D '-' EMD) '/' E0D)                              ;

 'SI' (TBT.'VAPEUR' 'ET' ('NON' ('EGA' MV0D 0.0)))                   ;
  'MESS' ' M Vapeur(Kg)  ' MV0D '_______' MVMD '_______'
       (100. '*' (MV0D '-' MVMD) '/' MV0D)                           ;
 'FINSI'                                                             ;
 'SI' (TBT.'THE' 'ET' ('NON' ('EGA' MHE0D 0.0)))                     ;
  'MESS' ' M Helium (Kg)  ' MHE0D '_______' MHEMD '_______'
       (100. '*' (MHE0D '-' MHEMD) '/' MHE0D)                        ;
 'FINSI'                                                             ;
 'SI' (TBT.'TH2' 'ET' ('NON' ('EGA' MH20D 0.0)))                     ;
  'MESS' ' M Hydrogene (Kg)  ' MH20D '_______' MH2MD '_______'
       (100. '*' (MH20D '-' MH2MD) '/' MH20D)                        ;
 'FINSI'                                                             ;
 'SI' (TBT.'TO2' 'ET' ('NON' ('EGA' MO20D 0.0)))                     ;
  'MESS' ' M Oxygene (Kg)  ' MO20D '_______' MO2MD '_______'
       (100. '*' (MO20D '-' MO2MD) '/' MO20D)                        ;
 'FINSI'                                                             ;
 'SI' (TBT.'TN2' 'ET' ('NON' ('EGA' MN20D 0.0)))                     ;
  'MESS' ' M Azote (Kg)  ' MN20D '_______' MN2MD '_______'
       (100. '*' (MN20D '-' MN2MD) '/' MN20D)                        ;
 'FINSI'                                                             ;
 'SI' (TBT.'TCO' 'ET' ('NON' ('EGA' MCO0D 0.0)))                     ;
  'MESS' ' M CO (Kg)  ' MCO0D '_______' MCOMD '_______'
       (100. '*' (MCO0D '-' MCOMD) '/' MCO0D)                        ;
 'FINSI'                                                             ;
 'SI' (TBT.'TCO2' 'ET' ('NON' ('EGA' MCO20D 0.0)))                   ;
  'MESS' ' M CO2 (Kg)  ' MCO20D '_______' MCO2MD '_______'
       (100. '*' (MCO20D '-' MCO2MD) '/' MCO20D)                     ;
 'FINSI'                                                             ;
 'SI' (TBT.'TAIR' 'ET' ('NON' ('EGA' MAIR0D 0.0)))                   ;
  'MESS' ' M AIR (Kg)  ' MAIR0D '_______' MAIRMD '_______'
       (100. '*' (MAIR0D '-' MAIRMD) '/' MAIR0D)                     ;
 'FINSI'                                                             ;
 'MESS' '___________________________________________________________';
 'SI' TBT.'THERMP'                                                   ;
 'MESS' ' Energie Stockée Mur (J) ' Emurn    Emurm
        (100. '*' (Emurn '-' Emurm) '/' Emurn)                       ;
 'MESS' '___________________________________________________________';
 'FINSI'                                                             ;
 'MESS' ' *** Volumes'                                               ;
 'MESS' ' VTotal=' VTotal ' m3'                                      ;
 Si (TBT.'Tbreche');
 'MESS' ' Facteur Geometrique BRECHE (>1) =' GEO.'facgeo'            ;
 Finsi ;
 Si (TBT.'Tbreche2');
 'MESS' ' Facteur Geometrique BRECHE2 (>1) =' GEO.'facgeo2'          ;
 Finsi ;
 Si (TBT.'Tbreche3');
 'MESS' ' Facteur Geometrique BRECHE3 (>1) =' GEO.'facgeo3'          ;
 Finsi ;
 'SI' TBT.'THERMP'                                                   ;
  Sparoif = GEO.'Sparoif'                                            ;
 'MESS' ' VTotal paroi =' GEO.'VTotalp' ' m3' ' Sparoif=' Sparoif ' m2';
 'FINSI'                                                             ;
 'SI' TBT.'TTIMP'                                                    ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 10' ;
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
 'MESS' ' Surface T imposée '(itimp.&BBTIMP)'  =' Btimp.'Smtpi' ' m2';
  FIN BBTIMP                                             ;
 'FINSI'                                                             ;
 'SI' TBT.'TTIMP1'                                                   ;
 'MESS' ' Surface T imposée (TIMP1)  =' GEO.'Smtp1' ' m2'            ;
 'FINSI'                                                             ;
 'SI' TBT.'TTIMP2'                                                   ;
 'MESS' ' Surface T imposée (TIMP2)  =' GEO.'Smtp2' ' m2'            ;
 'FINSI'                                                             ;
 'SI' TBT.'TTIMP3'                                                   ;
 'MESS' ' Surface T imposée (TIMP3)  =' GEO.'Smtp3' ' m2'            ;
 'FINSI'                                                             ;
'SI' (TBT.'Tbreche')                                                 ;
 'MESS' ' Sbreche=' Sbreche ' m2'                                    ;
'FINSI'                                                              ;
 'MESS' ' **********************************************************';

'FINSI'                                                  ;

*************************************************************


*-----------------------------------------------------------------

 tic.'UNM'   = un                                            ;
 tic.'RHONM' = Rho                                           ;
*---- Modèle K-Epsilon EFM1 --------------------------------
'SI'((EGA TBT.'MODTURB' 'KEPSILON') et (EGA TBT.'FEF' 'EFM1'));
 tic.'KNM'   = tic.'KN'                                      ;
 tic.'ENM'   = tic.'EN'                                      ;
'FINSI'                                                      ;
*---- Modèle K-Epsilon EFM1 -- FIN -------------------------
 'SI' TBT.'VAPEUR'                                           ;
 tic.'RVPNM' = Rvp                                           ;
 'FINSI'                                                     ;
 'SI' TBT.'THE'                                              ;
 tic.'RHEM'  = Rhe                                           ;
 'FINSI'                                                     ;
 'SI' TBT.'TH2'                                              ;
 tic.'RH2M'  = Rh2                                           ;
 'FINSI'                                                     ;
 'SI' TBT.'TO2'                                              ;
 tic.'RO2M'  = Ro2                                           ;
 'FINSI'                                                     ;
 'SI' TBT.'TN2'                                              ;
 tic.'RN2M'  = Rn2                                           ;
 'FINSI'                                                     ;
 'SI' TBT.'TCO2'                                             ;
 tic.'RCO2M'  = Rco2                                         ;
 'FINSI'                                                     ;
 'SI' TBT.'TAIR'                                             ;
 tic.'RAIRM'  = Rair                                         ;
 'FINSI'                                                     ;
 'SI' TBT.'TCO'                                              ;
 tic.'RCOM'  = Rco                                           ;
 'FINSI'                                                     ;
 tic.'TFNM'  = Tf                                            ;
 'SI' TBT.'THERMP'                                           ;
 tic.'TPNM'  = Tp                                            ;
 'FINSI'                                                     ;
'SI' TBT.'ASPER '                                            ;
   tic.'VNM' = tic.'VN'                                      ;
   tic.'XDM' = tic.'XD'                                      ;
   tic.'TDM' = tic.'TD'                                      ;
   tic.'DDM' = tic.'DD'                                      ;
'FINSI'                                                      ;
*-----------------------------------------------------------


   'SI' (EGA TBT.'FEF' 'EFM1')                               ;
     DTDIFU=rv.'PASDETPS'.'DTDIFU'                           ;
     DTCONV=rv.'PASDETPS'.'DTCONV'                           ;
     DTEXPL= (MINI (PROG DTDIFU DTCONV)) * 0.5               ;
*    mess 'DTEXPL='  DTEXPL ;
     DTM1 = tic.'DT'                                         ;

     ect=(DTEXPL - tic.'DT') / DTEXPL                        ;
     Si (ect > 0.1 )                                         ;
     tic.'DT' = (0.3 * DTEXPL) + (0.7 * tic.'DT')            ;
     Finsi                                                   ;

     Si (ect < 0.1 )                                         ;
     tic.'DT' = DTEXPL                                       ;
     Finsi                                                   ;

     Si(rxt.'DT0' < DTEXPL)                                  ;
     tic.'DT' = rxt.'DT0'                                    ;
     Finsi                                                   ;

     rv.'PASDETPS'.'NUPASDT' = tic.'NUPADT'                  ;
     rv.'PASDETPS'.'DELTAT-1'= DTM1                          ;
     rv.'PASDETPS'.'DELTAT'  = 1.e30                         ;
     rv.'PASDETPS'.'TPS'     = tic.'Tps'                     ;

   'FINSI'                                                   ;
   'SI' (TBT.'CATHARE2')                                     ;
   cc=chai 'echo' PT ' ' Tfm ' ' rhomn '  > ' 'CASCAR'       ;
   titi =  'EXTE' cc 'RC'                                    ;
   'FINSI'                                                   ;
*   Mess ' Fin BclTPS tic.DT=' tic.'DT'                      ;
'FIN' BCLTPS                                                           ;
*>10'FIN' BCLTPS

'SI' ('ET' (TBT.'DETMAT') ('>' nbit 0))                                ;

  matvide = 0                                                          ;

  rvm = TBT.'RV'.'METHINV'                                             ;
  rvm.'TABRES' = matvide                                               ;
  rvm.'MATASS' = matvide                                               ;
  rvm.'MAPREC' = matvide                                               ;
  rvm = 'ENLE' rvm 'TABRES'                                            ;
  rvm = 'ENLE' rvm 'MATASS'                                            ;
  rvm = 'ENLE' rvm 'MAPREC'                                            ;
  TBT.'RV'.'METHINV' = rvm                                             ;

  'SI' ('EXIS' TBT.'RV' 'PROJ')                                        ;
    rvprm = TBT.'RV'.'PROJ'.'METHINV'                                  ;
    rvprm.'TABRES' = matvide                                           ;
    rvprm.'MATASS' = matvide                                           ;
    rvprm.'MAPREC' = matvide                                           ;
    rvprm = 'ENLE' rvprm 'TABRES'                                      ;
    rvprm = 'ENLE' rvprm 'MATASS'                                      ;
    rvprm = 'ENLE' rvprm 'MAPREC'                                      ;
    TBT.'RV'.'PROJ'.'METHINV' = rvprm                                  ;
    rvpr = TBT.'RV'.'PROJ'                                             ;
    rvpr.'MATP' = matvide                                              ;
    rvpr.'MATC' = matvide                                              ;
    rvpr = 'ENLE' rvpr 'MATP'                                          ;
    rvpr = 'ENLE' rvpr 'MATC'                                          ;
    TBT.'RV'.'PROJ' = rvpr                                             ;
    rv = TBT.'RV'                                                      ;
    rv = 'ENLE' rv 'rvpd'                                              ;
    TBT.'RV' = rv                                                      ;
  'FINSI'                                                              ;

Si (TBT.'TRTF')                                                        ;
  rtfm = rv.'METHINV'                                                  ;
Finsi                                                                  ;
  rtfm = TBT.'RTF'.'METHINV'                                           ;
  rtfm.'TABRES' = matvide                                              ;
  rtfm.'MATASS' = matvide                                              ;
  rtfm.'MAPREC' = matvide                                              ;
  rtfm = 'ENLE' rtfm 'TABRES'                                          ;
  rtfm = 'ENLE' rtfm 'MATASS'                                          ;
  rtfm = 'ENLE' rtfm 'MAPREC'                                          ;
  TBT.'RTF'.'METHINV' = rtfm                                           ;

  'SI'((TBT.'THERMP') ou (TBT.'TPAROIS'))                              ;
    rtpm = TBT.'RTP'.'METHINV'                                         ;
    rtpm.'TABRES' = matvide                                            ;
    rtpm.'MATASS' = matvide                                            ;
    rtpm.'MAPREC' = matvide                                            ;
    rtpm = 'ENLE' rtpm 'TABRES'                                        ;
    rtpm = 'ENLE' rtpm 'MATASS'                                        ;
    rtpm = 'ENLE' rtpm 'MAPREC'                                        ;
    TBT.'RTP'.'METHINV' = rtpm                                         ;
  'FINSI'                                                              ;

  'SI' TBT.'VAPEUR'                                                    ;
    Rrvapm = TBT.'Rrvap'.'METHINV'                                     ;
    Rrvapm.'TABRES' = matvide                                          ;
    Rrvapm.'MATASS' = matvide                                          ;
    Rrvapm.'MAPREC' = matvide                                          ;
    Rrvapm = 'ENLE' Rrvapm 'TABRES'                                    ;
    Rrvapm = 'ENLE' Rrvapm 'MATASS'                                    ;
    Rrvapm = 'ENLE' Rrvapm 'MAPREC'                                    ;
    TBT.'Rrvap'.'METHINV' = Rrvapm                                     ;
  'FINSI'                                                              ;

  'SI' TBT.'THE' ;
    Rrhem = TBT.'Rrhe'.'METHINV'                                       ;
    Rrhem.'TABRES' = matvide                                           ;
    Rrhem.'MATASS' = matvide                                           ;
    Rrhem.'MAPREC' = matvide                                           ;
    Rrhem = 'ENLE' Rrhem 'TABRES'                                      ;
    Rrhem = 'ENLE' Rrhem 'MATASS'                                      ;
    Rrhem = 'ENLE' Rrhem 'MAPREC'                                      ;
    TBT.'Rrhe'.'METHINV' = Rrhem                                       ;
  'FINSI' ;

  'SI' TBT.'TH2'                                                       ;
    Rrh2m = TBT.'Rrh2'.'METHINV'                                       ;
    Rrh2m.'TABRES' = matvide                                           ;
    Rrh2m.'MATASS' = matvide                                           ;
    Rrh2m.'MAPREC' = matvide                                           ;
    Rrh2m = 'ENLE' Rrh2m 'TABRES'                                      ;
    Rrh2m = 'ENLE' Rrh2m 'MATASS'                                      ;
    Rrh2m = 'ENLE' Rrh2m 'MAPREC'                                      ;
    TBT.'Rrh2'.'METHINV' = Rrh2m                                       ;
  'FINSI'                                                              ;

  'SI' TBT.'TO2'                                                       ;
    Rro2m = TBT.'Rro2'.'METHINV'                                       ;
    Rro2m.'TABRES' = matvide                                           ;
    Rro2m.'MATASS' = matvide                                           ;
    Rro2m.'MAPREC' = matvide                                           ;
    Rro2m = 'ENLE' Rro2m 'TABRES'                                      ;
    Rro2m = 'ENLE' Rro2m 'MATASS'                                      ;
    Rro2m = 'ENLE' Rro2m 'MAPREC'                                      ;
    TBT.'Rro2'.'METHINV' = Rro2m                                       ;
  'FINSI'                                                              ;

  'SI' TBT.'TN2'                                                       ;
    Rrn2m = TBT.'Rrn2'.'METHINV'                                       ;
    Rrn2m.'TABRES' = matvide                                           ;
    Rrn2m.'MATASS' = matvide                                           ;
    Rrn2m.'MAPREC' = matvide                                           ;
    Rrn2m = 'ENLE' Rrn2m 'TABRES'                                      ;
    Rrn2m = 'ENLE' Rrn2m 'MATASS'                                      ;
    Rrn2m = 'ENLE' Rrn2m 'MAPREC'                                      ;
    TBT.'Rrn2'.'METHINV'  = Rrn2m                                      ;
  'FINSI'                                                              ;

  'SI' TBT.'TCO2'                                                      ;
    Rrco2m = TBT.'Rrco2'.'METHINV'                                     ;
    Rrco2m.'TABRES' = matvide                                          ;
    Rrco2m.'MATASS' = matvide                                          ;
    Rrco2m.'MAPREC' = matvide                                          ;
    Rrco2m = 'ENLE' Rrco2m 'TABRES'                                    ;
    Rrco2m = 'ENLE' Rrco2m 'MATASS'                                    ;
    Rrco2m = 'ENLE' Rrco2m 'MAPREC'                                    ;
    TBT.'Rrco2'.'METHINV' = Rrco2m                                     ;
  'FINSI'                                                              ;

  'SI' TBT.'TAIR'                                                      ;
    Rrairm = TBT.'Rrair'.'METHINV'                                     ;
    Rrairm.'TABRES' = matvide                                          ;
    Rrairm.'MATASS' = matvide                                          ;
    Rrairm.'MAPREC' = matvide                                          ;
    Rrairm = 'ENLE' Rrairm 'TABRES'                                    ;
    Rrairm = 'ENLE' Rrairm 'MATASS'                                    ;
    Rrairm = 'ENLE' Rrairm 'MAPREC'                                    ;
    TBT.'Rrair'.'METHINV' = Rrairm                                     ;
  'FINSI'                                                              ;

  'SI' TBT.'TCO'                                                       ;
    Rrcom = TBT.'Rrco'.'METHINV'                                       ;
    Rrcom.'TABRES'= matvide                                            ;
    Rrcom.'MATASS'= matvide                                            ;
    Rrcom.'MAPREC'= matvide                                            ;
    Rrcom = 'ENLE' Rrcom 'TABRES'                                      ;
    Rrcom = 'ENLE' Rrcom 'MATASS'                                      ;
    Rrcom = 'ENLE' Rrcom 'MAPREC'                                      ;
    TBT.'Rrco'.'METHINV' = Rrcom                                       ;
  'FINSI'                                                              ;

  'SI' TBT.'ASPER'                                                     ;
    rvnm = TBT.'RVN'.'METHINV'                                         ;
    rvnm.'TABRES'= matvide                                             ;
    rvnm.'MATASS'= matvide                                             ;
    rvnm.'MAPREC'= matvide                                             ;
    rvnm = 'ENLE' rvnm 'TABRES'                                        ;
    rvnm = 'ENLE' rvnm 'MATASS'                                        ;
    rvnm = 'ENLE' rvnm 'MAPREC'                                        ;
    TBT.'RVN'.'METHINV' = rvnm                                         ;
    rxdm = TBT.'RXD'.'METHINV'                                         ;
    rxdm.'TABRES'= matvide                                             ;
    rxdm.'MATASS'= matvide                                             ;
    rxdm.'MAPREC'= matvide                                             ;
    rxdm = 'ENLE' rxdm 'TABRES'                                        ;
    rxdm = 'ENLE' rxdm 'MATASS'                                        ;
    rxdm = 'ENLE' rxdm 'MAPREC'                                        ;
    TBT.'RXD'.'METHINV' = rxdm                                         ;
    rddm = TBT.'RDD'.'METHINV'                                         ;
    rddm.'TABRES'= matvide                                             ;
    rddm.'MATASS'= matvide                                             ;
    rddm.'MAPREC'= matvide                                             ;
    rddm = 'ENLE' rddm 'TABRES'                                        ;
    rddm = 'ENLE' rddm 'MATASS'                                        ;
    rddm = 'ENLE' rddm 'MAPREC'                                        ;
    TBT.'RDD'.'METHINV' = rddm                                         ;
    rtdm = TBT.'RTD'.'METHINV'                                         ;
    rtdm.'TABRES'= matvide                                             ;
    rtdm.'MATASS'= matvide                                             ;
    rtdm.'MAPREC'= matvide                                             ;
    rtdm = 'ENLE' rtdm 'TABRES'                                        ;
    rtdm = 'ENLE' rtdm 'MATASS'                                        ;
    rtdm = 'ENLE' rtdm 'MAPREC'                                        ;
    TBT.'RTD'.'METHINV' = rtdm                                         ;
  'FINSI'                                                              ;

'FINSI'                                                                ;

*-----------------------------------------------------------
*----- FIN de la boucle principale sur les pas de temps ----
*-----------------------------------------------------------

*==============================================================
Si TBT.'GRAPH'                                                    ;
*******************************************************************
******** Post Graphique de controle
*******************************************************************

 tic  = rxt.'TIC'                                                 ;
 $vtf = GEO.'$vtf'                                                ;
 Si (Exist tic 'LTPSC')                                           ;
  ltpsc= tic.'LTPSC'                                              ;
  ltps = extr (tic.'LTPS') (tic.'LTPSC')                          ;
 Sinon                                                            ;
  ltps = tic.'LTPS'                                               ;
  ltpsc= lect 1 pas 1 (dime ltps)                                 ;
 Finsi                                                            ;

 tab1 = table ;
 tab1.1 = 'MARQ CROI REGU' ;
 tab1.2 = 'MARQ TRIA REGU' ;
 tab1.3 = 'MARQ LOSA REGU' ;
 tab1.'TITRE' = table ;

 mvtf= 'DOMA' $vtf maillage                          ;

 un = tic.'UN' ;
 lcu=extr un 'COMP'                                  ;
 modu= (un lcu 'PSCA' un lcu) ** 0.5 ; mmu= 'MAXI' modu ;
 'MESS' ' MAXI module de U ********* ' mmu ;

**************************************************************
* Débit injection / Débit condensation

 evsrcv=EVOL VERT  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qj' ltpsc);

 evqc  = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc' ltpsc);


 tab1.'TITRE'. 1 = 'MOT' 'Q_cond Kg/s' ;
 tab1.'TITRE'. 2 = 'MOT' 'Q_inj Kg/s' ;

 evsrcv=evsrcv et (EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr (tic.'Qj2') ltpsc)) ;
 tab1.'TITRE'. 3 = 'MOT' 'Q_inj2 Kg/s' ;

 evsrcv=evsrcv et (EVOL TURQ  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr (tic.'Qj3') ltpsc)) ;
 tab1.'TITRE'. 4 = 'MOT' 'Q_inj3 Kg/s' ;

 evtq=evqc et evsrcv;

 Si TBT.'ASPER ' ;
* ASPER dessin
 lqQas = tic.'Qaspe' ;
 evQas = EVOL JAUNE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr lqQas ltpsc) ;
 tab1.'TITRE'. 5 = 'MOT' 'Q_aspe Kg/s' ;
 evtq=evtq et evqas ;
 dess evtq
LEGE TAB1 DATE MIMA TITR ' Débit injection/condensé/aspersion' ;
 Sinon ;
 dess evtq
LEGE TAB1 DATE MIMA TITR ' Débit injection/condensé' ;
 Finsi ;

**************************************************************
**************************************************************
* Taux d'injection de la vapeur
'SI' (TBT.'VAPEUR')                                          ;


*.............................................................
 Si ('EGA'(dime tic.'Tinj') (dime ltpsc));
 evtinj =EVOL VERT  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Tinj' ltpsc);

 Si ('EGA'(dime tic.'Tinj2') (dime ltpsc));
 evtinj=evtinj et (EVOL BLEU  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Tinj2' ltpsc));
 Finsi ;

 Si ('EGA'(dime tic.'Tinj3') (dime ltpsc));
 evtinj=evtinj et (EVOL BLEU  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Tinj3' ltpsc));
 Finsi ;

 tab1.'TITRE'. 1 = 'MOT' 'Tinj ' ;
 tab1.'TITRE'. 2 = 'MOT' 'Tinj2' ;
 tab1.'TITRE'. 3 = 'MOT' 'Tinj3' ;

 dess evtinj
LEGE TAB1 DATE MIMA TITR ' Température d injection aux brèches' ;
 Finsi                                                       ;

*.............................................................

*.............................................................
 Si ('EGA'(dime tic.'Ksi') (dime ltpsc));
 evksi =EVOL VERT  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Ksi' ltpsc);

 Si ('EGA'(dime tic.'Ksi2') (dime ltpsc));
 evksi=evksi et (EVOL BLEU  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Ksi2' ltpsc));
 Finsi ;

 Si ('EGA'(dime tic.'Ksi3') (dime ltpsc));
 evksi=evksi et (EVOL BLEU  'MANU' 'Temps en sec' ltps '%'
 (extr tic.'Ksi3' ltpsc));
 Finsi ;

 tab1.'TITRE'. 1 = 'MOT' 'Ksi ' ;
 tab1.'TITRE'. 2 = 'MOT' 'Ksi2' ;
 tab1.'TITRE'. 3 = 'MOT' 'Ksi3' ;

 dess evksi
LEGE TAB1 DATE MIMA TITR ' Taux d injection de la vapeur aux brèches' ;
 Finsi                                                       ;

*.............................................................

* Trace des Debits liquide vapeur et total aux breches

 tab1.1 = 'MARQ CROI REGU' ;
 tab1.2 = 'MARQ CROI REGU TIRM' ;
 tab1.3 = 'MARQ CROI REGU TIRC' ;
 tab1.4 = 'MARQ TRIA REGU' ;
 tab1.5 = 'MARQ TRIA REGU TIRM' ;
 tab1.6 = 'MARQ TRIA REGU TIRC' ;
 tab1.7 = 'MARQ LOSA REGU' ;
 tab1.8 = 'MARQ LOSA REGU TIRM' ;
 tab1.9 = 'MARQ LOSA REGU TIRC' ;

 Si ('EGA'(dime tic.'Qlj') (dime ltpsc));
 evql =EVOL VERT  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qlj' ltpsc);
 Sinon                                                       ;
 evql=(EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/s'
 (prog (dime ltpsc)*0.));
 Finsi                                                       ;
 qt= (extr evql 'ORDO');
 qt= qt + (extr tic.'Qj' ltpsc);
 evqlj=(EVOL VERT  'MANU' 'Temps en sec' ltps 'Kg/s' qt);
 evqlj=evqlj et evql;
 evqlj=evqlj et (EVOL VERT  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qj' ltpsc));

 tab1.'TITRE'. 1 = 'MOT' 'Qjtot' ;
 tab1.'TITRE'. 2 = 'MOT' 'Qlj ' ;
 tab1.'TITRE'. 3 = 'MOT' 'Qj ';

 Si ('EGA'(dime tic.'Qlj2') (dime ltpsc));
 evql=(EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qlj2' ltpsc));
 Sinon ;
 evql=(EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (prog (dime ltpsc)*0.));
 Finsi ;
 qt= (extr evql 'ORDO');
 qt= qt + (extr tic.'Qj2' ltpsc);
 evqlj=evqlj et (EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s' qt);
 evqlj=evqlj et evql ;
 evqlj=evqlj et (EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qj2' ltpsc));
 tab1.'TITRE'. 4 = 'MOT' 'Qj2tot';
 tab1.'TITRE'. 5 = 'MOT' 'Qlj2';
 tab1.'TITRE'. 6 = 'MOT' 'Qj2';

 Si ('EGA'(dime tic.'Qlj3') (dime ltpsc));
 evql=(EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qlj3' ltpsc));
 Sinon ;
 evql=(EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (prog (dime ltpsc)*0.));
 Finsi ;
 qt= (extr evql 'ORDO');
 qt= qt + (extr tic.'Qj3' ltpsc);
 evqlj=evqlj et (EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s' qt);
 evqlj=evqlj et evql ;
 evqlj=evqlj et (EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qj3' ltpsc));
 tab1.'TITRE'. 7 = 'MOT' 'Qj3tot' ;
 tab1.'TITRE'. 8 = 'MOT' 'Qlj3' ;
 tab1.'TITRE'. 9 = 'MOT' 'Qj3'  ;

 dess evqlj
LEGE TAB1 DATE MIMA
 TITR ' Debits injection liquide/vapeur aux brèches' ;

 tab1.1 = 'MARQ CROI REGU' ;
 tab1.2 = 'MARQ TRIA REGU' ;
 tab1.3 = 'MARQ LOSA REGU' ;

*.............................................................

'FINSI'                                                      ;
**************************************************************
**************************************************************
* Débits condensations Total et détails
Si (TBT.'VAPEUR');

 tab2 = table ;
 tab2.1 = 'MARQ CROI REGU' ;
 tab2.2 = 'MARQ TRIA REGU' ;
 tab2.3 = 'MARQ LOSA REGU' ;
 tab2.4 = 'MARQ CARR REGU' ;
 tab2.5 = 'MARQ TRIB REGU' ;
 tab2.'TITRE' = table ;

 evsrcv=EVOL VERT  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc' ltpsc);
 evtq = evsrcv ;
 tab2.'TITRE'. 1 = 'MOT' 'Q_cond Kg/s' ;

 Numero = 1 ;
 Si('EXIST' tic 'Qc1') ;
 Numero = Numero + 1 ;
 evqc1 = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc1' ltpsc);
 evtq=evtq et evqc1 ;
 tab2.'TITRE'. Numero = 'MOT' 'Qc1 Kg/s' ;
 Finsi ;

 Si('EXIST' tic 'Qc2') ;
 Numero = Numero + 1 ;
 evqc2 = EVOL JAUNE 'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc2' ltpsc);
 evtq=evtq et evqc2 ;
 tab2.'TITRE'. Numero = 'MOT' 'Qc2 Kg/s' ;
 Finsi ;

 Si('EXIST' tic 'Qc3') ;
 Numero = Numero + 1 ;
 evqc3 = EVOL ROSE  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc3' ltpsc);
 evtq=evtq et evqc3 ;
 tab2.'TITRE'. Numero = 'MOT' 'Qc3 Kg/s' ;
 Finsi ;

 Si('EXIST' tic 'Qcw') ;
 Numero = Numero + 1 ;
 evqcw = EVOL TURQ  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qcw' ltpsc);
 evtq=evtq et evqcw ;
 tab2.'TITRE'. Numero = 'MOT' 'Qcw Kg/s' ;
 Finsi ;

 Si('EXIST' tic 'Qc0') ;
 Numero = Numero + 1 ;
 evqc0 = EVOL TURQ  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qc0' ltpsc);
 evtq=evtq et evqc0 ;
 tab2.'TITRE'. Numero = 'MOT' 'Qc0 Kg/s' ;
 Finsi ;

 Si('EXIST' tic 'Qcm') ;
 Numero = Numero + 1 ;
 evqcm = EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.'Qcm' ltpsc);
 evtq=evtq et evqcm ;
 tab2.'TITRE'. Numero = 'MOT' 'Qcm Kg/s' ;
 Finsi ;

 dess evtq

LEGE TAB2 DATE MIMA TITR ' Débits condensés détails' ;
Finsi                                                ;

* Cas des Températures imposées nouvelle méthode
Si ('EXIST' rxt 'TIMP');
nti = dime (rxt.'TIMP');

 Numero = 1;
 evtq = evsrcv ;
 tab2.'TITRE'. 1 = 'MOT' 'Q_cond Kg/s' ;

Repeter BNTI nti;
 Numero = Numero + 1 ;
 nqi=chai 'Qc1' &BNTI;
 evqci = EVOL BLEU  'MANU' 'Temps en sec' ltps 'Kg/s'
 (extr tic.nqi ltpsc);
 evtq=evtq et evqci ;
 tab2.'TITRE'. Numero = 'MOT' (chai nqi ' Kg/s') ;
FIN BNTI;

 dess evtq
LEGE TAB2 DATE MIMA TITR ' Débits condensés détails' ;

Finsi;
**************************************************************

*******************************************************************

 evsrhv=EVOL VERT    'MANU' 'Temps en sec' ltps 'Htot'
 (extr tic.'Hj' ltpsc);
 lqe   = tic.'Remn' ;
 evqe  = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Hj-Em '
 (extr lqe ltpsc) ;
 tab1.'TITRE'. 2 = 'MOT' 'Hj  J/Kg' ;
 tab1.'TITRE'. 1 = 'MOT' 'Em  J/kg' ;
 Si('EXIST' tic 'Hj2') ;
 evsrhv= evsrhv et (EVOL BLEU 'MANU' 'Temps en sec' ltps 'HVap'
 (extr (tic.'Hj2') ltpsc) ) ;
 tab1.'TITRE'. 3 = 'MOT' 'Hj2 J/kg' ;
 Finsi ;
 Si('EXIST' tic 'Hj3') ;
 evsrhv= evsrhv et (EVOL TURQ 'MANU' 'Temps en sec' ltps 'HVap'
 (extr (tic.'Hj3') ltpsc) ) ;
 tab1.'TITRE'. 4 = 'MOT' 'Hj3 J/kg' ;
 Finsi ;

 dess (evqe et evsrhv)
 LEGE TAB1 DATE MIMA TITR
 ' Enthalpie(s) à la (aux) brèche(s) / énergie moyenne' ;
*******************************************************************


 lqEcd = tic.'Econd' ;
 evEcd = EVOL VERT 'MANU' 'Temps en sec' ltps 'Ecd' (extr lqEcd ltpsc);

 lqEcv = tic.'Econv' ;
 evEcv = EVOL BLEU 'MANU' 'Temps en sec' ltps 'Ecv' (extr lqEcv ltpsc);


 'SI' TBT.'VAPEUR'                                       ;
 tab1.'TITRE'. 1 = 'MOT' 'Ecv Joule' ;
   dess  evEcd
 LEGE TAB1 DATE MIMA TITR ' Energie de condensation ' ;
   dess  evEcv
 LEGE TAB1 DATE MIMA TITR ' Energie echange convectif';
 'FINSI'      ;

 lqMinj = extr tic.'Minj' ltpsc ;
 evMinjv = EVOL BLEU 'MANU' 'Temps en sec' ltps 'Minj-Mcond' lqMinj ;
 lqMcond = extr tic.'Mcond' ltpsc ;
 evMcond = EVOL VERT 'MANU' 'Temps en sec' ltps 'Minj-Mcond' lqMcond ;
 lqMrest = extr tic.'Mrest' ltpsc ;
 evMrest = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Minj-Mcond' lqMrest ;
 Si (EGA (dime tic.'Mliqpuis') (dime ltpsc));
 lqMpuis = extr tic.'Mliqpuis' ltpsc ;
 Sinon;
 lqMpuis=prog (dime ltpsc)*0.;
 Finsi;
 evMpuis = EVOL JAUNE 'MANU' 'Temps en sec' ltps 'Minj-Mcond' lqMpuis ;

********************************************************************
 tab1.'TITRE'. 1 = 'MOT' 'M_inj Kg'  ;
 tab1.'TITRE'. 2 = 'MOT' 'M_cond Kg' ;
 tab1.'TITRE'. 3 = 'MOT' 'M_rest Kg' ;
 tab1.'TITRE'. 4 = 'MOT' 'M_puis Kg' ;
 dess (evMinjv et evMcond et evMrest et evMpuis)
LEGE TAB1 DATE MIMA
 TITR ' Masses injectées/ condensées/ restantes/ Puisard' ;
********************************************************************

Si ( 'EXIST' tic 'guj' ) ;
*******************************************************************
* Vitesse max / Vitesse injection brèche 1
 evmaxu= EVOL VERT 'MANU' 'Temps en sec' ltps 'M / s '
 (extr tic.'LMAXU' ltpsc);
 evgj  = EVOL ROSE 'MANU' 'Temps en sec' ltps 'M / s '
 (extr tic.'guj' ltpsc) ;
 tab1.'TITRE'. 1 = 'MOT' 'Max u m/s' ;
 tab1.'TITRE'. 2 = 'MOT' 'U inj m/s' ;
 dess (evmaxu et evgj)
 LEGE TAB1 DATE MIMA TITR ' Vitesse max / Vitesse inject brèche 1 ' ;
*******************************************************************
Finsi ;

Si ( 'EXIST' tic 'guj2' ) ;
*******************************************************************
* Vitesse max / Vitesse injection brèche 2
 evgj2 = EVOL ROSE 'MANU' 'Temps en sec' ltps 'M / s '
 (extr tic.'guj2' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Max u m/s' ;
 tab1.'TITRE'. 2 = 'MOT' 'U inj m/s' ;
 dess (evmaxu et evgj2)
 LEGE TAB1 DATE MIMA TITR ' Vitesse max / Vitesse inject brèche 2 ' ;
*******************************************************************
Finsi ;

Si ( 'EXIST' tic 'guj3' ) ;
*******************************************************************
* Vitesse max / Vitesse injection brèche 3
 evgj3 = EVOL ROSE 'MANU' 'Temps en sec' ltps 'M / s '
 (extr tic.'guj3' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Max u m/s' ;
 tab1.'TITRE'. 2 = 'MOT' 'U inj m/s' ;
 dess (evmaxu et evgj3)
 LEGE TAB1 DATE MIMA TITR ' Vitesse max / Vitesse inject brèche 3 ' ;
*******************************************************************
Finsi ;

*******************************************************************
* Densités
 evrhom= EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomn' ltpsc) ;
 tab1.'TITRE'. 1 = 'MOT' 'Rhom Kg/m3' ;
 evdens = evrhom ;

 ID = 1 ;
 'SI' TBT.'VAPEUR'                                       ;
 ID = ID + 1 ;
 evrhomv= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomv' ltpsc) ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_vap Kg/m3' ;
 evdens = evdens et evrhomv ;
 evrhomvg= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomvg' ltpsc) ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_vg Kg/m3' ;
 evdens = evdens et evrhomvg ;
 'FINSI' ;

 'SI' TBT.'THE';
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_He Kg/m3' ;
 evrhomhe=EVOL JAUNE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomhe' ltpsc) ;
 evdens = evdens et evrhomhe ;
 'FINSI' ;

 'SI' TBT.'TH2' ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_H2 Kg/m3' ;
 evrhomh2=EVOL BLEU 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomh2' ltpsc) ;
 evdens = evdens et evrhomh2 ;
 'FINSI' ;

 'SI' TBT.'TO2';
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_O2 Kg/m3' ;
 evrhomo2=EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomo2' ltpsc) ;
 evdens = evdens et evrhomo2 ;
 'FINSI' ;

 'SI' TBT.'TN2';
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_N2 Kg/m3' ;
 evrhomn2=EVOL ROSE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomn2' ltpsc);
 evdens = evdens et evrhomn2 ;
 'FINSI' ;

 'SI' TBT.'TCO' ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_CO Kg/m3' ;
 evrhomco=EVOL JAUN 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomco' ltpsc);
 evdens = evdens et evrhomco ;
 'FINSI' ;

 'SI' TBT.'TCO2' ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_CO2 Kg/m3' ;
 evrco2 =EVOL ROSE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomco2' ltpsc);
 evdens = evdens et evrco2 ;
 'FINSI' ;

 'SI' TBT.'TAIR' ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID = 'MOT' 'Rhom_AIR Kg/m3' ;
 evrair =EVOL JAUNE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomair' ltpsc);
 evdens = evdens et evrair ;
 'FINSI' ;

 dess evdens
 LEGE TAB1 DATE MIMA TITR ' Densités mélange / vapeur / incondensables';
*******************************************************************

*******************************************************************
* Densités et correction 0D
 evrhom= EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomn' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom Kg/m3' ;
 evrho  = evrhom ;

 evdrho  = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'drho' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'dRho Kg/m3' ;
 evrho  = evrho  et evdrho ;

 dess evrho
 LEGE TAB1 DATE MIMA TITR ' Densité mélange et correction ' ;

 'SI' TBT.'VAPEUR'                                       ;
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomv' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_VAP Kg/m3' ;
 evrhov = evrhomv;

 evrhomvg  = EVOL TURQ 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomvg' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Rhom_H2O Kg/m3' ;
 evrhov = evrhov  et evrhomvg;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrvap' ltpsc);
 tab1.'TITRE'. 3 = 'MOT' 'Maxi dRho_H2O Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité vapeur et correction ' ;
 'FINSI' ;

 'SI' TBT.'THE';
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomhe' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_He Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrhe' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_He Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Helium et correction ' ;
 'FINSI' ;

 'SI' TBT.'TH2' ;
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomh2' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_H2 Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrh2' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_H2 Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Hydrogène et correction ' ;
 'FINSI' ;

 'SI' TBT.'TO2';
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomo2' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_o2 Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdro2' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_o2 Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Oxygène et correction ' ;
 'FINSI' ;


 'SI' TBT.'TN2';
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomn2' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_N2 Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrn2' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_N2 Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Azote et correction ' ;
 'FINSI' ;

 'SI' TBT.'TCO';
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomco' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_Co Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrco' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_Co Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Co et correction ' ;
 'FINSI' ;

 'SI' TBT.'TCO2';
 evrhomv   = EVOL VERT 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Rhomco2' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Rhom_Co2 Kg/m3' ;
 evrhov = evrhomv;

 evdrhov1= EVOL ROUGE 'MANU' 'Temps en sec' ltps 'Kg/m3'
 (extr tic.'Mdrco2' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dRho_Co2 Kg/m3' ;
 evrhov  = evrhov  et evdrhov1 ;

 dess evrhov
 LEGE TAB1 DATE MIMA TITR ' Densité Co2 et correction ' ;
 'FINSI' ;

*******************************************************************

*******************************************************************
* Pression moyenne
 evPT=EVOL BLEU 'MANU' 'Temps en sec' ltps 'Pt'
 (extr tic.'PT' ltpsc) ;
 tab1.'TITRE'. 1 = 'MOT' 'Pmoy Pa' ;
 dess evPT
 LEGE TAB1 DATE MIMA TITR ' Pression moyenne ';
*******************************************************************

*******************************************************************
* Températures Fluides paroi etc
 evtpf = EVOL ROUGE 'MANU' 'Temps en sec' ltps 'oC '
 (extr tic.'Tfm' ltpsc);
 tab1.'TITRE'. 1 = 'MOT' 'Tfm oC' ;
 evtpf1= EVOL BLEU 'MANU' 'Temps en sec' ltps 'oC'
 (extr tic.'MdTf' ltpsc);
 tab1.'TITRE'. 2 = 'MOT' 'Maxi dTf oC' ;
 evtpf  = evtpf  et evtpf1 ;
 evtpf2= EVOL ROSE 'MANU' 'Temps en sec' ltps 'oC'
 (extr tic.'mdTf' ltpsc);
 tab1.'TITRE'. 3 = 'MOT' 'Mini dTf oC' ;
 evtpf  = evtpf  et evtpf2 ;

 ID = 3 ;
 'SI' TBT.'THERMP' ;
 ID = ID + 1 ;
 tab1.'TITRE'. ID= 'MOT' 'Tfp oC' ;
 evTfp = EVOL VERT  'MANU' 'Temps en sec' ltps 'oC '
 (extr tic.'Tpm' ltpsc);
 evtpf = evtpf et evTfp ;
 'FINSI' ;
  'SI' TBT.'TTIMP'  ;
   NBTIMP=dime (rxt.'TIMP')                              ;
   itimp=INDEX (rxt.'TIMP')                              ;
  REPETER BBTIMP NBTIMP                                  ;
* mess 'BBTIMP 11' ;
   Btimp=rxt.'TIMP'.(itimp.&BBTIMP)                      ;
  ID = ID + 1 ;
  uu=chai 'Tfpc' &BBTIMP ' oC';
  tab1.'TITRE'. ID= 'MOT' uu ;
* evTfpc1= EVOL TURQ  'MANU' 'Temps en sec' ltps 'oC '
* (extr Btimp.'Ltbpi' ltpsc);
* evtpf = evtpf et evTfpc1 ;
  FIN BBTIMP                                             ;
  'FINSI' ;
  'SI' TBT.'TTIMP1' ;
  ID = ID + 1 ;
  tab1.'TITRE'. ID= 'MOT' 'Tfpc1 oC' ;
  evTfpc1= EVOL TURQ  'MANU' 'Temps en sec' ltps 'oC '
  (extr tic.'Ltbp1' ltpsc);
  evtpf = evtpf et evTfpc1 ;
  'FINSI' ;
  'SI' TBT.'TTIMP2' ;
  ID = ID + 1 ;
  tab1.'TITRE'. ID= 'MOT' 'Tfpc2 oC' ;
  evTfpc2= EVOL TURQ  'MANU' 'Temps en sec' ltps 'oC '
  (extr tic.'Ltbp2' ltpsc);
  evtpf = evtpf et evTfpc2 ;
  'FINSI' ;
  'SI' TBT.'TTIMP3' ;
  ID = ID + 1 ;
  tab1.'TITRE'. ID= 'MOT' 'Tfpc3 oC' ;
  evTfpc3= EVOL TURQ  'MANU' 'Temps en sec' ltps 'oC '
  (extr tic.'Ltbp3' ltpsc);
  evtpf = evtpf et evTfpc3 ;
  'FINSI' ;
  dess evtpf
  LEGE TAB1 DATE MIMA TITR ' Températures moyennes Fluide / Parois';


Finsi                                                    ;
*==============================================================
'FINPROC' ;




















